$.component("coral.combogrid",$.coral.combo,{version:"4.0.3",castProperties:["colNames","colModel","data","buttonOptions","gridOptions","buttons"],options:{colNames:[],colModel:[],valueField:"id",textField:"name",panelRenderOnShow:false,multiple:false,selarrrow:[],buttons:[],url:null,panelWidth:500,panelHeight:220,sortable:false,data:[],onSelectRow:null,onSelectAll:null,onSortableColums:null,onLoad:$.noop,onComplete:null,pager:false,buttonOptions:null,gridOptions:{}},grid:function(){return $("#combo_grid_"+$(this.element).attr("id"))},button:function(){if(null!==this.options.buttonOptions){return this.$button}},_destroy:function(){this.element.removeClass("coral-validation-combogrid");this.element.removeClass("coral-form-element-combogrid");this.grid().grid("destroy");this._super()},_showItems:function(){var f=[],h=[],g=[],c=[];var b=this.options.textField,d=this.options.valueField,e={};var a=this.grid();e.filters="{}";a.grid("option","localonce",true);$.extend(a.grid("option","postData"),e);a.grid("reload",{page:1})},_doQuery:function(b){var a=this.options,h=this.grid();var c=a.textField;var g=h.grid("option","colModel"),e=[],l=[];for(var f in g){var k=g[f];if("cb"==k.name||"rn"==k.name){continue}}for(var d=0;d<b.length;d++){l.push('{"field":"'+c+'","op":"cn","data":"'+b[d]+'"}')}e.filters='{"groupOp":"OR","rules":['+l.join(",")+"]}";h.grid("option","localonce",true);$.extend(h.grid("option","postData"),e);h.grid("reload",{page:1})},_checkMathch:function(o,n){var e=[],m=[],f=[],k=[];var p=this.options.textField,a=this.options.valueField,t={},b=0,s,r;var g=this.grid();if(n){this._showItems()}var u=this.grid().grid("option","data");var l=false;var c={};if(this.options.multiple){for(s=0;s<o.length;s++){for(r=0;r<u.length;r++){if(u[r][p]!=o[s]&&u[r][a]!=o[s]){c[s.toString()]=true}if(u[r][p]==o[s]){m.push(u[r][a]);f.push(u[r][p]);l=true;break}}if(!l&&!this.options.forceSelection){if((!c[s.toString()]&&!n)||n){m.push(o[s]);f.push(o[s])}}l=false}var d=this._getOnlyValues();
var q=this._getOnlyTexts();for(s=0;s<o.length;s++){for(r=0;r<q.length;r++){if(q[r]==o[s]&&$.inArray(q[r],f)===-1){m.push(d[r]);f.push(q[r])}}}}else{var h=-1;for(s=0;s<u.length;s++){if(u[s][p]==o[0]){h=h===-1?s:h;l=true}}if(l){m.push(u[h][a]);f.push(u[h][p])}if(!l&&!this.options.forceSelection){if((!c["0"]&&!n)||n){m.push(o[0]);f.push(o[0])}}}return{valarr:m,textarr:f}},reload:function(b){this.cache.isReload=true;var a=this.grid(),d=this,c={},f=false,e=[];if(!b&&!this.options.url){b=[]}else{if(!b&&this.options.url){b=this.options.url}}if(typeof(b)!=="string"){c=b;if(c.data){e=c.data}else{if(c.url){b=c.url;f=true}else{if(b instanceof Array){e=b}else{if(!c.url&&!c.data&&!this.options.url){e=[]}else{if(!c.url&&!c.data&&this.options.url){b=this.options.url;f=true}}}}}}else{this.options.url=b;f=true}if($.isFunction(c.onLoad)){this.cache.onLoad=c.onLoad}if(c.postData){}a.grid("reload",b)},_removeGridHighlights:function(){this._removeHighlight(this.grid().find(".coral-grid-btable tr td > span.coral-keyword-highlight"))},_addGridHighlights:function(){this._addHighlight(this.grid().find(".coral-grid-btable .jqgrow").children("td"),this.uiCombo.textbox.val())},_updateGridData:function(e){var b=this;var d=this.grid().grid("getRowData",e.rowId);var c=this._getTextFromHTML(d[this.options.valueField]);var f=this._getTextFromHTML(d[this.options.textField]);var a=$.inArray(c,this.gridValueArr);if(!this.options.multiple){this.gridValueArr=[c];this.gridTextArr=[f];this.gridRowIdArr=[e.rowId];return}if(!e.status){if(a!=-1){this.gridValueArr.splice(a,1);this.gridTextArr.splice(a,1);this.gridRowIdArr.splice(a,1)}}else{if(a==-1){this.gridValueArr.push(c);this.gridTextArr.push(f);this.gridRowIdArr.push(e.rowId)}}},_create:function(){var a=this,c=null,b;this.element.addClass("coral-form-element-combogrid coral-validation-combogrid");this._super();this.panelRendered=true;if(null!==this.options.buttonOptions){this.$button=this._getButtonEl();this.component().append(this.$button).addClass("coral-combogrid-hasButton");
this.$button.button(this.options.buttonOptions)}this.uiCombo.panel.unbind().bind("mousedown",function(f){a.cancelBlur=true;a._delay(function(){delete a.cancelBlur});var d=$(f.target).closest(".coral-grid-pager").length;if(d==1){return true}else{return false}})},_initCombo:function(){this._super();var a=$();if(this.options.pager){grid=$('<div id="combo_grid_'+$(this.element).attr("id")+'"><div class="combo_grid_'+$(this.element).attr("id")+'"></div></div>').appendTo(this.uiCombo.pContent)}else{grid=$('<div id="combo_grid_'+$(this.element).attr("id")+'"></div>').appendTo(this.uiCombo.pContent)}this.gridValueArr=[];this.gridTextArr=[];this.gridRowIdArr=[];goptions={fitStyle:"fill",keyName:this.options.valueField,sortable:this.options.sortable,colModel:this.options.colModel,colNames:this.options.colNames,multiselect:this.options.multiple,sortname:this.options.sortname,width:"auto"};goptions=$.extend({},goptions,this.options.gridOptions);if(null!=this.options.url){goptions.url=this.options.url;goptions.datatype="json"}else{goptions.data=this.options.data;goptions.datatype="local"}this._on(grid,{gridonselectrow:function(d,c){var b=this._getOnlyValues();if(this.options.multiple){if($.inArray(c.rowId,b)==-1){b.push(c.rowId)}else{b.splice($.inArray(c.rowId,b),1)}}else{b=[c.rowId]}this.setValues(b,true,false);if(!this.options.multiple&&d.originalEvent&&d.originalEvent.type=="click"){this.hidePanel()}},gridonselectall:function(d,c){var b=c.status?c.aRowIds.concat():[];this.setValues(b,true,false)},gridonload:function(k,h){var c=this,j=false,g=h.data;if(c.options.clearOnLoad){j=c._clearValues(g)}this._addGridHighlights();this.dataLoaded=true;var d=this.grid().grid("option","selarrrow").concat();for(var b=0;b<d.length;b++){this.grid().grid("setSelection",d[b],false)}var f=this._getOnlyValues();$.each(f,function(l,e){c.grid().grid("setSelection",e,false,null)});if(j==true){this.currentValues=[]}if(!this.search){this.setValues(this.currentValues);this.search=false}if(this.cache.isReload){this.cache.isReload=false;
this._trigger(this.cache.onLoad||"onLoad",null,[h]);delete this.cache.onLoad}}});grid.grid(goptions);grid.grid("refresh")},_getButtonEl:function(){return $("<button type='button'></button>").addClass("coral-combogrid-button")},_getRowDataByColName:function(f){var d=this,c=this.options,a=this.grid(),b=a.grid("option","data"),e=[];if(typeof f==="string"){f=[f]}$.each(b,function(h,l){var g={};for(var j in f){var k=f[j];g[k]=l[k]}e.push(g)});return e},_getTextArrByValueArr:function(h){var f=this,a=this.options,k=this.options.valueField,c=this.options.textField,b=this._getRowDataByColName([k,c]),j=[];for(var d in h){var g=h[d],e=false;$.each(b,function(i,l){if(g==l[k]){j.push(l[c]);e=true}});if(!e){j.push(h[d])}}return j},setValues:function(n,h,o){var p=this.grid();var e=p.grid("option","selarrrow").concat();for(var g=0;g<e.length;g++){p.grid("setSelection",e[g],false)}if(!this.dataLoaded){var j={setValues:{values:n,text:o,triggerOnChange:h}};this._addCacheItem(j)}var a=this.options;var l=[];l=this._getTextArrByValueArr(n);o=typeof o=="boolean"?o:false;if(!o){this._setText(l.join(a.separator))}this.currentValues=n;this.currentTexts=l;var m=n.concat();m.sort();for(var g=0;g<m.length;g++){if(m[g]!==m[g+1]&&g!=m.length||g==m.length){p.grid("setSelection",m[g],false)}}if(a.width=="item"){var c=$("<div style = 'visibility:hidden;'><span>"+this.getText()+"</span></div>").appendTo("body"),k=this.component().find(".coral-textbox-default");var d=parseInt(k.css("padding-left"))+parseInt(k.css("padding-right")),f=this.uiArrow().outerWidth()+2*parseInt(this.uiArrow().css("right")),b=c.find("span").outerWidth()+d+f;this.resize(b);c.remove();a.width="item"}this._super(n,h,false)},_getOnlyValues:function(){var e=this.getData(),a=this.options,b=[],f=0;if(!this.currentValues||(!this.currentValues[0]&&this.currentValues.length===1)){return b}for(;f<this.currentValues.length;f++){var g=this.currentValues[f],d=0,h=a.valueField,c=a.textField,k=null;if("value-text"===a.postMode){b.push(g.split(a.valueTextSeparator)[0])
}if("value"===a.postMode){b.push(g)}if("text"===a.postMode){for(;e&&d<e.length;d++){k=e[d];if(k[c]==g){b.push(k[h]);break}}}}return b},_getOnlyTexts:function(){return this.currentTexts||[]},getData:function(){return this.grid().grid("option","data")||[]},_selectPrev:function(){var d=this,c=null,a=0,e=d.grid().grid("getDataIDs");selarrrow=d.grid().grid("option","selarrrow").concat();valueFirst=d.getValues()[0];d.selectedRow=d.selectedRow||valueFirst;if(d.options.multiple){if(d.selectedRow){for(var b=e.length;b>=0;b--){if(d.selectedRow==e[b]){a=(b==0?(e.length-1):(b-1));d.selectedRow=e[a];break}}if($.inArray(d.selectedRow,selarrrow)==-1){d.grid().grid("setSelection",d.selectedRow)}}else{d.selectedRow=e.length;d.grid().grid("setSelection",e.length)}d._scrollTo(d.selectedRow)}else{c=d.grid().grid("option","selrow");if(c){a=d.grid().grid("getInd",c);if(a>=0){d.grid().grid("setSelection",e[a-2])}}else{d.grid().grid("setSelection",e.length)}}d._scrollTo(c)},_selectNext:function(){var d=this,c=null,a=0,e=d.grid().grid("getDataIDs");selarrrow=d.grid().grid("option","selarrrow").concat();valueFirst=d.getValues()[0];d.selectedRow=d.selectedRow||valueFirst;if(d.options.multiple){if(d.selectedRow){for(var b=0;b<e.length;b++){if(d.selectedRow==e[b]){a=(b==e.length-1?0:(b+1));d.selectedRow=e[a];break}}if($.inArray(d.selectedRow,selarrrow)==-1){d.grid().grid("setSelection",d.selectedRow)}}else{d.selectedRow=e[0];d.grid().grid("setSelection",e[0])}d._scrollTo(d.selectedRow)}else{c=d.grid().grid("option","selrow");if(c){a=d.grid().grid("getInd",c);if(a<e.length){d.grid().grid("setSelection",e[a])}}else{d.grid().grid("setSelection",e[0])}d._scrollTo(c)}},_doEnter:function(){if(!this.uiCombo.panel.is(":visible")){return}if(this.options.multiple){this.grid().grid("setSelection",this.selectedRow)}else{this.hidePanel()}},_scrollTo:function(d){var a=this.panel();var c=a.find('.coral-row-ltr[id="'+d+'"]');if(c.length){if(c.position().top<=0){var b=a.find(".coral-grid-rows-view").scrollTop()+c.position().top-c.outerHeight();
a.find(".coral-grid-rows-view").scrollTop(b)}else{if(c.position().top+c.outerHeight()>a.find(".coral-grid-rows-view").height()){var b=a.find(".coral-grid-rows-view").scrollTop()+c.position().top+c.outerHeight()-a.find(".coral-grid-rows-view").height();a.find(".coral-grid-rows-view").scrollTop(b)}}}}});