function _pivotfilter(d,c){var b,f,a=[],e;if(!this||typeof d!=="function"||(d instanceof RegExp)){throw new TypeError()}e=this.length;for(b=0;b<e;b++){if(this.hasOwnProperty(b)){f=this[b];if(d.call(c,f,b,this)){a.push(f);break}}}return a}$.assocArraySize=function(c){var b=0,a;for(a in c){if(c.hasOwnProperty(a)){b++}}return b};$.component("coral.grid",$.coral.grid,{pivotSetup:function(f,k){var d=[],h=this,i=[],j=[],e=[],g=[],a={grouping:true,groupingView:{groupField:[],groupSummary:[],groupSummaryPos:[]}},c=[],b=$.extend({rowTotals:false,rowTotalsText:"Total",colTotals:false,groupSummary:true,groupSummaryPos:"header",frozenStaticCols:false},k||{});this.element.each(function(){var t,q,J,Q=f.length,D,K,E,O,u,z=0;function B(S,R,r){var T;T=_pivotfilter.call(S,R,r);return T.length>0?T[0]:null}function s(U,S){var R=0,r=true,T;for(T in U){if(U[T]!=h[R]){r=false;break}R++;if(R>=h.length){break}}if(r){q=S}return r}function x(U,r,T,S){var R;switch(U){case"sum":R=parseFloat(r||0)+parseFloat((S[T]||0));break;case"count":if(r===""||r==null){r=0}if(S.hasOwnProperty(T)){R=r+1}else{R=0}break;case"min":if(r===""||r==null){R=parseFloat(S[T]||0)}else{R=Math.min(parseFloat(r),parseFloat(S[T]||0))}break;case"max":if(r===""||r==null){R=parseFloat(S[T]||0)}else{R=Math.max(parseFloat(r),parseFloat(S[T]||0))}break}return R}function P(ac,T,aa,ad){var R=T.length,V,Z,U,ab,S="",W=[];if($.isArray(aa)){ab=aa.length;W=aa}else{ab=1;W[0]=aa}e=[];g=[];e.root=0;for(U=0;U<ab;U++){var Y=[],r;for(V=0;V<R;V++){if(aa==null){Z=$.trim(T[V].member)+"_"+T[V].aggregator;r=Z;W[0]=r}else{r=aa[U].replace(/\s+/g,"");try{Z=(R===1?S+r:S+r+"_"+T[V].aggregator+"_"+String(V))}catch(X){}}Z=!isNaN(parseInt(Z,10))?Z+" ":Z;ad[Z]=Y[Z]=x(T[V].aggregator,ad[Z],T[V].member,ac);if(U<=1&&r!=="_r_Totals"&&S===""){S=r}}e[Z]=Y;g[Z]=W[U]}return ad}if(b.rowTotals&&b.yDimension.length>0){var G=b.yDimension[0].dataName;b.yDimension.splice(0,0,{dataName:G});b.yDimension[0].converter=function(){return"_r_Totals"}}D=$.isArray(b.xDimension)?b.xDimension.length:0;
K=b.yDimension.length;E=$.isArray(b.aggregates)?b.aggregates.length:0;if(D===0||E===0){throw ("xDimension or aggregates optiona are not set!")}var L;for(J=0;J<D;J++){L={name:b.xDimension[J].dataName,frozen:b.frozenStaticCols};if(b.xDimension[J].isGroupField==null){b.xDimension[J].isGroupField=true}L=$.extend(true,L,b.xDimension[J]);d.push(L)}var H=D-1,y={};while(z<Q){t=f[z];var F=[];var M=[];O={};J=0;do{F[J]=$.trim(t[b.xDimension[J].dataName]);O[b.xDimension[J].dataName]=F[J];J++}while(J<D);var I=0;q=-1;u=B(i,s,F);if(!u){I=0;if(K>=1){for(I=0;I<K;I++){M[I]=$.trim(t[b.yDimension[I].dataName]);if(b.yDimension[I].converter&&$.isFunction(b.yDimension[I].converter)){M[I]=b.yDimension[I].converter.call(this,M[I],F,M)}}O=P(t,b.aggregates,M,O)}else{if(K===0){O=P(t,b.aggregates,null,O)}}i.push(O)}else{if(q>=0){I=0;if(K>=1){for(I=0;I<K;I++){M[I]=$.trim(t[b.yDimension[I].dataName]);if(b.yDimension[I].converter&&$.isFunction(b.yDimension[I].converter)){M[I]=b.yDimension[I].converter.call(this,M[I],F,M)}}u=P(t,b.aggregates,M,u)}else{if(K===0){u=P(t,b.aggregates,null,u)}}i[q]=u}}var p=0,C=null,A=null,o;for(o in e){if(e.hasOwnProperty(o)){if(p===0){if(!y.children||y.children===undefined){y={text:o,level:0,children:[],label:o}}C=y.children}else{A=null;for(J=0;J<C.length;J++){if(C[J].text===o){A=C[J];break}}if(A){C=A.children}else{C.push({children:[],text:o,level:p,fields:e[o],label:g[o]});C=C[C.length-1].children}}p++}}z++}var n=[],l=d.length,w=l;if(K>0){c[K-1]={useColSpanStyle:false,groupHeaders:[]}}function N(X){var U,W,Z,V,R;for(Z in X){if(X.hasOwnProperty(Z)){if(typeof X[Z]!=="object"){if(Z==="level"){if(n[X.level]===undefined){n[X.level]="";if(X.level>0&&X.text!=="_r_Totals"){c[X.level-1]={useColSpanStyle:false,groupHeaders:[]}}}if(n[X.level]!==X.text&&X.children.length&&X.text!=="_r_Totals"){if(X.level>0){c[X.level-1].groupHeaders.push({titleText:X.label,numberOfColumns:0});var r=c[X.level-1].groupHeaders.length-1,T=r===0?w:l+E;if(X.level-1===(b.rowTotals?1:0)){if(r>0){var S=c[X.level-1].groupHeaders[r-1].numberOfColumns;
if(S){T=S+1+b.aggregates.length}}}c[X.level-1].groupHeaders[r].startColumnName=d[T].name;c[X.level-1].groupHeaders[r].numberOfColumns=d.length-T;l=d.length}}n[X.level]=X.text}if(X.level===K&&Z==="level"&&K>0){if(E>1){var Y=1;for(U in X.fields){if(Y===1){c[K-1].groupHeaders.push({startColumnName:U,numberOfColumns:1,titleText:X.text})}Y++}c[K-1].groupHeaders[c[K-1].groupHeaders.length-1].numberOfColumns=Y-1}else{c.splice(K-1,1)}}}if(X[Z]!=null&&typeof X[Z]==="object"){N(X[Z])}if(Z==="level"){if(X.level>0){W=0;for(U in X.fields){if(X.fields.hasOwnProperty(U)){R={};for(V in b.aggregates[W]){if(b.aggregates[W].hasOwnProperty(V)){switch(V){case"member":case"label":case"aggregator":break;default:R[V]=b.aggregates[W][V]}}}if(E>1){R.name=U;R.label=b.aggregates[W].label||X.label}else{R.name=X.text;R.label=X.text==="_r_Totals"?b.rowTotalsText:X.label}d.push(R);W++}}}}}}}N(y);var m;if(b.colTotals){var v=i.length;while(v--){for(J=D;J<d.length;J++){m=d[J].name;if(!j[m]){j[m]=parseFloat(i[v][m]||0)}else{j[m]+=parseFloat(i[v][m]||0)}}}}if(H>0){for(J=0;J<H;J++){if(d[J].isGroupField){a.groupingView.groupField.push(d[J].name);a.groupingView.groupSummary.push(b.groupSummary);a.groupingView.groupSummaryPos.push(b.groupSummaryPos)}}}else{a.grouping=false}a.sortname=d[H].name;a.groupingView.hideFirstGroupCol=true});return{colModel:d,rows:i,groupOptions:a,groupHeaders:c,summary:j}},jqPivot:function(e,f,a,c){var d=this;function b(l){var h=d.pivotSetup(l,f),m=$.assocArraySize(h.summary)>0?true:false,k=$.grid.from(h.rows),j;for(j=0;j<h.groupOptions.groupingView.groupField.length;j++){k.orderBy(h.groupOptions.groupingView.groupField[j],"a","text","")}$.extend(true,d.options,{data:k.select(),userData:m?h.summary:{},datatype:"local",footerrow:m,userDataOnFooter:m,colModel:h.colModel,viewrecords:true,groupHeader:true,groupHeaders:f.rowTotals?h.groupHeaders[1]&&h.groupHeaders[1].groupHeaders:h.groupHeaders[0]&&h.groupHeaders[0].groupHeaders,sortname:f.xDimension[0].dataName},h.groupOptions,a||{});var g=h.groupHeaders;
if(f.frozenStaticCols){$(this.element).grid("setFrozenColumns")}}if(typeof e==="string"){$.ajax($.extend({url:data,dataType:"json",success:function(g){b($.grid.getAccessor(g,c&&c.reader?c.reader:"rows"))}},ajaxOpt||{}))}else{b(e)}}});