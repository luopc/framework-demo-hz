$.component("coral.combotree",$.coral.combo,{version:"4.0.3",castProperties:["data","rootNode","buttons"],options:{valueField:"id",textField:"name",panelRenderOnShow:false,mode:"local",method:"post",url:null,data:null,buttons:[],postMode:"value",multiple:false,simpleDataEnable:false,simpleDataIdKey:"id",simpleDataPIdKey:"pId",simpleDataRootPId:null,rootNode:false,radioType:"level",showRootNode:true,allowPushParent:true,traversal:false,cascadeCheck:false,formatter:function(b){var a=$(this).combotree("option","textField");return b[a]},loader:function(f,e,c){var d=this,a=$(this),b=a.combotree("option","url");if(!b){return false}$.ajax({type:a.combotree("option","method"),url:b,data:f,dataType:"json",success:function(g){e(g)},error:function(g){c.apply(this,arguments)}})},beforeClick:null,beforeLoad:$.noop,onLoad:$.noop,onError:$.noop,onSelect:$.noop,unSelect:$.noop,onExpand:null,onClick:null},tree:function(){return $("#"+$(this.element).attr("id")+"_tree")},_filterLocalTree:function(a){var c=this,b=$("#"+$(this.element).attr("id")+"_tree");b.tree("filterNodesByParam",a)},_create:function(){var a=this,b=null;this.element.addClass("coral-form-element-combotree coral-validation-combotree coral-combobox-f ctrl-form-element");b=function(){};this.options.onShowPanel=b;this._super();if(this.options.popupDialog){this.uiCombo.popupInputbox=this.uiCombo.popupInputbox.textbox({componentCls:"coral-combo-popup-input",icons:[{icon:"cui-icon-search2",click:function(d,c){a._filterLocalTree({name:c.value})}}],onKeyUp:function(d,c){a._filterLocalTree({name:c.value});d.stopPropagation()}});this.uiCombo.popupDialog.dialog({autoOpen:false,title:"下拉树",height:"auto",width:"auto",modal:true,resizable:false,buttons:{"确定":function(f){var c=$.data(a.uiCombo.popupInputbox,"value"),d=$.data(a.uiCombo.popupInputbox,"text");if(c){a.setValues(c,true,d)}$(this).dialog("close")},"关闭":function(c){$(this).dialog("close")}}})}this.uiCombo.panel.unbind().bind("mouseover",function(c){$(c.target).closest(".coral-combobox-item").addClass("coral-combobox-item-hover")
}).bind("mouseout",function(c){$(c.target).closest(".coral-combobox-item").removeClass("coral-combobox-item-hover")}).bind("mousedown",function(c){a.cancelBlur=true;a._delay(function(){delete a.cancelBlur});return false})},_getSetting:function(){var b=this;var a={simpleDataEnable:this.options.simpleDataEnable,simpleDataIdKey:this.options.simpleDataIdKey,simpleDataPIdKey:this.options.simpleDataPIdKey,simpleDataRootPId:this.options.simpleDataRootPId,checkable:this.options.multiple,radioType:this.options.radioType,showRootNode:this.options.showRootNode,rootNode:this.options.rootNode,chkboxType:this.options.cascadeCheck?{Y:"",N:""}:{Y:"ps",N:"ps"},beforeClick:function(e,d){if(!b.options.allowPushParent&&d.isParent){return false}var c=$.coral.toFunction(b.options.beforeClick);if(!b.options.multiple){if($.isFunction(c)){return c(e,d)}return true}else{return false}},onClick:function(k,j,h,g){var d=[];var c=[];d.push(h.name);c.push(h.id);if(b.options.traversal){var f=h.getParentNode();while(!!f){d.push(f.name);f=f.getParentNode()}}if(b.options.popupDialog){$.data(b.uiCombo.popupInputbox,"value",c.reverse());$.data(b.uiCombo.popupInputbox,"text",d.reverse())}else{b.setValues(c.reverse(),true,d.reverse())}if(!b.options.multiple&&!h.isParent||!b.options.multiple&&b.options.allowPushParent){b.hidePanel()}b._trigger("onNodeClick",k,{treeId:j,node:h,clickFlag:g});return false},beforeCheck:function(e,d){var c=b._trigger("beforeNodeCheck",null,{treeId:e,node:d});if(!c){return false}},onCheck:function(m,k,j){var g=[];var f=[];var d=$("#"+k).tree("getCheckedNodes",true);for(var h=0,c=d.length;h<c;h++){if(b.options.cascadeCheck||!d[h].getCheckStatus().half){if(!b.options.allowPushParent&&d[h].isParent){continue}g.push(d[h].name);f.push(d[h].id)}}if(b.options.popupDialog){$.data(b.uiCombo.popupInputbox,"value",f);$.data(b.uiCombo.popupInputbox,"text",g)}else{b.setValues(f,true,g)}b._trigger("onNodeCheck",m,{treeId:k,node:j})},onLoad:function(k,j,o,f){var p=[],m=[],h,d=[],n=false,g=$("#"+j).tree("getNodes"),c=$("#"+j).tree("transformToArray",g);
if(b.options.clearOnLoad){n=b._clearValues(c)}if(b.options.multiple){d=$("#"+j).tree("getCheckedNodes",true);for(h=0,l=d.length;h<l;h++){if(b.options.cascadeCheck||!d[h].getCheckStatus().half){if(!b.options.allowPushParent&&d[h].isParent){continue}p.push(d[h].name);m.push(d[h].id)}}}else{d=$("#"+j).tree("getSelectedNodes")}if(b.currentValues.length&&!n){m=b.currentValues}if(!b.isInit){b.isInit=true;b.originalValue=m.join(",")}b.dataLoaded=true;b.setValues(m);b.isLoaded=true;b._trigger("onLoad",k,{treeId:j,treeNode:o,msg:f})},onExpand:function(f,d,c){b._trigger("onExpand",f,[{treeId:d,node:c}])}};return a},setPopupInput:function(a){this.uiCombo.popupInputbox.textbox("setValue",a.join(this.options.separator))},_initData:function(){var a=$('<ul id="'+$(this.element).attr("id")+'_tree"></ul>');if(this.options.popupDialog){a.appendTo(this.uiCombo.popupDialog);this.uiCombo.popupDialogTree=a}else{a.appendTo(this.uiCombo.pContent)}this.uiCombo.panel.unbind().bind("mousedown",function(h){h.preventDefault()});var g=this._getSetting();if(typeof this.options.url=="string"&&this.options.url!==""){$.extend(g,{asyncEnable:true,asyncUrl:this.options.url,asyncAutoParam:"id,name"})}a.tree(g,this.options.data);var e=[];var d=[];var c=$("#"+$(this.element).attr("id")+"_tree").tree("getCheckedNodes",true);for(var f=0,b=c.length;f<b;f++){if((c[f].getCheckStatus()!=null)&&(this.options.cascadeCheck||!c[f].getCheckStatus().half)){e.push(c[f].name);d.push(c[f].id)}}if(d.length>0){this.setValues(d,false,e)}},_renderItems:function(a){},_scrollTo:function(d){var a=this.panel();var c=a.find('div.coral-combobox-item[value="'+d+'"]');if(c.length){if(c.position().top<=0){var b=a.scrollTop()+c.position().top;a.scrollTop(b)}else{if(c.position().top+c.outerHeight()>a.height()){var b=a.scrollTop()+c.position().top+c.outerHeight()-a.height();a.scrollTop(b)}}}},_request:function(a,h,e){var d=this,c={},f=[],b=this.options.loader,g=false;if(!a&&!d.options.url){a=[]}else{if(!a&&d.options.url){a=d.options.url
}}if(typeof(a)!=="string"){c=a;if(c.data){f=c.data}else{if(c.url){a=c.url;d.options.url=c.url;g=true}else{if(c instanceof Array){f=a}else{if(!c.url&&!c.data&&!d.options.url){f=[]}else{if(!c.url&&!c.data&&d.options.url){a=d.options.url;g=true}}}}}}else{d.options.url=a;g=true}if(g){h=h||{};if(this._trigger("beforeLoad",null,[h])==false){return}b.apply(this.element,[h,function(j){d.loadData(j,e);d._trigger($.isFunction(c.onLoad)?c.onLoad:"onLoad",null,[j])},function(){d._trigger("onError",null,arguments)}])}else{d.loadData(f,e);d._trigger($.isFunction(c.onLoad)?c.onLoad:"onLoad",null,[f])}},getTree:function(){return $("#"+$(this.element).attr("id")+"_tree")},loadData:function(d,b){var c=this.getTree();c.tree("reload",d);var a=c.tree("getNodes");$.each(a,function(e,f){c.tree("expandNode",f,true)});this.dataLoaded=true;this.setValues(this.currentValues)},getData:function(){return this.getTree().tree("getNodes")||[]},setComboValues:function(a,b){this.setValues(a,false,b)},_setCombotree:function(b,e){b=this.currentValues;var d=this.options;var f=[];var a=$(this.element).attr("id");$("#"+a+"_tree").tree("cancelSelectedNode");if(d.multiple){$("#"+a+"_tree").tree("checkAllNodes",false);for(i in b){var c=$("#"+a+"_tree").tree("getNodeByParam","id",b[i]);if(c){$("#"+a+"_tree").tree("checkNode",c,true,!d.cascadeCheck)}if(!e){var c=$("#"+a+"_tree").tree("getNodeByParam","id",b[i]);if(c){f.push(c.name)}else{f.push(b[i])}}}}else{for(i in b){var c=$("#"+a+"_tree").tree("getNodeByParam","id",b[i]);$("#"+a+"_tree").tree("selectNode",c);if(!e){var c=$("#"+a+"_tree").tree("getNodeByParam","id",b[i]);if(c){f.push(c.name)}else{f.push(b[i])}}}}if(!e){e=f}return e},setValues:function(a,f,e){this.currentValues=a;var c=this._setCombotree(a,e);var d=this.options,b=[];e=typeof e=="boolean"?e:false;if(!e){this._setText(c.join(d.separator))}this._super(a,f,e)},setValue:function(b,c,a){b=b.split(this.options.separator);this.setValues(b,false,a)},_getOnlyValues:function(){var e=this.getData(),c=this.options,b=[],a=0;
if(!this.currentValues||(!this.currentValues[0]&&this.currentValues.length===1)){return b}for(;a<this.currentValues.length;a++){var d=this.currentValues[a];if("value"===c.postMode){b.push(d)}}return b},_showItems:function(){var b=this.tree().tree("getNodes");var a=this.tree().tree("transformToArray",b);this.tree().tree("showNodes",a,{showParents:true})},_doQuery:function(c){if(c==""){return}var b=this.options,d=[],f=b.textField,s=b.valueField,p=this.options.filter;if(b.mode=="remote"){this._request(null,{q:c},true)}else{var e=this.tree().tree("getNodes");var k=this.tree().tree("transformToArray",e);this.tree().tree("hideNodes",k);for(var h=0;h<k.length;h++){var m=pinyinEngine.toPinyin(k[h][f],false,"");for(var g=0;g<c.length;g++){var a=p.apply(this.element,[c[g],k[h]]);if(a){var n=k[h][s];var o=k[h][f];if(o.indexOf(c[g])>-1||m.indexOf(c[g])>-1){d.push(k[h]);this.tree().tree("showNodes",d,{showParents:true});this.tree().tree("expandNode",d[0].getParentNode(),true,false,false)}}}}}},_checkMathch:function(r,s){var a=[],p=[],v=[],q=[],b=[],m,g,f,n,u=this.options,d=u.textField,t=u.valueField;if(s){this._showItems()}var c=false;var e={};if(u.multiple){this.tree().tree("checkAllNodes",false);for(m=0;m<r.length;m++){if(s){if(this.options.forceSelection&&$.trim(r[m])===""){continue}}var b=this.tree().tree("getNodesByParam",d,r[m],null);if(!b.length){e[m.toString()]=true}for(g=0;g<b.length;g++){if(u.cascadeCheck||!b[g].isParent){a.push(b[g][t]);p.push(b[g][d]);c=true;break}}if(!c&&!this.options.forceSelection){if((!e[m.toString()]&&!s)||s){a.push(r[m]);p.push(r[m])}}c=false}for(n=0;n<a.length;n++){var b=this.tree().tree("getNodesByParam",t,a[n],null);if(b.length){this.tree().tree("checkNode",b[0],true,!u.cascadeCheck)}}var b=this.tree().tree("getCheckedNodes",true);for(f=0,l=b.length;f<l;f++){if(u.cascadeCheck||!b[f].getCheckStatus().half){if(!u.allowPushParent&&b[f].isParent){continue}if($.inArray(b[f][t],a)==-1){p.push(b[f][d]);a.push(b[f][t])}}}}else{var b=this.tree().tree("getNodesByParam",d,r[0],null);
var o=-1;for(m=0;m<b.length;m++){o=o===-1?m:o;c=true}if(c){a.push(b[o][t]);p.push(b[o][d])}if(!c&&!this.options.forceSelection){a.push(r[0]);p.push(r[0])}}return{valarr:a,textarr:p}},clear:function(){this._super();if(this.options.multiple){$("#"+$(this.element).attr("id")+"_tree").tree("checkAllNodes",false)}},_formatValue:function(f){var e;if(this.options.multiple){e=this.getTree().tree("getCheckedNodes",true)}else{e=this.getTree().tree("getSelectedNodes")}var d=this.options,b=d.valueField,a=d.textField,c=0,g=null;if("text"===d.postMode||"value-text"===d.postMode){for(c=0;c<e.length;c++){g=e[c];if(""!=f&&f==g[b]){if("text"===d.postMode){return g[a]}if("value-text"===d.postMode){return f+d.valueTextSeparator+g[a]}}}}return f},reload:function(a){this._request(a)},_destroy:function(){var a=this;this.element.removeClass("coral-validation-combotree");this.element.removeClass("coral-form-element-combotree");if(this.options.popupDialog){this.uiCombo.popupDialog.dialog("forceDestroy")}this._super()}});