$.component("coral.grid",$.coral.grid,{editCell:function(e,c,f){var h=this,b,s,n,i;if(!h.grid||h.options.cellEdit!==true){return}c=parseInt(c,10);if(!h.options.knv){$(h.element).grid("GridNav")}if(h.options.savedRow.length>0){if(f===true){if(e==h.options.iRow&&c==h.options.iCol){return}}if(h.rows[h.options.savedRow[0].id]){if(!$(h.element).grid("saveCell",h.options.savedRow[0].id,h.options.savedRow[0].ic)){return}}}else{window.setTimeout(function(){$("#"+$.grid.coralID(h.options.knv)).attr("tabindex","-1").focus()},0)}i=h.options.colModel[c];b=i.name;if(b=="subgrid"||b=="cb"||b=="rn"){return}n=$("td:eq("+c+")",h.rows[e]);if(i.editable===true&&f===true&&!n.hasClass("not-editable-cell")){if(parseInt(h.options.iCol,10)>=0&&parseInt(h.options.iRow,10)>=0){$("td:eq("+h.options.iCol+")",h.rows[h.options.iRow]).removeClass("edit-cell coral-state-highlight");$(h.rows[h.options.iRow]).removeClass("selected-row coral-state-hover")}$(n).addClass("edit-cell coral-state-highlight");$(h.rows[e]).addClass("selected-row coral-state-hover");try{s=$.unformat.call(h,n,{rowId:h.rows[e].id,colModel:i},c)}catch(t){s=(i.edittype&&i.edittype=="textarea")?$(n).text():$(n).html()}if(h.options.autoencode){s=$.grid.htmlDecode(s)}if(!h._trigger("beforeEditCell",null,[{rowId:h.rows[e].id,name:b,cellValue:s,rowIndex:e,cellIndex:c}])){return}h.options.savedRow.push({id:e,ic:c,name:b,value:s});if(s==="&nbsp;"||s==="&#160;"||(s.length===1&&s.charCodeAt(0)===160)){s=""}if($.isFunction(h.options.formatCell)){var o=h.options.formatCell.call(h,h.rows[e].id,b,s,e,c);if(o!==undefined){s=o}}var u=i.editoptions,q={id:e+"_"+b,name:b};u=$.extend({},u||{},q);var m=$.grid.createEl.call(h,i.edittype,u,s,true,$.extend({},$.grid.ajaxOptions,h.options.ajaxSelectOptions||{}));$(n).html("").append(m).attr("tabindex","0");var a=function(v){if(v.keyCode===27){if($("input.hasDatepicker",n).length>0){if($(".coral-datepicker").is(":hidden")){$(h.element).grid("restoreCell",e,c)}else{$("input.hasDatepicker",n).datepicker("hide")
}}else{$(h.element).grid("restoreCell",e,c)}}if(v.keyCode===13){$(h.element).grid("saveCell",e,c);return false}if(v.keyCode===9){if(!h.grid.columnsView.loading){if(v.shiftKey){$(h.element).grid("prevCell",e,c)}else{$(h.element).grid("nextCell",e,c)}}else{return false}}v.stopPropagation()};var g={onKeyDown:a,value:$(m).val()},d=i.edittype,k=$(h.element).grid("getRowData",h.rows[e].id);switch(i.edittype){case"text":case"textarea":u=$.extend({},u,g);$(m).textbox(u);break;case"datepicker":u=$.extend({},u,g);$(m).datepicker(u);break;case"radio":u=$.extend({},u,g);$(m).radio(u);if($(m).val()=="Yes"){$(m).radio("check")}else{$(m).radio("uncheck")}break;case"checkbox":u=$.extend({},u,g);$(m).checkbox(u);if($(m).val()=="Yes"){$(m).checkbox("check")}else{$(m).checkbox("uncheck")}break;case"autocomplete":var p=$(m).val();var j=typeof(u.source)=="string";u=$.extend({},u,g);var r=u.postMode||"value";u.postMode=r;u=$.extend({},u,{onKeyDown:a});$(m).autocomplete(u);if(j){u.postMode="text";$(m).autocomplete(u);$(m).autocomplete("setValue",p)}else{if(r=="value"){$(m).autocomplete("setValue",p)}else{$(m).autocomplete("setValue",p);$(m).autocomplete("setText",p)}}break;case"combobox":case"combotree":case"combogrid":u=$.extend({},u,g);if(i.cellEditoptions){var l=h.getCellEditOptions(i,$(m).val(),u,k,q,g)}d=l&&l.type?l.type:i.edittype;u=l&&l.cOpts?l.cOpts:u;d=d=="text"?"textbox":d;$(m)[d](u);break}window.setTimeout(function(){$(m).focus()},0);h._trigger("afterEditCell",null,[{rowId:h.rows[e].id,name:b,cellValue:s,rowIndex:e,celIndex:c}])}else{if(parseInt(h.options.iCol,10)>=0&&parseInt(h.options.iRow,10)>=0){$("td:eq("+h.options.iCol+")",h.rows[h.options.iRow]).removeClass("edit-cell coral-state-highlight");$(h.rows[h.options.iRow]).removeClass("selected-row coral-state-hover")}n.addClass("edit-cell coral-state-highlight");$(h.rows[e]).addClass("selected-row coral-state-hover");s=n.html().replace(/\&#160\;/ig,"");$(h.element).triggerHandler("jqGridSelectCell",[h.rows[e].id,b,s,e,c]);if($.isFunction(h.options.onSelectCell)){h.options.onSelectCell.call(h,h.rows[e].id,b,s,e,c)
}}h.options.iCol=c;h.options.iRow=e},getCellEditOptions:function(c,f,g,b,a,h){var d=$.coral.toFunction(c.cellEditoptions).call(this,f,g,b);var e=d&&d.type?d.type:c.edittype;d=d&&d.cellEditoptions?$.extend({},d.cellEditoptions,a,h):g;g=d||g;return{cOpts:d,type:e}},GridNav:function(){var f=this;if(!f.grid||f.options.cellEdit!==true){return}f.options.knv=f.options.id+"_kn";var e=$("<span style='width:0px;height:0px;background-color:black;' tabindex='0'><span tabindex='-1' style='width:0px;height:0px;background-color:grey' id='"+f.options.knv+"'></span></span>"),c,b;function d(o,m,n){if(n.substr(0,1)=="v"){var g=$(f.grid.rowsView)[0].clientHeight,p=$(f.grid.rowsView)[0].scrollTop,q=f.rows[o].offsetTop+f.rows[o].clientHeight,k=f.rows[o].offsetTop;if(n=="vd"){if(q>=g){$(f.grid.rowsView)[0].scrollTop=$(f.grid.rowsView)[0].scrollTop+f.rows[o].clientHeight}}if(n=="vu"){if(k<p){$(f.grid.rowsView)[0].scrollTop=$(f.grid.rowsView)[0].scrollTop-f.rows[o].clientHeight}}}if(n=="h"){var j=$(f.grid.rowsView)[0].clientWidth,i=$(f.grid.rowsView)[0].scrollLeft,h=f.rows[o].cells[m].offsetLeft+f.rows[o].cells[m].clientWidth,l=f.rows[o].cells[m].offsetLeft;if(h>=j+parseInt(i,10)){$(f.grid.rowsView)[0].scrollLeft=$(f.grid.rowsView)[0].scrollLeft+f.rows[o].cells[m].clientWidth}else{if(l<i){$(f.grid.rowsView)[0].scrollLeft=$(f.grid.rowsView)[0].scrollLeft-f.rows[o].cells[m].clientWidth}}}}function a(k,g){var j,h;if(g=="lft"){j=k+1;for(h=k;h>=0;h--){if(f.options.colModel[h].hidden!==true){j=h;break}}}if(g=="rgt"){j=k-1;for(h=k;h<f.options.colModel.length;h++){if(f.options.colModel[h].hidden!==true){j=h;break}}}return j}$(e).insertBefore(f.grid.columnsView);$("#"+f.options.knv).focus().keydown(function(g){b=g.keyCode;if(f.options.direction=="rtl"){if(b===37){b=39}else{if(b===39){b=37}}}switch(b){case 38:if(f.options.iRow-1>0){d(f.options.iRow-1,f.options.iCol,"vu");$(f.element).grid("editCell",f.options.iRow-1,f.options.iCol,false)}break;case 40:if(f.options.iRow+1<=f.rows.length-1){d(f.options.iRow+1,f.options.iCol,"vd");
$(f.element).grid("editCell",f.options.iRow+1,f.options.iCol,false)}break;case 37:if(f.options.iCol-1>=0){c=a(f.options.iCol-1,"lft");d(f.options.iRow,c,"h");$(f.element).grid("editCell",f.options.iRow,c,false)}break;case 39:if(f.options.iCol+1<=f.options.colModel.length-1){c=a(f.options.iCol+1,"rgt");d(f.options.iRow,c,"h");$(f.element).grid("editCell",f.options.iRow,c,false)}break;case 13:if(parseInt(f.options.iCol,10)>=0&&parseInt(f.options.iRow,10)>=0){$(f.element).grid("editCell",f.options.iRow,f.options.iCol,true)}break;default:return true}return false})},saveCell:function(f,d){var h=this,g;if(!h.grid||h.options.cellEdit!==true){return}if(h.options.savedRow.length>=1){g=0}else{g=null}if(g!==null){var q=$("td:eq("+d+")",h.rows[f]),o,a,j=h.options.colModel[d],b=j.name,i=$.grid.coralID(b);if(this.options.autoValid){var x=this.valid(h.rows[f].id,j.name);if(!this.options.allowSaveOnError&&!x){$.message("请确认是否输入正确！");return x}}var r=j.edittype;if(j.cellEditoptions){var n=$(h.element).grid("getRowData",h.rows[f].id),w=$("#"+f+"_"+i,h.rows[f]),z=$.coral.toFunction(j.cellEditoptions).call(this,$(w).val(),j.editoptions,n);r=z&&z.type?z.type:r}switch(r){case"select":if(!j.editoptions.multiple){o=$("#"+f+"_"+i+" option:selected",h.rows[f]).val();a=$("#"+f+"_"+i+" option:selected",h.rows[f]).text()}else{var w=$("#"+f+"_"+i,h.rows[f]),u=[];o=$(w).val();if(o){o.join(",")}else{o=""}$("option:selected",w).each(function(e,v){u[e]=$(v).text()});a=u.join(",")}if(j.formatter){a=o}break;case"checkbox":var s=["Yes","No"];if(j.editoptions){s=j.editoptions.value.split(":")}o=$("#"+f+"_"+i,h.rows[f]).is(":checked")?s[0]:s[1];a=o;break;case"password":case"text":case"textarea":o=$("#"+f+"_"+i,h.rows[f]).val();a=o;break;case"button":o=$("#"+f+"_"+i,h.rows[f]).val();a=o;break;case"custom":try{if(j.editoptions&&$.isFunction(j.editoptions.custom_value)){o=j.editoptions.custom_value.call(h,$(".customelement",q),"get");if(o===undefined){throw"e2"}else{a=o}}else{throw"e1"}}catch(y){if(y=="e1"){$.grid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+$.grid.edit.msg.nodefined,jQuery.jgrid.edit.bClose)
}if(y=="e2"){$.grid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+$.grid.edit.msg.novalue,jQuery.jgrid.edit.bClose)}else{$.grid.info_dialog(jQuery.jgrid.errors.errcap,y.message,jQuery.jgrid.edit.bClose)}}break;case"datepicker":o=$("#"+f+"_"+i,h.rows[f]).val();a=o;var C=$("#"+f+"_"+i,h.rows[f]);break;case"combobox":case"combogrid":case"combotree":o=$("#"+f+"_"+i,h.rows[f])[r]("getValues").toString();a=$("#"+f+"_"+i,h.rows[f])[r]("getText");if(j.formatter){a=o}break;case"autocomplete":a=$("#"+f+"_"+i,h.rows[f])[r]("getText");if(typeof(j.editoptions.source)=="string"){o=a}else{o=$("#"+f+"_"+i,h.rows[f])[r]("getValue")}if(j.formatter&&j.postMode=="value"){a=o}break}if(a!==h.options.savedRow[g].value){var B=$(h).triggerHandler("jqGridBeforeSaveCell",[h.rows[f].id,b,o,f,d]);if(B){o=B;a=B}if($.isFunction(h.options.beforeSaveCell)){var t=h.options.beforeSaveCell.call(h,h.rows[f].id,b,o,f,d);if(t){o=t;a=t}}var c=$.grid.checkValues(o,d,h);if(c[0]===true){var l=$(h).triggerHandler("jqGridBeforeSubmitCell",[h.rows[f].id,b,o,f,d])||{};if($.isFunction(h.options.beforeSubmitCell)){l=h.options.beforeSubmitCell.call(h,h.rows[f].id,b,o,f,d);if(!l){l={}}}if($("input.hasDatepicker",q).length>0){$("input.hasDatepicker",q).datepicker("hide")}if(h.options.cellsubmit=="remote"){if(h.options.cellurl){var A={};if(h.options.autoencode){o=$.grid.htmlEncode(o)}A[b]=o;var p,m,k;k=h.options.prmNames;p=k.id;m=k.oper;A[p]=$.grid.stripPref(h.options.idPrefix,h.rows[f].id);A[m]=k.editoper;A=$.extend(l,A);$("#lui_"+$.grid.coralID(h.options.id)).show();h.grid.columnsView.loading=true;$.ajax($.extend({url:h.options.cellurl,data:$.isFunction(h.options.serializeCellData)?h.options.serializeCellData.call(h,A):A,type:"POST",complete:function(e,D){$("#lui_"+h.options.id).hide();h.grid.columnsView.loading=false;if(D=="success"){var v=$(h).triggerHandler("jqGridAfterSubmitCell",[h,e,A.id,b,o,f,d])||[true,""];if(v[0]===true&&$.isFunction(h.options.afterSubmitCell)){v=h.options.afterSubmitCell.call(h,e,A.id,b,o,f,d)
}if(v[0]===true){$(q).empty();$(h.element).grid("setCell",h.rows[f].id,d,a,false,false,true);$(q).addClass("dirty-cell");$(h.rows[f]).addClass("edited");$(h).triggerHandler("jqGridAfterSaveCell",[h.rows[f].id,b,o,f,d]);if($.isFunction(h.options.afterSaveCell)){h.options.afterSaveCell.call(h,h.rows[f].id,b,o,f,d)}h.options.savedRow.splice(0,1)}else{$.grid.info_dialog($.grid.errors.errcap,v[1],$.grid.edit.bClose);$(h.element).grid("restoreCell",f,d)}}},error:function(e,v,D){$("#lui_"+$.grid.coralID(h.options.id)).hide();h.grid.columnsView.loading=false;$(h).triggerHandler("jqGridErrorCell",[e,v,D]);if($.isFunction(h.options.errorCell)){h.options.errorCell.call(h,e,v,D);$(h.element).grid("restoreCell",f,d)}else{$.grid.info_dialog($.grid.errors.errcap,e.status+" : "+e.statusText+"<br/>"+v,$.grid.edit.bClose);$(h.element).grid("restoreCell",f,d)}}},$.grid.ajaxOptions,h.options.ajaxCellOptions||{}))}else{try{$.grid.info_dialog($.grid.errors.errcap,$.grid.errors.nourl,$.grid.edit.bClose);$(h.element).grid("restoreCell",f,d)}catch(y){}}}if(h.options.cellsubmit=="clientArray"){$(q).empty();$(h.element).grid("setCell",h.rows[f].id,d,a,false,false,true);$(q).addClass("dirty-cell");$(h.rows[f]).addClass("edited");h._trigger("afterSaveCell",null,[{rowId:h.rows[f].id,name:b,cellValue:o,rowIndex:f,celIndex:d}]);h.options.savedRow.splice(0,1)}}else{try{window.setTimeout(function(){$.grid.info_dialog($.grid.errors.errcap,o+" "+c[1],$.grid.edit.bClose)},100);$(h.element).grid("restoreCell",f,d)}catch(y){}}}else{$(h.element).grid("restoreCell",f,d)}}if(false){$("#"+$.grid.coralID(h.options.knv)).attr("tabindex","-1").focus()}else{window.setTimeout(function(){$("#"+$.grid.coralID(h.options.knv)).attr("tabindex","-1").focus()},0)}},restoreCell:function(d,b){var c=this,a;if(!c.grid||c.options.cellEdit!==true){return}if(c.options.savedRow.length>=1){a=0}else{a=null}if(a!==null){var e=$("td:eq("+b+")",c.rows[d]);$(e).empty().attr("tabindex","-1");$(c.element).grid("setCell",c.rows[d].id,b,c.options.savedRow[a].value,false,false,true);
$(c).triggerHandler("jqGridAfterRestoreCell",[c.rows[d].id,c.options.savedRow[a].value,d,b]);if($.isFunction(c.options.afterRestoreCell)){c.options.afterRestoreCell.call(c,c.rows[d].id,c.options.savedRow[a].value,d,b)}c.options.savedRow.splice(0,1)}window.setTimeout(function(){$("#"+c.options.knv).attr("tabindex","-1").focus()},0)},nextCell:function(d,a){var c=this,e=false;if(!c.grid||c.options.cellEdit!==true){return}for(var b=a+1;b<c.options.colModel.length;b++){if(c.options.colModel[b].editable===true){e=b;break}}if(e!==false){$(c.element).grid("editCell",d,e,true)}else{if(c.options.savedRow.length>0){$(c.element).grid("saveCell",d,a)}}},prevCell:function(d,a){var c=this,e=false;if(!c.grid||c.options.cellEdit!==true){return}for(var b=a-1;b>=0;b--){if(c.options.colModel[b].editable===true){e=b;break}}if(e!==false){$(c.element).grid("editCell",d,e,true)}else{if(c.options.savedRow.length>0){$(c.element).grid("saveCell",d,a)}}},getChangedCells:function(e){var b=[];if(!e){e="all"}var c=this,a,d=true;if(!c.grid||c.options.cellEdit!==true){return}$(c.rows).each(function(f){var g={};if($(this).hasClass("edited")){$("td",this).each(function(h){a=c.options.colModel[h].name;if(a!=="cb"&&a!=="subgrid"){if($(this).hasClass("coral-gridcell-error")){d=false;return false}if(e=="dirty"){if($(this).hasClass("dirty-cell")){try{g[a]=$.unformat.call(c,this,{rowId:c.rows[f].id,colModel:c.options.colModel[h]},h)}catch(j){g[a]=$.jgrid.htmlDecode($(this).html())}}}else{try{g[a]=$.unformat.call(c,this,{rowId:c.rows[f].id,colModel:c.options.colModel[h]},h)}catch(j){g[a]=$.jgrid.htmlDecode($(this).html())}}}});if(!d){return false}g.id=this.id;b.push(g)}});if(!d){b=[]}return b}});