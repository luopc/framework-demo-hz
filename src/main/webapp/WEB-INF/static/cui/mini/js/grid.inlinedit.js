"use strict";$.coral.grid.inlineEdit=$.coral.grid.inlineEdit||{};$.component("coral.grid",$.coral.grid,{editButtonsPos:function(d,c){var g=this,b,f,a,e;b=$(g.element).grid("getDataIDs");f=$(g.element).grid("getInd",d,true);e=g.element.find(".coral-grid-rows-view").outerHeight();a=g.element.find(".coral-grid-btable").outerHeight();if((a+$(f).outerHeight()>e)&&d==b[b.length-1]){c.position({my:"left-"+(c.outerWidth()/2)+" top-2",at:"right-"+($(f).outerWidth()/2)+" top-"+($(c).outerHeight()),collision:"fit",of:$(f)})}else{c.position({my:"left-"+(c.outerWidth()/2)+" top-2",at:"right-"+($(f).outerWidth()/2)+" top+"+($(f).outerHeight()),collision:"fit",of:$(f)})}},editRow:function(g,q,A,f,d,e,l,j,a){var t={},c=$.makeArray(arguments).slice(1);if($.type(c[0])==="object"){t=c[0]}else{if(typeof q!=="undefined"){t.keys=q}if($.isFunction(A)){t.oneditfunc=A}if($.isFunction(f)){t.successfunc=f}if(typeof d!=="undefined"){t.url=d}if(typeof e!=="undefined"){t.extraparam=e}if($.isFunction(l)){t.aftersavefunc=l}if($.isFunction(j)){t.errorfunc=j}if($.isFunction(a)){t.afterrestorefunc=a}}t=$.extend(true,{keys:true,oneditfunc:null,successfunc:null,url:"clientArray",extraparam:{},aftersavefunc:null,errorfunc:null,afterrestorefunc:null,restoreAfterError:true,mtype:"POST"},$.coral.grid.inlineEdit,t);var x=this,b,y,u,v=0,s=null,k={},n,m;if(!x.grid){return}n=$(x.element).grid("getInd",g,true);x.options.editrow=g;x.editRowIndex=g;if(n===false){return}u=$(n).attr("editable")||"0";if(x._trigger("beforeInlineEditRow",null,[{rowId:g,options:t}])==false){return}if(u=="0"&&!$(n).hasClass("not-editable-row")){if(this.options.rowEditButtons){var z=$("<div class='row-editable coral-grid-rows'><div class='row-editable-btns coral-state-highlight'><div class='grid_edit_toolbar'></div></div></div>");var p=[];var h={type:"button",id:"update",label:$.grid.edit.bUpdate,name:"update",onClick:function(){var i=x.saveRow(n.id,null,"clientArray")}};var r={type:"button",id:"cancel",label:$.grid.edit.bCancel,name:"cancel",onClick:function(){x.restoreRow(n.id);
z.remove();x._trigger("afterInlineCancelRow",null,[{rowId:n.id,options:t,isUpdated:!$(n.id).hasClass("new-row")}])}};if(this.options.rowEditButtons.length===0){this.options.rowEditButtons=["update","cancel"]}for(var w=0;w<this.options.rowEditButtons.length;w++){if(this.options.rowEditButtons[w]=="update"){p.push(h)}else{if(this.options.rowEditButtons[w]=="cancel"){p.push(r)}else{p.push(this.options.rowEditButtons[w])}}}this.rowEditButtons=z;x.element.find(".row-editable").remove();x.element.find(".coral-grid-view").prepend(z[0]);$(".grid_edit_toolbar",x.element).toolbar({data:p});this._delay(function(){this.editButtonsPos(g,z)})}m=x.options.colModel;$('td[role="gridcell"]',n).each(function(F){b=m[F].name;var G=x.options.treeGrid===true&&b==x.options.ExpandColumn;if(G){y=$("span:first",this).html()}else{try{y=$.unformat.call(x,this,{rowId:g,colModel:m[F]},F)}catch(K){y=(m[F].edittype&&m[F].edittype=="textarea")?$(this).text():$(this).html()}}if(b!="cb"&&b!="subgrid"&&b!="rn"){if(x.options.autoencode){y=$.grid.htmlDecode(y)}k[b]=y;if(m[F].editable===true){if(s===null){s=F}if(G){$("span:first",this).html("")}else{$(this).html("")}var B=$.extend({},m[F].editoptions||{},{id:g+"_"+b,name:b});if(!m[F].edittype){m[F].edittype="text"}if(y=="&nbsp;"||y=="&#160;"||(y.length==1&&y.charCodeAt(0)==160)){y=""}var o=$.grid.createEl.call(x,m[F].edittype,B,y,false,$.extend({},$.grid.ajaxOptions,x.options.ajaxSelectOptions||{}));$(o).addClass("editable");if(G){$("span:first",this).append(o)}else{$(this).append(o)}var C=m[F].editoptions||{};var D=C.postMode||"value";$.extend(C,{onValidError:function(M,i){$(o).parents("td").addClass("coral-gridcell-error");M.stopPropagation()},onValidSuccess:function(M,i){$(o).parents("td").removeClass("coral-gridcell-error");M.stopPropagation()},onKeyDown:function(M,i){},onClick:function(M,i){M.stopPropagation()},dataCustom:{rowId:g,gridId:x.options.id}});var J=m[F].edittype;switch(J){case"autocomplete":var I=$(o).val();var L=typeof(C.source)=="string";
var H=C.onSelect;C=$.extend({},C,{onSelect:function(M,i){$(o).closest("td").attr("data-org",L?i.value:i.text);H&&H.apply(o,[M,i])}});if(L){C.postMode="text";$(o).autocomplete(C);$(o).autocomplete("setValue",I)}else{$(o).autocomplete(C);if(D=="value"){$(o).autocomplete("setValue",I)}else{$(o).autocomplete("setValue",I);$(o).autocomplete("setText",I)}}break;case"checkbox":$(o).checkbox(C);var E=["Yes","No"];if(C&&C.value){E=C.value.split(":")}if($(o).val()==E[0]){$(o).checkbox("check")}else{$(o).checkbox("uncheck")}break;case"combogrid":case"combobox":case"combotree":$(o)[J](C);$(o)[J]("setValues",$(o).val().split(","));break;case"text":case"textarea":$(o)["textbox"](C);break;default:$(o)[J](C);break}v++}}});if(v>0){k.id=g;x.options.savedRow.push(k);$(n).attr("editable","1");$("td:eq("+s+") input",n).focus();if(t.keys===true){$(n).bind("keydown",function(o){if(o.keyCode===27){$(x.element).grid("restoreRow",g,t.afterrestorefunc);if(x.options._inlinenav){try{$(x.element).grid("showAddEditButtons")}catch(C){}}return false}if(o.keyCode===13){var i=o.target;if(i.tagName=="TEXTAREA"){return true}if($(x.element).grid("saveRow",g,t)){if(x.options._inlinenav){try{$(x.element).grid("showAddEditButtons")}catch(B){}}}return false}})}x._trigger("onInlineEditRow",null,[{rowId:g,options:t}])}}},saveRow:function(j,h,f,g,p,m,a){var c=$.makeArray(arguments).slice(1),y={};if($.type(c[0])==="object"){y=c[0]}else{if($.isFunction(h)){y.successfunc=h}if(typeof f!=="undefined"){y.url=f}if(typeof g!=="undefined"){y.extraparam=g}if($.isFunction(p)){y.aftersavefunc=p}if($.isFunction(m)){y.errorfunc=m}if($.isFunction(a)){y.afterrestorefunc=a}}y=$.extend(true,{successfunc:null,url:null,extraparam:{},aftersavefunc:null,errorfunc:null,afterrestorefunc:null,restoreAfterError:true,mtype:"POST"},$.grid.inlineEdit,y);var l=false;var C=this,b,E={},x={},w={},z,i,d,s;if(!C.grid){return l}s=$(C.element).grid("getInd",j,true);if(s===false){return l}if(this.options.autoValid){var B=this.valid(s.id);if(!this.options.allowSaveOnError&&!B){$.message("请确认是否输入正确！");
return B}}z=$(s).attr("editable");y.url=y.url?y.url:C.options.editurl;y.url=y.url?y.url:"clientArray";if(z==="1"){var q;$('td[role="gridcell"]',s).each(function(o){q=C.options.colModel[o];b=q.name;if(b!="cb"&&b!="subgrid"&&q.editable===true&&b!="rn"&&!$(this).hasClass("not-editable-cell")){var F=q.edittype;switch(F){case"checkbox":var k=["Yes","No"];if(q.editoptions){k=q.editoptions.value.split(":")}E[b]=$("input",this).is(":checked")?k[0]:k[1];break;case"datepicker":E[b]=$("input[type='hidden']",this).val();break;case"autocomplete":if(typeof(q.editoptions.source)=="string"){E[b]=$(".ctrl-init-"+F,this)[F]("getText")}else{E[b]=$(".ctrl-init-"+F,this)[F]("getValue")}break;case"text":case"password":case"textarea":case"button":E[b]=$("input, textarea",this).val();break;case"combogrid":case"combobox":case"combotree":E[b]=$(".ctrl-init-"+F,this)[F]("getValues").toString();x[b]=$(".ctrl-init-"+F,this)[F]("getText");if(q.formatter&&q.formatter==F){x={}}break;case"custom":try{if(q.editoptions&&$.isFunction(q.editoptions.custom_value)){E[b]=q.editoptions.custom_value.call(C,$(".customelement",this),"get");if(E[b]===undefined){throw"e2"}}else{throw"e1"}}catch(G){if(G=="e1"){$.grid.info_dialog($.grid.errors.errcap,"function 'custom_value' "+$.grid.edit.msg.nodefined,$.grid.edit.bClose)}if(G=="e2"){$.grid.info_dialog($.grid.errors.errcap,"function 'custom_value' "+$.grid.edit.msg.novalue,$.grid.edit.bClose)}else{$.grid.info_dialog($.grid.errors.errcap,G.message,$.grid.edit.bClose)}}break}d=$.grid.checkValues(E[b],o,C);if(d[0]===false){d[1]=E[b]+" "+d[1];return false}if(C.options.autoencode){E[b]=$.grid.htmlEncode(E[b])}if(y.url!=="clientArray"&&q.editoptions){if(E[b]===""){w[b]="null"}}}});if(d[0]===false){try{var n=$.grid.findPos($("#"+$.grid.coralID(j),C.grid.bDiv)[0]);$.grid.info_dialog($.grid.errors.errcap,d[1],$.grid.edit.bClose,{left:n[0],top:n[1]})}catch(D){alert(d[1])}return l}var u,r,t;r=C.options.prmNames;t=r.oper;if(C.options.keyName===false){u=r.id}else{u=C.options.keyName
}if(E){E[t]=r.editoper;E[u]=j;if(typeof(C.options.inlineData)=="undefined"){C.options.inlineData={}}E=$.extend({},E,C.options.inlineData,y.extraparam)}if(y.url=="clientArray"){if(C.options.autoencode){$.each(E,function(k,e){E[k]=$.grid.htmlDecode(e)})}var v=$(C.element).grid("setRowData",j,E);$(s).attr("editable","0");for(var A=0;A<C.options.savedRow.length;A++){if(C.options.savedRow[A].id==j){i=A;break}}if(i>=0){C.options.savedRow.splice(i,1)}l=v;if(l){C.options.editrow=null}if(C.options.rowEditButtons){C.rowEditButtons.hide()}C._trigger("afterInlineSaveRow",null,[{rowId:j,options:y,status:v}]);if($.isFunction(y.aftersavefunc)){y.aftersavefunc.call(C,j,v)}$(s).unbind("keydown")}else{$("#lui_"+$.grid.coralID(C.options.id)).show();w=$.extend({},E,w);w[u]=$.grid.stripPref(C.options.idPrefix,w[u]);$.ajax($.extend({url:y.url,data:$.isFunction(C.options.serializeRowData)?C.options.serializeRowData.call(C,w):w,type:y.mtype,async:false,complete:function(F,G){$("#lui_"+$.grid.coralID(C.options.id)).hide();if(G==="success"){var o=true,H;H=C._trigger("inlineSuccessSaveRow",null,[{res:F,rowId:j,options:y}]);if(!$.isArray(H)){H=[true,E]}if(H[0]&&$.isFunction(y.successfunc)){H=y.successfunc.call(C,F)}if($.isArray(H)){o=H[0];E=H[1]?H[1]:E}else{o=H}if(o===true){if(C.options.autoencode){$.each(E,function(I,k){E[I]=$.grid.htmlDecode(k)})}E=$.extend({},E,x);$(C.element).grid("setRowData",j,E);$(s).attr("editable","0");for(var e=0;e<C.options.savedRow.length;e++){if(C.options.savedRow[e].id==j){i=e;break}}if(i>=0){C.options.savedRow.splice(i,1)}$(C).triggerHandler("gridInlineAfterSaveRow",[j,F,E,y]);if($.isFunction(y.aftersavefunc)){y.aftersavefunc.call(C,j,F)}l=true;C.options.editrow=null;if(C.rowEditButtons){C.rowEditButtons.hide()}C._trigger("afterInlineSaveRow",null,[{rowId:j,options:y,status:v}]);$(s).unbind("keydown")}else{$(C).triggerHandler("gridInlineErrorSaveRow",[j,F,G,null,y]);if($.isFunction(y.errorfunc)){y.errorfunc.call(C,j,F,G,null)}if(y.restoreAfterError===true){$(C.element).grid("restoreRow",j,y.afterrestorefunc)
}}}},error:function(k,o,F){$("#lui_"+$.grid.coralID(C.options.id)).hide();$(C).triggerHandler("gridInlineErrorSaveRow",[j,k,o,F,y]);if($.isFunction(y.errorfunc)){y.errorfunc.call(C,j,k,o,F)}else{try{$.grid.info_dialog($.grid.errors.errcap,'<div class="coral-state-error">'+k.responseText+"</div>",$.grid.edit.bClose,{buttonalign:"right"})}catch(G){alert(k.responseText)}}if(y.restoreAfterError===true){$(C.element).grid("restoreRow",j,y.afterrestorefunc)}}},$.grid.ajaxOptions,C.options.ajaxRowOptions||{}))}}if(l){$(s).removeClass("new-row")}return l},restoreRow:function(a,j){var l=$.makeArray(arguments).slice(1),b={};if($.type(l[0])==="object"){b=l[0]}else{if($.isFunction(j)){b.afterrestorefunc=j}}b=$.extend(true,$.grid.inlineEdit,b);var g=this,h,c,f={};if(!g.grid){return}c=$(g.element).grid("getInd",a,true);if(g.options.editrow&&a==g.options.editrow){g.options.editrow=null;g.clearErrors(a)}if(c===false){return}for(var d=0;d<g.options.savedRow.length;d++){if(g.options.savedRow[d].id==a){h=d;break}}if(h>=0){if($.isFunction($.fn.datepicker)){try{$("input.hasDatepicker","#"+$.grid.coralID(c.id)).datepicker("hide")}catch(i){}}$.each(g.options.colModel,function(){if(this.editable===true&&this.name in g.options.savedRow[h]){f[this.name]=g.options.savedRow[h][this.name]}});$(g.element).grid("setRowData",a,f);$(c).attr("editable","0").unbind("keydown");g.options.savedRow.splice(h,1);if($("#"+$.grid.coralID(a),"#"+$.grid.coralID(g.options.id)).hasClass("grid-new-row")){setTimeout(function(){$(g.element).grid("delRowData",a)},0)}}$(g).triggerHandler("gridInlineAfterRestoreRow",[a]);if($.isFunction(b.afterrestorefunc)){b.afterrestorefunc.call(g,a)}if(g.options.rowEditButtons){g.rowEditButtons.hide()}},addRow:function(b){b=$.extend(true,{rowID:"new_row",initdata:{},position:"first",useDefValues:true,useFormatter:false,addRowParams:{extraparam:{}}},b||{});if(!this.grid){return}var d=this;if(b.useDefValues===true){$(d.options.colModel).each(function(){if(this.editoptions&&this.editoptions.defaultValue){var f=this.editoptions.defaultValue,e=$.isFunction(f)?f.call(d):f;
b.initdata[this.name]=e}})}$(d.element).grid("addRowData",b.rowID,b.initdata,b.position);$("#"+$.grid.coralID(b.rowID),"#"+$.grid.coralID(d.options.id)).addClass("grid-new-row");if(b.useFormatter){$("#"+$.grid.coralID(b.rowID)+" .coral-inline-edit","#"+$.grid.coralID(d.options.id)).click()}else{var a=d.options.prmNames,c=a.oper;b.addRowParams.extraparam[c]=a.addoper;$(d.element).grid("editRow",b.rowID,b.addRowParams);$(d.element).grid("setSelection",b.rowID)}},clearEdited:function(b){var a=$(this.getInd(b,true));a.removeClass("edited");a.children("td").removeClass("dirty-cell")},inlineNav:function(a,b){b=$.extend({edit:true,editicon:"coral-icon-pencil",add:true,addicon:"coral-icon-plus",save:true,saveicon:"coral-icon-disk",cancel:true,cancelicon:"coral-icon-cancel",addParams:{useFormatter:false,rowID:"new_row"},editParams:{},restoreAfterSelect:true},$.grid.nav,b||{});return this.each(function(){if(!this.grid){return}var j=this,d,g=$.grid.coralID(j.options.id);j.options._inlinenav=true;if(b.addParams.useFormatter===true){var c=j.options.colModel,f;for(f=0;f<c.length;f++){if(c[f].formatter&&c[f].formatter==="actions"){if(c[f].formatoptions){var h={keys:false,onEdit:null,onSuccess:null,afterSave:null,onError:null,afterRestore:null,extraparam:{},url:null},e=$.extend(h,c[f].formatoptions);b.addParams.addRowParams={keys:e.keys,oneditfunc:e.onEdit,successfunc:e.onSuccess,url:e.url,extraparam:e.extraparam,aftersavefunc:e.afterSavef,errorfunc:e.onError,afterrestorefunc:e.afterRestore}}break}}}if(b.add){$(j.element).grid("navButtonAdd",a,{caption:b.addtext,title:b.addtitle,buttonicon:b.addicon,id:j.options.id+"_iladd",onClickButton:function(){$(j.element).grid("addRow",b.addParams);if(!b.addParams.useFormatter){$("#"+g+"_ilsave").removeClass("coral-state-disabled");$("#"+g+"_ilcancel").removeClass("coral-state-disabled");$("#"+g+"_iladd").addClass("coral-state-disabled");$("#"+g+"_iledit").addClass("coral-state-disabled")}}})}if(b.edit){$(j.element).grid("navButtonAdd",a,{caption:b.edittext,title:b.edittitle,buttonicon:b.editicon,id:j.options.id+"_iledit",onClickButton:function(){var i=$(j.element).grid("getGridParam","selrow");
if(i){$(j.element).grid("editRow",i,b.editParams);$("#"+g+"_ilsave").removeClass("coral-state-disabled");$("#"+g+"_ilcancel").removeClass("coral-state-disabled");$("#"+g+"_iladd").addClass("coral-state-disabled");$("#"+g+"_iledit").addClass("coral-state-disabled")}else{$.grid.viewModal("#alertmod",{gbox:"#gbox_"+g,jqm:true});$("#jqg_alrt").focus()}}})}if(b.save){$(j.element).grid("navButtonAdd",a,{caption:b.savetext||"",title:b.savetitle||"Save row",buttonicon:b.saveicon,id:j.options.id+"_ilsave",onClickButton:function(){var k=j.options.savedRow[0].id;if(k){var i=j.options.prmNames,l=i.oper;if(!b.editParams.extraparam){b.editParams.extraparam={}}if($("#"+$.grid.coralID(k),"#"+g).hasClass("grid-new-row")){b.editParams.extraparam[l]=i.addoper}else{b.editParams.extraparam[l]=i.editoper}if($(j.element).grid("saveRow",k,b.editParams)){$(j.element).grid("showAddEditButtons")}}else{$.grid.viewModal("#alertmod",{gbox:"#gbox_"+g,jqm:true});$("#jqg_alrt").focus()}}});$("#"+g+"_ilsave").addClass("coral-state-disabled")}if(b.cancel){$(j.element).grid("navButtonAdd",a,{caption:b.canceltext||"",title:b.canceltitle||"Cancel row editing",buttonicon:b.cancelicon,id:j.options.id+"_ilcancel",onClickButton:function(){var i=j.options.savedRow[0].id;if(i){$(j.element).grid("restoreRow",i,b.editParams);$(j.element).grid("showAddEditButtons")}else{$.grid.viewModal("#alertmod",{gbox:"#gbox_"+g,jqm:true});$("#jqg_alrt").focus()}}});$("#"+g+"_ilcancel").addClass("coral-state-disabled")}if(b.restoreAfterSelect===true){if($.isFunction(j.options.beforeSelectRow)){d=j.options.beforeSelectRow}else{d=false}j.options.beforeSelectRow=function(l,k){var i=true;if(j.options.savedRow.length>0&&j.options._inlinenav===true&&(l!==j.options.selrow&&j.options.selrow!==null)){if(j.options.selrow==b.addParams.rowID){$(j.element).grid("delRowData",j.options.selrow)}else{$(j.element).grid("restoreRow",j.options.selrow,b.editParams)}$(j.element).grid("showAddEditButtons")}if(d){i=d.call(j,l,k)}return i}}})},showAddEditButtons:function(){return this.each(function(){if(!this.grid){return
}var a=$.grid.coralID(this.options.id);$("#"+a+"_ilsave").addClass("coral-state-disabled");$("#"+a+"_ilcancel").addClass("coral-state-disabled");$("#"+a+"_iladd").removeClass("coral-state-disabled");$("#"+a+"_iledit").removeClass("coral-state-disabled")})}});