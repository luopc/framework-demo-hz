/*!
 * 组件库4.0：下拉框
 * 
 * 依赖JS文件：
 *    jquery.coral.core.js
 *    jquery.coral.component.js
 *    jquery.coral.panel.js
 *    jquery.validatehelper.js
 *    jquery.coral.control.js
 */
(function(){$(document).unbind(".coral-combobox").bind("mousedown.coral-combobox mousewheel.coral-combobox",function(g){var f=$(g.target).closest(".coral-combo-panel").length;var h=$(g.target).closest(".coral-combo").length;var d=$(g.target).closest(".coral-button").length;if(f||(h&&!d)){return}a()});function a(b,c){$(".coral-combo-wrapper").not(b).hide();$(".coral-combo-iframePanel:visible").not(c).hide()}$.component("coral.combo",$.coral.inputbase,{castProperties:["triggers"],version:"4.0.2",options:{panelRenderOnShow:false,popupDialog:false,showStar:true,showDirection:"down",labelField:null,starBefore:false,isInited:false,id:null,name:null,showOnFocus:true,iframePanel:false,buttons:[],forceSelection:true,width:"auto",height:22,placeholder:"",cls:"",required:false,errMsg:null,errMsgPosition:"leftBottom",isLabel:false,panelWidth:null,panelHeight:"auto",panelComponentCls:"",position:{my:"left top",at:"left bottom",collision:"none"},maxPanelHeight:200,multiple:false,separator:",",valueTextSeparator:"-",postMode:"value",editable:false,readonly:false,readonlyInput:true,disabled:false,clearOnLoad:true,hasArrow:true,value:"",text:"",delay:200,zIndex:10000,enableHighlight:false,enablePinyin:false,showClose:false,enableFilter:false,enterFilter:true,query:null,filter:function(g,i){var d=$(this).attr("component-role"),e=$(this)[d]("option"),b=e.textField,c=e.valueField,h=(i[b]).toLowerCase(),f=(i[c]).toString().toLowerCase();g=g.toLowerCase();if(h.indexOf(g)>-1){return"text"}if(e.enablePinyin===true){if(pinyinEngine.toPinyin(h,false,"").indexOf(g)>-1){return true}}if(f.indexOf(g)>-1){return true}else{return false}},onKeyUp:null,onKeyDown:null,onEnter:null,onBlur:null,onClick:null,onValidError:null,onValidSuccess:null,onShowPanel:$.noop,onHidePanel:$.noop,onChange:$.noop,triggers:null,excluded:false},_addCacheItem:function(b){if(typeof b!=="object"){return
}if(typeof this.cache==="undefined"){this.cache={}}this.cache=$.extend({},this.cache,b)},_getCacheItem:function(b){if(typeof b!=="string"){return}if(this.cache&&this.cache[b]){return this.cache[b]}else{return null}},_removeCacheItem:function(b){if(this.cache&&this.cache[b]){delete this.cache[b]}},_create:function(){this._prepareInit();this._initCombo();this._setDefaultValue();this._initState();this._initData();this._bindEvent()},_prepareInit:function(){this.originalCss={display:this.element[0].style.display,width:this.element[0].style.width,minHeight:this.element[0].style.minHeight,maxHeight:this.element[0].style.maxHeight,height:this.element[0].style.height};this.panelRendered=false;this.dataLoaded=false;this.search=false;this.isInit=false;this.isLoaded=false;this.isInited=false;this.currentValues=[];this.cache={};if(this.options.enableSearch===true){this.options.readonlyInput=false}if(this.options.popupDialog||this.options.enableFilter){this.options.readonlyInput=true}this.element.hide();if(this.element.attr("id")){if(this.element.attr("id")!=this.options.id){this.options.id=this.element.attr("id")}}else{if(this.options.id){this.element.attr("id",this.options.id)}}if(!this.element.attr("id")){this.options.id=this.element.uniqueId().attr("id")}if(this.element.attr("name")&&this.options.name){if(this.element.attr("name")!=this.options.name){this.options.name=this.element.attr("name")}}else{if(!this.options.name&&this.element.attr("name")){this.options.name=this.element.attr("name")}}if(this.element.attr("value")&&this.options.value){if(this.element.attr("value")!=this.options.value){this.options.value=this.element.attr("value")}}else{if(!this.options.value&&this.element.attr("value")){this.options.value=this.element.attr("value")}}},_initCombo:function(){var d=null,c=null,f="",e="",b="";this.uiCombo={combo:null,panel:null};this.previousValue=null;this.uiCombo.combo=$("<span class='coral-combo coral-textbox'></span>").insertAfter(this.element);this.element.appendTo(this.uiCombo.combo);
if(this.options.hasArrow==true){if(this.options.showDirection=="down"){b="<span class='coral-combo-arrow coral-icon-arrow cui-icon-arrow-down3'></span>"}if(this.options.showDirection=="up"){b="<span class='coral-combo-arrow coral-icon-arrow cui-icon-arrow-up3'></span>"}}if(this.options.showClose&&!this.options.required){f="<span class='coral-input-clearIcon cui-icon-cross2'></span>"}this.elementBorder=$("<span class='coral-combo-border coral-textbox-border coral-corner-all'>"+f+b+"</span>").appendTo(this.uiCombo.combo);if(this.options.labelField){this.uiLabel=$('<label class="coral-label">'+this.options.labelField+"</label>");this.elementBorder.before(this.uiLabel);this.uiCombo.combo.addClass("coral-hasLabel")}this.uiCombo.textbox=$("<input type='text' autocomplete='off' class='coral-combo-text coral-combo-default coral-textbox-default tabbable'>").appendTo(this.elementBorder);if(this.options.name){this.element.removeAttr("name").attr("orgname",this.options.name);e=" name='"+this.options.name+"'"}c=$("<input type='hidden' "+e+" class='coral-combo-value'>").appendTo(this.uiCombo.combo);this.uiCombo.panel=$("<div class='coral-combo-panel "+this.options.panelComponentCls+"'></div>").appendTo("body");if(this.options.iframePanel){this.uiCombo.iframePanel=$("<iframe class='coral-combo-iframePanel' style='position:absolute;display:none;'></iframe>").appendTo("body")}this.uiCombo.pContent=$("<div class='coral-combo-content'></div>").appendTo(this.uiCombo.panel);if(this.options.enableFilter){$("<div class='coral-combo-filter'><span class='coral-combo-filter-border'><input type='text' class='coral-combo-filterbox'></span><span class='coral-combo-search cui-icon-search2'></span></div>").appendTo(this.uiCombo.panel)}var g="absolute";if(this.options.popupDialog){g="";this.uiCombo.popupDialog=$("<div class='coral-combo-popup-dialog'></div>").appendTo("body");this.uiCombo.popupInputbox=$("<input type='text' />").appendTo(this.uiCombo.popupDialog)}if(this.options.hasArrow==false){this.elementBorder.css({"padding-right":0});
this.uiCombo.textbox.css({"padding-right":0});this.uiClose().css({right:0})}this.uiCombo.panel.css({position:g}).addClass("coral-combo-wrapper "+this.options.cls+"-panel coral-front").hide();this.uiCombo.textbox.attr("placeholder",this.options.placeholder);this._showPlaceholder();if(this.options.buttons.length>0){this._createButtonPanel()}},_initState:function(){this.options.isLabel===true?this._setIsLabel(this.options.isLabel):this._setReadonly(this.options.readonly);if(!this.options.readonly){this.uiCombo.textbox.prop("readonly",this.options.readonlyInput)}this._setDisabled(this.options.disabled);this.resize()},_initData:$.noop,_setDefaultValue:function(){if(!this.options.value){this.originalValue="";return}else{this.setValue(this.options.value);this.originalValue=this.getValue()}},_showPlaceholder:function(c){if($.support.placeholder||this.component().find(".coral-textbox-placeholder-label").length){return}c=c?c:this.options.placeholder;var b=$("<span class='coral-textbox-placeholder-label'>"+c+"</span>");$(this.uiCombo.textbox).after(b)},_hidePlaceholder:function(){if($.support.placeholder){return}this.component().find(".coral-textbox-placeholder-label").remove()},_setIsLabel:function(b){var c=this;if(true===b){this.component().removeClass("coral-readonly");this.component().addClass("coral-isLabel");this.uiCombo.textbox.prop("readonly",true);if(this.options.emptyText&&""===this.getValue()){this.uiCombo.textbox.val("")}this.hidePanel();this.uiCombo.textbox.removeAttr("placeholder")}else{this.component().removeClass("coral-isLabel coral-readonly");this.uiCombo.textbox.prop("readonly",this.options.readonlyInput);this.options.readonly=false;this.uiCombo.textbox.attr("placeholder",this.options.placeholder)}this.options.isLabel=!!b},_setReadonly:function(b){if(b){this.element.prop("readonly",true);this.uiCombo.textbox.prop("readonly",true);this.uiCombo.combo.find(".coral-combo-value").prop("readonly",true)}else{$(this.element).prop("readonly",false);this.uiCombo.textbox.prop("readonly",false);
this.uiCombo.combo.find(".coral-combo-value").prop("readonly",false)}this.options.readonly=!!b;this.uiCombo.combo.removeClass("coral-isLabel");this.uiCombo.combo.toggleClass("coral-readonly",this.options.readonly)},_setDisabled:function(b){if(b){this.element.prop("disabled",true);this.uiCombo.combo.find(".coral-combo-value").prop("disabled",true);this.uiCombo.combo.find(".coral-combo-text").prop("disabled",true)}else{$(this.element).prop("disabled",false);this.uiCombo.combo.find(".coral-combo-value").prop("disabled",false);this.uiCombo.combo.find(".coral-combo-text").prop("disabled",false)}this.options.disabled=!!b;this.uiCombo.combo.toggleClass(this.componentFullName+"-disabled coral-state-disabled",this.options.disabled)},_selectPrev:$.noop,_selectNext:$.noop,_doEnter:$.noop,_doQuery:$.noop,_addHighlight:function(c,b){if(b===""||!c.length||!this.options.enableHighlight){return}c=$(c);var e="",f=b.replace(/[\s]+/g," ").split(" "),d;c.each(function(h,j){var g=$(j),k=$(j).parent(),i=$(j).html();if(i==b){return}if(g.hasClass(".coral-combobox-item-selected")){k.html(that._getTextFromHTML(i));return}if(!g.children("input").length){for(var l=0;l<f.length;l++){d=new RegExp(""+f[l]+"","gmi");i=i.replace(d,'<span class="coral-keyword-highlight">'+f[l]+"</span>")}g.html(i)}})},_getTextFromHTML:function(b){if(typeof b==="undefined"){return}b=b.replace(/<\/?[^>]*>/g,"");b=b.replace(/[ | ]*\n/g,"\n");b=b.replace(/&nbsp;/ig,"");return b},_clearValues:function(h){var e=this.options.valueField,c=this.currentValues,g=c.length,f,d,b=0;for(f=0;f<g;f++){for(d=0;d<h.length;d++){if(c[f]==h[d][e]){b+=1;break}}}if(b!=g){return true}else{return false}},_removeHighlight:function(b){if(!b.length||!this.options.enableHighlight){return}b=$(b);var c=this;b.each(function(d,f){var g=$(f).parent();var e=g.html();g.html(c._getTextFromHTML(e))})},focus:function(){var c=this;if(this.options.disabled||this.options.readonly||this.options.isLabel){return false}this.uiCombo.textbox.focus();if(!this.dataLoaded){var b={focus:{param:null}};
this._addCacheItem(b);return true}return true},_bindEvent:function(){var f=this,e=this.options,h=this.uiCombo.combo,b=this.uiCombo.panel,g=this.uiCombo.iframePanel;if(this.options.disabled){this.element.addClass("coral-state-disabled")}this._off(f.component());var c,d;this._on({"mouseenter.coral-combo-border":function(i){if(f.component().hasClass("coral-isLabel")||f.component().hasClass("coral-readonly")){return}f.uiCombo.combo.addClass("coral-textbox-hover");this._updateTitle()},"mouseleave.coral-combo-border":function(i){if(f.component().hasClass("coral-isLabel")||f.component().hasClass("coral-readonly")){return}f.uiCombo.combo.removeClass("coral-textbox-hover")},"keydown.coral-combo-text":function(i){this._doKeyDown(i,false)},"keyup.coral-combo-text":function(i){if(this.options.readonly||this.options.isLabel){return}this._trigger("onKeyUp",i,{})},"blur.coral-combo-text":function(i){this._setHv(i,"blur")},"focusin.coral-combo-text":function(i){if(this.options.readonly||this.options.isLabel){return}this.component().addClass("coral-state-focus");if(!c){this._trigger("onFocus",i)}},"focusout.coral-combo-text":function(i){if(this.cancelBlur){delete this.cancelBlur;return}if(this.options.readonly||this.options.isLabel){return}this._delay(function(){if(c){c=false;return}this.component().removeClass("coral-state-focus");if(d){d=false;return}this.hidePanel();this._trigger("onBlur",i)},100)},"click.coral-combo-text":function(i){if(f.component().hasClass("coral-isLabel")||f.component().hasClass("coral-readonly")){if(this.options.hasArrow==true&&!this.options.readOnlyInput){return}}if(f.component().hasClass("coral-state-focus")){if(this.options.popupDialog&&this.options.showOnFocus===true){this.uiCombo.popupDialog.dialog("open")}else{if(b.is(":visible")){this.hidePanel()}else{this.showPanel()}}}if(this.options.enableFilter){d=true}f._trigger("onClick",i)},"mousedown.coral-combo-arrow":function(i){if(this.component().hasClass("coral-isLabel")||this.component().hasClass("coral-readonly")){return
}if(this.component().hasClass("coral-state-focus")){c=true}},"click.coral-combo-arrow":function(i){a(b,g);if(f.component().hasClass("coral-isLabel")||f.component().hasClass("coral-readonly")){return}if(f.component().hasClass("coral-state-focus")){c=true}if(this.options.enableFilter){d=true}this.focus();if(f.options.popupDialog){f.uiCombo.popupDialog.dialog("open")}else{if(b.is(":visible")){f.hidePanel()}else{f.showPanel()}}},"click.coral-input-clearIcon":function(i){if(this.component().hasClass("coral-state-focus")){c=true}this.clear();if(this.options.placeholder){this._showPlaceholder()}},combogridonshowpanel:function(i){f._removeGridHighlights();f._scrollTo(f.getValue());f.grid().grid("refresh")}});this._on(this.uiCombo.panel.find(".coral-combo-filterbox"),{keydown:function(i){this._doKeyDown(i,true)}});this._on(this.uiCombo.panel.find(".coral-combo-search"),{click:function(i){i.preventDefault();this._filter(i,true);return false}});this._on(this.uiCombo.panel.find(".coral-combo-filterbox"),{focusout:function(i){this._delay(function(){this.hidePanel()},100)}})},_updateTitle:function(){var b=$("<span style = 'visibility: hidden'>"+this.getText()+"</span>").appendTo("body");if(this.component().outerWidth()<b.width()){this.component().attr("title",this.getText())}b.remove()},_doKeyDown:function(g,c){var d=this.options,b=this.panel();this.previousValue=$(g.target).val();if(d.readonly||d.isLabel){return}var f=$.coral.keyCode;switch(g.keyCode){case f.TAB:break;case f.ENTER:g.preventDefault();this._doEnter(g);this._setHv(g);this._trigger("onEnter",g,{});break;case f.ESCAPE:this.hidePanel();break;case f.UP:g.preventDefault();if(d.readonly===false){if(!b.is(":visible")){this.showPanel()}else{if(d.onSelectPrev){this._trigger("onSelectPrev",g)}else{this._selectPrev(g)}}}break;case f.DOWN:g.preventDefault();if(d.readonly===false){if(!b.is(":visible")){this.showPanel()}else{if(d.onSelectNext){this._trigger("onSelectNext",g)}else{this._selectNext(g)}}}break;default:this._filter(g,c);
break}this._hidePlaceholder();this._trigger("onKeyDown",g)},_setHv:function(h,d){var i=$(h.target),c=[],b=i.val();if(this.options.multiple){b=b.split(this.options.separator)}else{b=[b]}this._showItems();var g=true;if(d=="blur"){g=b.toString()!=this.previousValue}if(g){var f=this.options.textField,k=this.options.valueField;var j=this._checkMathch(b,true);if(!j){i.val("");this.setValues([""])}else{this.setValues(j.valarr)}}},_searchFilter:$.noop,_filter:function(g,c){var f=this,d=this.options,b=this.panel();if(f.timer){clearTimeout(f.timer)}if(!b.is(":visible")){f.showPanel()}f.timer=setTimeout(function(){var j=$(g.target).val();if(c){j=b.find(".coral-combo-filterbox").val()}if(f.options.multiple){j=j.split(d.separator)}else{j=[j]}if(j==f.previousValue){return}if(d.query){d.query.call(f.element,j)}else{f.search=true;f._doQuery(j)}var i=f.options.textField,h=f.options.valueField;if(!c){var e=f._checkMathch(j,false);f.setValues(e.valarr,false,true)}f.resizeIframePanel()},d.delay);return false},_formatValue:function(b){return b},_setOption:function(b,c){if(b==="id"||b==="name"){return}if(b==="readonly"){this._setReadonly(c)}if(b==="disabled"){this._setDisabled(c)}if(b==="data"){this.data=c}this._super(b,c);if(b==="isLabel"){this._setIsLabel(c);return}},_destroy:function(){this.panel().remove();if(this.options.iframePanel){this.uiCombo.iframePanel.remove()}this.component().replaceWith(this.element);if(this.options.name){this.element.removeAttr("orgname").attr("name",this.options.name)}this.element.show();this.element.css(this.originalCss)},component:function(){return this.uiCombo.combo},panel:function(){return this.uiCombo.panel},uiArrow:function(){return this.uiCombo.combo.find("span.coral-combo-arrow")},uiClose:function(){return this.uiCombo.combo.find("span.coral-input-clearIcon")},uiBorder:function(){return this.component().find("span.coral-combo-border")},resize:function(f){var g=this.options,h=this.uiCombo.combo,d=this.uiCombo.panel,c=this.elementBorder;if(f){g.width=f
}if(g.width=="auto"||g.width=="item"){return}if(isNaN(g.width)){var e=this.element.parent(":first"),b=null;f=this.element.outerWidth();if(e&&e.get(0).tagName!=="BODY"){b=e.outerWidth();if(b<f){f=b}}g.width=f}h.outerWidth(g.width)},resizeIframePanel:function(){var d=this.options,b,f=this.uiCombo.combo,c=this.uiCombo.panel,e=this.uiCombo.iframePanel||$();b=c.height();e.css("height",b)},_initPanel:function(){var e=this.options,f=this.uiCombo.combo,c=this.elementBorder,b=this.uiCombo.panel,d=e.panelHeight;if(!this.panelRendered){this._renderItems(this.options.data);this.uiCombo.pContent.html(this.lazyPanelHtml);this.panelRendered=true;this.lazyPanelHtml=""}b.css("width",(e.panelWidth?e.panelWidth:c.outerWidth()));b.css("height",d);if(isNaN(d)){this.uiCombo.pContent.css({"max-height":e.maxPanelHeight+"px"});this.uiCombo.popupDialogTree&&this.uiCombo.popupDialogTree.css({"max-height":e.maxPanelHeight+"px"})}if(this.options.enableFilter&&!isNaN(d)){this.uiCombo.pContent.height(e.panelHeight-30)}else{if(d=="auto"){this.uiCombo.pContent.height("")}else{this.uiCombo.pContent.height(d-2)}}if(this.options.iframePanel){this.uiCombo.iframePanel.css("height",b.outerHeight())}},showPanel:function(){var g=this,b=this.options,d=this.uiCombo.combo,f=this.elementBorder,j=this.options.showDirection,c=this.uiCombo.panel,e=this.uiCombo.iframePanel||$();if(c.is(":hidden")){var i=$(".coral-front:visible").map(function(){return +$(this).css("z-index")}).get(),h=Math.max.apply(null,i);if(h>=+c.css("z-index")){c.css("z-index",h+1);if(this.options.iframePanel){e.css("z-index",h)}}if(!this._PanelInited){this._initPanel()}this._PanelInited=true;c.show(0,function(){g.resizeIframePanel();e.show();(function k(){if(c.is(":visible")){c.css({left:$.coral.getLeft(c,f),top:$.coral.getTop(c,f,j),width:(b.panelWidth?b.panelWidth:f.outerWidth())});if(g.options.iframePanel){e.css({left:$.coral.getLeft(e,f),top:$.coral.getTop(e,d,j),width:(b.panelWidth?b.panelWidth:f.outerWidth())})}setTimeout(k,200)}})();g.uiCombo.panel.find(".coral-combo-filterbox").focus();
g._trigger("onShowPanel",null,{})})}if(b.enableFilter){this.setValues(this.getValues())}},hidePanel:function(){this.uiCombo.panel.hide();if(this.uiCombo.iframePanel){this.uiCombo.iframePanel.hide()}this._trigger("onHidePanel",null,{})},disable:function(){this._setDisabled(true)},enable:function(){this._setDisabled(false)},show:function(){this._super()},hide:function(){this._super();this.hidePanel()},hideErrors:function(){$.validate.hideErrors(this.uiBorder());this.component().removeClass("coral-combo-error")},clear:function(){this.setValues([],true,false)},getOldText:function(){return this.oldText},reset:function(){this.setValue(this.originalValue)},getText:function(){return this.uiCombo.combo.find("input.coral-combo-text").val()},_setText:function(b){var c=this.uiCombo.combo.find("input.coral-combo-text");c.val(b);this.previousValue=b},setText:function(b){this._setText(b)},getValues:function(){var b=[];if(!this.dataLoaded){return this.currentValues}this.uiCombo.combo.find("input.coral-combo-value").each(function(){b.push($(this).val())});return b},setValues:function(b,h,g){var t=this.getValues(),k=null,l=this.options,p=0,f=[],e=[];b=b||[];this.oldValues=t;var r=[],u="",n="";this.uiCombo.combo.find("input.coral-combo-value").remove();for(p=0;p<b.length;p++){u="";n="";if(this.options.name){u=" name='"+this.options.name+"' "}r.push("<input type='hidden' "+u+" value='"+this._formatValue(b[p])+"' class='coral-combo-value' />")}this.uiCombo.combo.append(r.join(""));for(p=0;p<t.length;p++){f[p]=t[p]}for(p=0;p<b.length;p++){for(var o=0;o<f.length;o++){if(b[p]==f[o]){e.push(b[p]);f.splice(o,1);break}}}if(b.length){if(this.options.placeholder){this._hidePlaceholder()}}if(l.width=="item"){var c=$("<div style = 'visibility:hidden;'><span>"+this.getText()+"</span></div>").appendTo("body"),d=this.component().find(".coral-textbox-default");var s=parseInt(d.css("padding-left"))+parseInt(d.css("padding-right")),q=this.uiArrow().outerWidth()+2*parseInt(this.uiArrow().css("right")),m=c.find("span").outerWidth()+s+q;
this.resize(m);c.remove();l.width="item"}if((e.length!=b.length||b.length!=t.length)&&(!g)&&h){if(this.options.multiple){this._trigger("onChange",null,{value:b,newValue:b,newText:this.getText(),text:this.getText(),oldValue:t,oldText:this.getOldText()})}else{this._trigger("onChange",null,{value:b[0],newValue:b[0],newText:this.getText(),text:this.getText(),oldValue:t[0],oldText:this.getOldText()})}}},getValue:function(){return this.getValues().join(this.options.separator)},setValue:function(d,b,c){d=d||"";d=d.split(this.options.separator);this.setValues(d,b)},getSelectedItems:function(){var e=this.getValues(),h=[];var c=this.options.data;for(var d=0;d<e.length;d++){for(var b=0;b<c.length;b++){var g=c[b];if(e[d]==g.id){for(var f in g){h.push(f+"="+g[f]+"\n")}}}}return h},refresh:function(){this.destroy();this.component().remove();this._create()}})})();