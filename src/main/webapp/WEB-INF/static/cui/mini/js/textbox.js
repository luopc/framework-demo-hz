$.component("coral.textbox",$.coral.inputbase,{version:$.coral.version,castProperties:["dataCustom","title","buttons","buttonOptions","triggers"],options:{swfPath:$.coral.contextPath+"/jquery-cui/resource/swfupload.swf",hasTips:false,showStar:true,showClose:false,dataCustom:null,value:"",readonly:false,readonlyInput:false,disabled:false,required:false,isLabel:false,title:null,buttons:[],useHiddenInput:true,errMsg:null,errMsgPosition:"leftBottom",placeholder:"",type:"text",labelField:null,starBefore:false,valueChangedOnKeyUp:false,onClick:null,onChange:null,onBlur:null,onFocus:null,onKeyDown:null,onKeyUp:null,onKeyPress:null,onEnter:null,onMouseEnter:null,onMouseLeave:null,onCreate:null,onValidSuccess:null,onValidError:null,onValidWarn:null,onUploadSuccess:null,buttonOptions:null,triggers:null,excluded:false},button:function(){if(null!==this.options.buttonOptions){return this.$button}},component:function(){return this.uiTextbox},focus:function(){if(this.options.disabled||this.options.isLabel||this.options.readonly||this.options.readonlyInput){return false}if("hidden"==this.element.attr("type")){return}var a=this;this.element.focus();return true},_create:function(){var a=this;if(a.options.hasTips){a.options.title=true}if("hidden"!==this.element.attr("type")&&"file"!==this.element.attr("type")&&"password"!==this.element.attr("type")&&"text"!==this.element.attr("type")&&"INPUT"==this.element[0].tagName.toUpperCase()){this.element.attr("type","text")}this.element.addClass("ctrl-form-element");if(this.options.dataCustom){this.element.attr("data-custom",this.options.dataCustom)}this._initElement();this.setValue(this.element.val(),false);this.originalValue=this.getValue();this._bindEvents();if(null!==this.options.buttonOptions){this._outerButtons()}a._trigger("onCreate",null,[])},_getButtonEl:function(){return $("<button type='button'></button>").addClass("coral-textbox-button")},reset:function(){this.setValue(this.originalValue)},_initSimple:function(){var a=this,b=a.element.uniqueId().attr("id")
},_initUpload:function(){var a=this,b=a.element.uniqueId().attr("id");a.select=[];$(this.element).wrap('<span class="coral-file-default"></span>').before("<span class='coral-file'>请选择...</span>").before("<div id='"+b+"_upload'></div>").before("<div id='"+b+"_queue'></div>").hide();a.uploader=$("#"+b+"_upload");a.uploader.uploadify({swf:this.options.swfPath,uploader:a.options.uploadUrl,queueID:b+"_queue",height:"28",width:"800",buttonText:"浏览",onDialogOpen:function(){a.select=[]},onDialogClose:function(){},onSelect:function(c){a.select.push(c.name);a.uiTextbox.find(".coral-file").html(a.select.join(","));a.uiTextbox.find("object").attr("title",a.select.join(","))},onCancel:function(c){},onQueueComplete:function(c){setTimeout(function(){$("#"+b+"_queue").dialog("close");a.select=[]},3500)},onUploadSuccess:function(d,e,c){a._trigger("onUploadSuccess",null,[{file:d,data:e,response:c}])},auto:false});$("#"+b+"_queue").dialog({autoOpen:false,modal:false,resizable:false,onOpen:function(){a.uploader.uploadify("upload","*")}})},upload:function(a){var b=this;var c=b.element[0].id;if(this.select.length===0){return}$("#"+c+"_queue").dialog("open")},cancel:function(a){this.uploader.uploadify("cancel")},clear:function(a){this.select=[];this.uiTextbox.find(".coral-file").html("请选择...");this.uiTextbox.find("object").attr("title","请选择...");this.uploader.uploadify("cancel")},_getIcon:function(e){var a=[];if(typeof e==="undefined"||e==null||e==""){return[]}if(typeof e=="object"){for(var d in e){var f={};f[e[d].icon]=e[d].click;a.push(f)}}else{var c=$.trim(e).split(",");for(var d in c){var b=c[d].split(" ");var f={};f[b[0]]=b[1];a.push(f)}}return a},_triggerClick:function(a,c,d){var b=this;var e=$.coral.toFunction(a);c=$.Event(c);return e.apply(b.element[0],[c].concat(d))},_updateLabel:function(a){this.uiLabel.html(a)},_initElement:function(){var f=this,b=null,c=f.options;this.uiTextbox=$('<span class="coral-textbox"><span class="coral-textbox-border coral-corner-all"></span></span>').insertAfter(f.element);
f.elementBorder=f.uiTextbox.find(".coral-textbox-border");f.element.appendTo(f.elementBorder);f.element.addClass("coral-textbox-default coral-validation-textbox tabbable");if(this.options.buttons.length>0){this._createButtonPanel()}if(c.labelField){this.uiLabel=$('<label class="coral-label">'+c.labelField+"</label>");this.elementBorder.before(this.uiLabel);this.uiTextbox.addClass("coral-hasLabel")}if(this.options.useHiddenInput){this.valuebox=$("<input type='hidden' class='coral-value-textbox'>").appendTo(this.uiTextbox)}else{this.valuebox=this.element}if("hidden"==this.element.attr("type")){f.uiTextbox.hide()}if("TEXTAREA"==this.element[0].tagName){f.component().addClass("coral-textbox-textarea")}if("file"==f.element.attr("type")){if("uploadify"==f.options.formatter){f._initUpload()}if("simple"==f.options.formatter||typeof f.options.formatter=="undefined"){f._initSimple()}}var a=[],e=null;if((a=f._getIcon(f.options.icons)).length!=0){e=true}else{if((a=f._getIcon(f.options.texticons)).length!=0){e=false}}if(e!=null){this.uiDialogButtonPanel=$('<span class="coral-textbox-btn-icons coral-corner-right"></span>');f.elementBorder.append(this.uiDialogButtonPanel);for(var d in a){$.each(a[d],function(g,i){var h=$('<span class="coral-textbox-btn-ico icon"></span>');if(e){h.addClass(g)}else{h.addClass("coral-textbox-btn-textico").html(g)}h.bind("click"+f.eventNamespace,function(j){if(f.options.disabled){return}f._triggerClick(i,j,[{value:f.element.val()}])});f.uiDialogButtonPanel.append(h)})}this.rightPos=this.uiDialogButtonPanel.outerWidth()}if(typeof this.element.attr("id")!="undefined"){this.options.id=this.element.attr("id")}else{if(this.options.id){this.element.attr("id",this.options.id)}}if(typeof this.element.attr("name")!="undefined"){this.options.name=this.element.attr("name")}else{if(this.options.name){this.element.attr("name",this.options.name)}}if("TEXTAREA"===this.element[0].tagName){if($.trim(this.element.text())!==""){this.options.value=this.element.text()}else{if(this.options.value){this.element.text(this.options.value)
}}}else{if($.trim(this.element.val())!==""){this.options.value=this.element.val()}else{if(this.options.value){this.element.val(this.options.value)}}}if(c.width!==""&&c.width!==undefined){this.uiTextbox.css("width",c.width)}if(c.height!==""&&c.height!==undefined){this._setOption("height",c.height)}if(c.readonlyInput){this._setReadonlyInput()}if(c.readonly){this._setReadonly()}if(typeof c.isLabel=="boolean"&&c.isLabel){this._setReadonly();this.options.readonly=true;this.component().addClass("coral-isLabel");return}if(typeof c.disabled==="boolean"&&c.disabled){this._setOption("disabled",c.disabled)}if(this.options.showClose){this.uiClose=$("<span class='coral-textbox-close cui-icon-cross2'></span>");this.elementBorder.append(this.uiClose);this.uiClose.css("right",this.rightPos?this.rightPos:0)}this.element.attr("placeholder",c.placeholder);if(c.placeholder&&""===this.element.val()){this._showPlaceholder()}this._updateTitle();this._refresh()},_setReadonlyInput:function(){if(typeof this.element.attr("readonly")!="undefined"){this.options.readonlyInput=this.element.prop("readonly")}else{if(this.options.readonlyInput){this.element.prop("readonly",this.options.readonlyInput)}}if(this.element.prop("readonly")){this.component().addClass("coral-readonlyInput")}},_setReadonly:function(){this.options.readonlyInput=true;this._setReadonlyInput();this.component().removeClass("coral-readonlyInput").addClass("coral-readonly")},_updateTitle:function(){var b=this,a=this.options;if(a.title==true){b.element.attr("title",b.element.val())}else{if(a.title==false){b.element.attr("title","")}else{b.element.attr("title",a.title)}}},_showPlaceholder:function(){if($.support.placeholder){return}var b=this,a=$("<span class='coral-textbox-placeholder-label'>"+b.options.placeholder+"</span>");$(b.element).after(a)},_hidePlaceholder:function(){if($.support.placeholder){return}var a=this;a.uiTextbox.find(".coral-textbox-placeholder-label").remove()},_bindEvents:function(){var c=this,b=this.options;var a;
this._on({"mouseenter.coral-textbox-border":function(d){if(typeof b.isLabel=="boolean"&&b.isLabel){return}if(typeof b.readonly=="boolean"&&b.readonly){return}c.component().addClass("coral-textbox-hover");this._trigger("onMouseEnter",d,[])},"mouseleave.coral-textbox-border":function(d){if(typeof b.isLabel=="boolean"&&b.isLabel){return}if(typeof b.readonly=="boolean"&&b.readonly){return}c.component().removeClass("coral-textbox-hover");this._trigger("onMouseLeave",d,[])},click:function(d){c._hidePlaceholder();this._trigger("onClick",d,[])},"click.coral-textbox-placeholder-label":function(d){c._hidePlaceholder();c.element.focus()},dblclick:function(d){this._trigger("onDblClick",d,[])},blur:function(d){this.component().removeClass("coral-state-focus");if(""===this.element.val()){this._showPlaceholder()}if(a){a=false;return}this.setValue(this.element.val(),true);this._trigger("onBlur",d,[])},focusin:function(d){if(b.isLabel||b.readonly||b.readonlyInput){this._trigger("onFocus",d,[{value:this.valuebox.val(),text:this.element.val()}]);return}this.component().addClass("coral-state-focus");this._trigger("onFocus",d,[{value:this.valuebox.val(),text:this.element.val()}])},keydown:function(d){if(b.isLabel||b.readonly||b.readonlyInput){return}this._trigger("onKeyDown",d,[{value:this.valuebox.val(),text:this.element.val(),id:this.options.id}]);if(d.keyCode==13){this.setValue(this.element.val(),true);this._trigger("onEnter",d,[{value:this.valuebox.val(),text:this.element.val()}])}this._hidePlaceholder()},keypress:function(d){if(b.isLabel||b.readonly||b.readonlyInput){return}this._trigger("onKeyPress",d,[{value:this.valuebox.val(),text:this.element.val()}])},keyup:function(d){if(b.isLabel||b.readonly||b.readonlyInput){return}if(this.options.valueChangedOnKeyUp){this.setValue(this.element.val(),true,false)}this._trigger("onKeyUp",d,[{value:this.valuebox.val(),text:this.element.val(),id:this.options.id}])},"click.coral-textbox-close":function(d){d.preventDefault();this.setValue("",true);
if(this.options.placeholder){this._showPlaceholder()}this._trigger("onCloseClick",event,[])},"mousedown.coral-textbox-close":function(d){d.stopPropagation();a=true}})},_refresh:function(){var b=this,a=this.options},_setOption:function(d,f){var e=this;if(d==="id"||d==="name"||d==="type"){return}if(d==="height"){if(f){this.component().outerHeight(f);this.uiTextbox.find(".coral-textbox-btn-textico").css({"line-height":(f-6)+"px",height:f+"px"})}}if(d==="width"){if(f){this.component().outerWidth(f)}}this._super(d,f);if(d==="placeholder"){this.element.attr("placeholder",this.options.placeholder);if(this.getValue()===""){this._showPlaceholder()}}if(d=="texticons"){var b=e._getIcon(e.options.texticons);var a=$('<span class="coral-textbox-btn-icons coral-corner-right"></span>');e.elementBorder.find(".coral-textbox-btn-icons").replaceWith(a);for(var c in b){$.each(b[c],function(g,i){var h=$('<span class="coral-textbox-btn-ico icon"></span>').addClass("coral-textbox-btn-textico").html(g);h.bind("click"+e.eventNamespace,function(j){if(e.options.disabled){return}e._triggerClick(i,j,[{value:e.element.val()}])});a.append(h)})}}if(d==="value"){e._updateTitle();e.setValue(f,false)}if(d==="isLabel"){if(typeof f=="boolean"&&f){this._setReadonly();this.component().removeClass("coral-readonly").addClass("coral-isLabel")}else{if(typeof f=="boolean"&&!f){this.element.prop("readonly",false);this.options.readonly=false;this.options.isLabel=false;this.options.readonlyInput=false;this.component().removeClass("coral-isLabel coral-readonly")}}}if(d==="readonly"){if(typeof f=="boolean"&&f){this._setReadonly();this.component().removeClass("coral-isLabel").addClass("coral-readonly")}else{if(typeof f=="boolean"&&!f){this.element.prop("readonly",false);this.options.readonly=false;this.options.readonlyInput=false;this.element.prop("readonly",false);this.component().removeClass("coral-isLabel coral-readonly")}}}if(d==="readonlyInput"){if(typeof f=="boolean"&&f){this._setReadonlyInput();this.component().removeClass("coral-isLabel").addClass("coral-readonlyInput")
}else{if(typeof f=="boolean"&&!f){this.element.prop("readonly",false);this.options.readonlyInput=false;this.component().removeClass("coral-isLabel coral-readonlyInput")}}}if(d==="disabled"){if(f){this.element.prop("disabled",true)}else{this.element.prop("disabled",false)}}if(d==="labelField"){e._updateLabel(f)}if(d==="title"){e._updateTitle()}if(d==="hasTips"){e._updateTitle()}},_destroy:function(){this.uiTextbox.replaceWith(this.element);this.element.val("");this.element.removeAttr("value");this.element.removeClass("coral-textbox-default").removeClass("coral-validation-textbox").removeClass("coral-textbox-hover").removeClass("coral-textbox-textarea").removeClass("coral-textbox-input").removeAttr("placeholder").removeAttr("title").removeAttr("readonly").removeAttr("disabled")},disable:function(){this._setOption("disabled",true)},enable:function(){this._setOption("disabled",false)},getHtml:function(){return this.element.text()},setHtml:function(){this.element.text(value);this._updateTitle()},getValue:function(){return this.valuebox.val()},getValidateValue:function(){return this.getText()},getText:function(){if(this.component().hasClass("coral-state-focus")){if(this.element.is("textarea")){return this.element.text()}else{return this.element.val()}}else{return this.valuebox.val()}},setValue:function(e,b,d){e=e===null||typeof(e)==="undefined"?"":e;var f=e,c;d=d!==false?true:false;var a=$.coral.toFunction(this.options.formatterText);if($.isFunction(a)){f=a.apply(this.options.element,[{value:e}])}if(d){this.setText(f)}this.valuebox.val(e);this.options.value=e;if(b&&this.previous!=e){this._trigger("onChange",null,[{value:e,text:f}])}this.previous=e;if(e!==""){this._hidePlaceholder()}},setText:function(a){if(this.element.is("textarea")){this.element.val(a);this.element.text(a)}else{this.element.val(a)}this._updateTitle()},formValue:function(){var b={},a=this.element.attr("name");if(!a){return null}b[a]=this.getValue();return b}});