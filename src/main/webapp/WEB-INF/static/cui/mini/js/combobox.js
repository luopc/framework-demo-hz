(function(){var a=0;$.component("coral.combobox",$.coral.combo,{version:"4.0.3",castProperties:["data","buttons"],options:{cls:"",valueField:"value",textField:"text",panelRenderOnShow:false,mode:"local",method:"post",url:null,data:[],buttons:[],width:"auto",showText:true,emptyText:null,postMode:"value",formatter:function(c){var b=$(this).combobox("option","textField");return c[b]},loader:function(g,f,d){var e=this,b=$(this),c=b.combobox("option","url");if(!c){return false}$.ajax({type:b.combobox("option","method"),url:c,data:g,dataType:"json",success:function(h){f(h)},error:function(){d.apply(this,arguments)}});return false},beforeLoad:$.noop,onLoad:$.noop,onError:$.noop,onShowPanel:$.noop,beforeSelect:$.noop,onSelect:$.noop,unSelect:$.noop},_create:function(){var b=this,e=null;var d=new Date();this.data=this.data||[];a++;b.options.itemIdPrefix="combobox_i"+a;this.element.addClass("coral-form-element-combobox coral-validation-combobox ctrl-form-element");var c=$.coral.toFunction(this.options.onShowPanel);e=function(f){c.apply(b.element,[f]);b._scrollTo(b.getValue())};this.options.onShowPanel=e;this._super();this._on(this.uiCombo.panel,{mouseover:function(f){$(f.target).closest(".coral-combobox-item").addClass("coral-combobox-item-hover")},mouseout:function(f){$(f.target).closest(".coral-combobox-item").removeClass("coral-combobox-item-hover")},mousedown:function(j){this.cancelBlur=true;this._delay(function(){delete this.cancelBlur});var g=$(j.target).closest(".coral-combobox-item"),h=g.attr("value");if($(j.target).closest(".coral-combo-filterbox").length){return}if(!g.length||g.hasClass("coral-combobox-item-disabled")){return false}var f=this.getRowIndex(h);if(false===this._trigger("beforeSelect",null,[{item:this.options.data[f]},{data:this.options.data[f]}])){return false}if(this.options.multiple){this.oldText=this.uiCombo.textbox.val();if(""===h){this.clear();this.hidePanel();this.select(h)}else{if(this.options.emptyText){this.unselect("")}if(g.hasClass("coral-combobox-item-selected")){this.unselect(h);
g.removeClass("coral-combobox-item-selected")}else{this.select(h)}}}else{this.oldText=this.uiCombo.textbox.val();this.hidePanel();this.select(h)}return false}});if(this.options.isLabel&&this.options.emptyText&&""===this.getValue()){this.uiCombo.textbox.val("")}},_initData:function(){if(this.options.url){return this._request(this.options.url)}if(this.options.data.length){return this.loadData(this.options.data)}return this.loadData(this._transformData())},_renderItems:function(w){var m=this.options,k=this.panel(),g=this,d={},p=[],l=[],r,b="",e=$.coral.toFunction(this.options.formatter),h=$.coral.toFunction(this.options.itemattr);for(r=0;r<w.length;r++){var f=w[r],j=f[m.valueField],n=f[m.textField],u=!!f.hidden==true?"hidden":"",t="",c=n;if(e){c=e.call(this.element,w[r])}if($.isFunction(h)){var o=h.apply(this.element[0],[{item:w[r]}]);if(!$.isEmptyObject(o)){if(o.hasOwnProperty("style")){t+=o.style;delete o.style}if(o.hasOwnProperty("class")){u+=" "+o["class"];delete o["class"]}try{delete o.role}catch(q){}for(attrName in o){if(o.hasOwnProperty(attrName)){b+=" "+attrName+"="+o[attrName]}}}l.push("<div class='coral-combobox-item "+u+b+"' style='"+t+"' id='"+this.options.itemIdPrefix+"_"+r+"' value='"+j+"'>"+c+"</div>")}else{l.push("<div class='coral-combobox-item "+u+" ' id='"+this.options.itemIdPrefix+"_"+r+"' value='"+j+"'>"+c+"</div>")}if(f.selected&&$.inArray(j,p)===-1){p.push(this.getModeValue(j,n))}}this.lazyPanelHtml=l.join("");return p},loadData:function(f,g,l){var b=this.options,c=this.panel(),h=this,d=l||"onLoad",n=$.coral.toFunction(this.options.formatter),i={},e=[],j=false,k=null;if(!(f instanceof Array)){f=[]}this.data=(f||[]);if(b.clearOnLoad){j=h._clearValues(this.data)}this.uiCombo.pContent.empty();if(this.options.emptyText){if(!(f.length>0&&""===f[0][this.options.valueField])){i[this.options.valueField]="";i[this.options.textField]=this.options.emptyText;f.unshift(i)}}var m=[];if(!this.options.panelRenderOnShow){e=this._renderItems(this.data);this.uiCombo.pContent.html(this.lazyPanelHtml);
this.panelRendered=true}if(this.currentValues.length&&!j){e=this.currentValues}if(!this.isInit){this.isInit=true;this.originalValue=e.join(",")}this.dataLoaded=true;if(b.multiple){this.setValues(e,false,g)}else{e=e.length?[e[0]]:[];this.setValues(e,false,g)}this._trigger(d,null,[f])},localFilter:function(g){var f=this.getData(),e=this.panel().find(".coral-combobox-item");for(var c=0;c<f.length;c++){$(e[c]).hide();if(g.apply(this.element,[f[c]])){var b=f[c][this.options.valueField];var d=f[c][this.options.textField];$(e[c]).show()}}},_scrollTo:function(e){var b=this.panel().find(".coral-combo-content"),c;var d=this.getEl(e);if(d.length){if(d.position().top<=0){c=b.scrollTop()+d.position().top;b.scrollTop(c)}else{if(d.position().top+d.outerHeight()>b.height()){c=b.scrollTop()+d.position().top+d.outerHeight()-b.height();b.scrollTop(c)}}}},_transformData:function(){var b=this.options;var c=[];$(">option",this.element).each(function(){var d={};d[b.valueField]=$(this).attr("value")!==undefined?$(this).attr("value"):$(this).html();d[b.textField]=$(this).html();d.selected=$(this).attr("selected");c.push(d)});return c},_showItems:function(){this.uiCombo.panel.find(".coral-combobox-item").show()},_doQuery:function(e){var c=this.options,n=this.options.filter;if(c.mode=="remote"){this._request(null,{q:e},true)}else{var d=this.panel();var g=this.getData(),o=d.find(".coral-combobox-item");o.hide();this._removeHighlight(this.uiCombo.pContent.find("span.coral-keyword-highlight"));this.uiCombo.pContent.find(".coral-combobox-item-selected").removeClass("coral-combobox-item-selected");this.uiCombo.pContent.find(".coral-item-focus").removeClass("coral-item-focus");for(var h=0;h<g.length;h++){var k=pinyinEngine.toPinyin(g[h][c.textField],false,"");for(var f=0;f<e.length;f++){var b=n.apply(this.element,[e[f],g[h]]);if(b){var l=g[h][c.valueField].toString();var m=g[h][c.textField];if(m.indexOf(e[f])>-1||l.indexOf(e[f])>-1||k.indexOf(e[f])>-1){$(o[h]).show();if(m==e[f]){$(o[h]).addClass("coral-combobox-item-selected");
this._removeHighlight($(o[h]).find("span.coral-keyword-highlight"))}else{if(b=="text"){this._addHighlight($(o[h]),e[f])}}}}}}}},_checkMathch:function(q,r){var b=[],p=[];var c=this.options,e=c.textField,s=c.valueField;var o=0;if(r){this._showItems()}var d=false;var l=this.data,h="",f={},m=0,k,g;if(c.multiple){for(k=0;k<q.length;k++){for(g=0;g<l.length;g++){if(l[g][e]!=q[k]&&l[g][s]!=q[k]){f[k.toString()]=true}if(l[g][e]==q[k]){h=this.getModeValue(l[g][s],l[g][e]);b.push(h);d=true;break}}if(!d&&!c.forceSelection){if((!f[k.toString()]&&!r)||r){b.push(q[k]);p.push(q[k])}}d=false}}else{var n=-1;for(k=0;k<l.length;k++){if(l[k][e]==q[0]){n=n===-1?k:n;d=true}if(l[k][e]!=q[0]&&l[k][s]!=q[0]){f["0"]=true}}if(d){h=this.getModeValue(l[n][s],l[n][e]);b.push(h)}if(!d&&!c.forceSelection){if((!f["0"]&&!r)||r){b.push(q[0]);p.push(q[0])}}}return{valarr:b,textarr:p}},_request:function(d,e,g){var h=this,b={},f=[],c=this.options.loader,j=false;if(!d&&!h.options.url){d=[]}else{if(!d&&h.options.url){d=h.options.url}}if(typeof(d)!=="string"){b=d;if(b.data){f=b.data}else{if(b.url){d=b.url;h.options.url=b.url;j=true}else{if(b instanceof Array){f=d}else{if(!b.url&&!b.data&&!h.options.url){f=[]}else{if(!b.url&&!b.data&&h.options.url){d=h.options.url;j=true}}}}}}else{h.options.url=d;j=true}if(j){e=e||{};if(this._trigger("beforeLoad",null,[e])==false){return}c.apply(this.element,[e,function(l){var k=b.onLoad;h.loadData(l,g,k);h._loadedHandler()},function(){h._trigger("onError",null,arguments)}])}else{var i=b.onLoad;h.loadData(f,g,i)}},_loadedHandler:function(){var c=this;var b=this._getCacheItem("setValues");if(b){this.setValues(b.values,b.triggerOnChange,b.remainText);this._removeCacheItem("setValues")}var d=this._getCacheItem("focus");if(d){this._removeCacheItem("focus")}},_selectItems:function(c,h){var e=this.panel(),f=null,g=null,d=e.find(".coral-item-focus:visible"),b=":last";if(c){b=":first"}d.removeClass("coral-item-focus");if(d.length){g=d.attr("value")}else{d=f=e.find(".coral-combobox-item-selected:visible"+b);
if(f.length){g=f.attr("value")}}if(h=="prev"){if(d.prevAll(":visible").length===0){d=e.find(".coral-combobox-item:visible:last");d.addClass("coral-item-focus")}else{d.prevAll(":visible:eq(0)").addClass("coral-item-focus")}}else{if(d.nextAll(":visible").length===0){d=e.find(".coral-combobox-item:visible:first");d.addClass("coral-item-focus")}else{d.nextAll(":visible:eq(0)").addClass("coral-item-focus")}}return g},_selectPrev:function(){var b=this.panel(),e=this._selectItems(true,"prev"),d=b.find('.coral-combobox-item[value="'+e+'"]'),c=null,f=null;if(d.length){c=d.prevAll(":visible:eq(0)")}else{d=b.find(".coral-combobox-item:visible:last")}if(null!==c&&c.length===0){c=b.find(".coral-combobox-item:visible:last")}f=!!c?c.attr("value"):d.attr("value");this.select(f);this._scrollTo(f)},_selectNext:function(){var b=this.panel(),e=this._selectItems(true,"next"),d=b.find('.coral-combobox-item[value="'+e+'"]'),c=null,f=null;if(d.length){c=d.nextAll(":visible:eq(0)")}else{d=b.find(".coral-combobox-item:visible:first")}if(c&&c.length==0){c=b.find(".coral-combobox-item:visible:first")}f=c?c.attr("value"):d.attr("value");this.select(f);this._scrollTo(f)},_doEnter:function(j){var c=this.panel(),l=this.getValues(),m=c.find(".coral-item-focus:visible"),g,f=this.getData(),b=this.options,k=m.attr("value");if(k){var d="",h=0;for(g=0;g<f.length;g++){if(k==f[g][b.valueField]){h=g}}d=this.getModeValue(k,f[h][b.textField]);if(this.options.multiple){if($.inArray(d,l)==-1){this.select(k)}else{this.unselect(k)}}else{this.hidePanel()}}},_formatValue:function(g){var f=this.getData(),e=this.options,c=e.valueField,b=e.textField,d=0,h=null;if("text"===e.postMode||"value-text"===e.postMode){for(d=0;d<f.length;d++){h=f[d];if(""!=g&&g==h[c]){if("text"===e.postMode){return h[b]}if("value-text"===e.postMode){return g+e.valueTextSeparator+h[b]}}}}return g},_destroy:function(){this.element.removeClass("coral-validation-combobox");this.element.removeClass("coral-form-element-combobox");this._super()},_getOnlyValues:function(){var f=this.getData(),b=this.options,c=[],g=0;
if(!this.currentValues||(!this.currentValues[0]&&this.currentValues.length===1)){return c}for(;g<this.currentValues.length;g++){var h=this.currentValues[g],e=0,k=b.valueField,d=b.textField,l=null;if("value-text"===b.postMode){h=h.split(b.valueTextSeparator)[0];c.push(h)}if("value"===b.postMode){c.push(h)}if("text"===b.postMode){for(;f&&e<f.length;e++){l=f[e];if(l[d]==h){c.push(l[k]);break}}}}return c},_getCurrentValues:function(){var e=this.getData(),d=this.options,c=[],b=0;if(!this.currentValues||(!this.currentValues[0]&&this.currentValues.length===1)){return c}return this.currentValues},getData:function(){return this.data||[]},setValues:function(b,n,e){var m=this.options,u=this.getData(),h=this.panel(),p=e,r=0,q=0,t=this.getValues()||[],g=[],k=[],s=null,o=null,l=null;if(typeof(p)=="object"){e=p.remainText;n=p.triggerOnChange}this.currentValues=b;if(!this.dataLoaded){return}h.find(".coral-combobox-item-selected").removeClass("coral-combobox-item-selected");for(r=0;r<b.length;r++){o=b[r];l=o;var d=this.getRowIndex(o);if(d>-1){l=u[d][m.textField];s=u[d][m.valueField];var c=this._getItemByIndex(d).addClass("coral-combobox-item-selected");if(m.emptyText&&""==o){this.uiCombo.textbox.attr("placeholder",m.emptyText);this._showPlaceholder(m.emptyText);l=""}else{this._hidePlaceholder()}k.push(l);g.push(o)}else{if(d<0&&!m.forceSelection){k.push(l);g.push(o)}}}if(!e){this._setText(k.join(m.separator))}var f=this._getMinus(g,b);if((f.length&&g.length)||!g.length){k=k.concat(f);if(!e){this._setText(k.join(m.separator))}g=b}this._super(g,n,e)},_getMinus:function(d,c){var e=[];$.each(c,function(b,f){if($.inArray(f,d)==-1){e.push(f)}});return e},getEl:function(c){var b=this.getRowIndex(c);var d=b;return $("#"+this.options.itemIdPrefix+"_"+d)},_getItemByIndex:function(b){var c=b;return $("#"+this.options.itemIdPrefix+"_"+c)},getRowIndex:function(f){var d=this.options,e=this.getData(),b=d.postMode;for(var c=0;c<e.length;c++){if(b=="value"){if(e[c][d.valueField]==f){return c}}if(b=="text"){if(e[c][d.textField]==f){return c
}}if(b=="value-text"){if(e[c][d.valueField]==f.split(d.valueTextSeparator)[0]){return c}}}return -1},clear:function(){var b=this.panel();this._super();b.find(".coral-combobox-item-selected").removeClass("coral-combobox-item-selected");b.find(".coral-item-focus").removeClass("coral-item-focus")},reload:function(b){this._request(b)},select:function(g){var e=this.options,f=this.getData(),d,b;g=$.trim(g);if(e.multiple){b=this.getValues()}else{b=[]}var c="",h=0;for(d=0;d<f.length;d++){if(g==f[d][e.valueField]){h=d}}c=this.getModeValue(g,f[h][e.textField]);for(d=0;d<b.length;d++){if(b[d]==c){return}}b.push(c);this.setValues(b,true,false);this._trigger("onSelect",null,[{item:f[h],value:g,text:f[h][e.textField]}])},getModeValue:function(c,d){var b;if(this.options.postMode=="value"){b=c}if(this.options.postMode=="text"){b=d}if(this.options.postMode=="value-text"){b=c+"-"+d}return b},unselect:function(f){var d=this.options,e=this.getData(),b=this.getValues(),c;var g=0;for(c=0;c<e.length;c++){if(f==e[c][d.valueField]){g=c}}if(this.options.postMode=="value"){f=f}if(this.options.postMode=="text"){f=e[g][d.textField]}if(this.options.postMode=="value-text"){f=f+"-"+e[g][d.textField]}for(c=0;c<b.length;c++){if(b[c]==f){b.splice(c,1);this.setValues(b,true,false);this._trigger("onSelect",null,[{item:e[g],value:f,text:e[g][d.textField]}]);break}}},showPanel:function(){this._removeHighlight(this.uiCombo.pContent.find("span.coral-keyword-highlight"));var b=0,c;this._super();if(!this.hideValueArr){return}for(;b<this.hideValueArr.length;b++){c=this.hideValueArr[b];this.uiCombo.pContent.find('.coral-combobox-item[value="'+c+'"]').hide()}},addOption:function(g){var j=this,e=0,h=null,d=this.options.valueField,b=this.options.textField,c=g[d],f=g[b];if(!(d in g)||!(b in g)){if($.message){$.message("JSON格式不正确!")}return false}for(e=0;e<this.data.length;e++){if((g[d]==this.data[e][d])||(g[b]==this.data[e][b])){if($.message){$.message("当前选项已存在!")}return false}}h=$('<div class="coral-combobox-item"></div>');
h.attr("value",c);if(this.options.formatter){h.html(this.options.formatter.call(this.element,g))}else{h.html(f)}if(this.data.length>0&&""==this.data[0][d]){this.data.splice(1,0,g);h.insertAfter(this.uiCombo.pContent.find(":first-child"))}else{this.data.unshift(g);h.prependTo(this.uiCombo.pContent)}return true},removeOption:function(d){var f=null,e=null,c=0,b=this.options.valueField,g=null;if(typeof d==="number"){if(d>this.data.length){return}f=this.data[c];g=d}if(typeof d==="string"){e=d}if(typeof d==="object"){if(!(b in d)){return}e=d[b]}if(e!==null){for(;c<this.data.length;c++){if(e==this.data[c][b]){f=this.data[c];g=c;break}}}if(g!==null){this.data.splice(g,1);this.uiCombo.pContent.find('.coral-combobox-item[value="'+e+'"]').remove()}},clearOptinons:function(){this.uiCombo.pContent.empty();this.clear()},showOption:function(b){var c;if(typeof b==="number"){c=this.uiCombo.pContent.find(".coral-combobox-item:eq("+b+")")}else{if(typeof b==="string"){c=this.uiCombo.pContent.find('.coral-combobox-item[value="'+b+'"]')}else{if(typeof b==="object"){if(!(this.options.valueField in b)){return}c=this.uiCombo.pContent.find('.coral-combobox-item[value="'+b[this.options.valueField]+'"]')}else{this.uiCombo.pContent.find(".coral-combobox-item").removeClass("hidden");this.hideValueArr=null}}}if(c&&c.length>0){c.removeClass("hidden");if(this.hideValueArr){this.hideValueArr.splice($.inArray(c.attr("value"),this.hideValueArr),1)}}},hideOption:function(b){if(!this.hideValueArr){this.hideValueArr=[]}var c;if(typeof b==="number"){c=this.uiCombo.pContent.find(".coral-combobox-item:eq("+b+")")}else{if(typeof b==="string"){c=this.uiCombo.pContent.find('.coral-combobox-item[value="'+b+'"]')}else{if(!(this.options.valueField in b)){return}c=this.uiCombo.pContent.find('.coral-combobox-item[value="'+b[this.options.valueField]+'"]')}}if(c&&c.length>0){c.addClass("hidden");this.hideValueArr.push(c.attr("value"))}}})})();