$.component("coral.swfuploader",{options:{swfUploadOptions:null,swf:"external/swfupload.swf",uploader:"swfupload.php",auto:true,buttonClass:"",buttonCursor:"hand",buttonImage:null,buttonText:"SELECT FILES",checkExisting:false,debug:false,fileObjName:"Filedata",maxFileSize:0,fileTypeDesc:"All Files",fileTypeExts:"*.*",uploadTemplate:false,method:"post",multiple:true,formData:{},preventCaching:true,uploadedFileList:[],separator:",",progressData:"speed",queueID:false,queueSizeLimit:999,removeCompleted:true,removeTimeout:3,requeueErrors:false,successTimeout:30,uploadLimit:999,overrideEvents:[]},_create:function(){var j=this,k=this.element.clone(),b=this.options;this.options.id=this.element.attr("id");var i=$("<div />",{id:b.id+"_wrappper","class":"swfuploader",css:{height:b.height+"px",width:b.width+"px"}});this.element.append(i);var a={assume_success_timeout:b.successTimeout,button_placeholder_id:i[0].id,button_width:b.width,button_height:b.height,button_text:null,button_text_style:null,button_text_top_padding:0,button_text_left_padding:0,button_action:(b.multiple?SWFUpload.BUTTON_ACTION.SELECT_FILES:SWFUpload.BUTTON_ACTION.SELECT_FILE),button_disabled:false,button_cursor:(b.buttonCursor=="arrow"?SWFUpload.CURSOR.ARROW:SWFUpload.CURSOR.HAND),button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,debug:b.debug,requeue_on_error:b.requeueErrors,file_post_name:b.fileObjName,file_size_limit:b.maxFileSize,file_types:b.fileTypeExts,file_types_description:b.fileTypeDesc,file_queue_limit:b.queueSizeLimit,file_upload_limit:b.uploadLimit,flash_url:b.swf,prevent_swf_caching:b.preventCaching,post_params:b.formData,upload_url:b.uploader,use_query_string:(b.method=="get"),swfupload_loaded_handler:b.onSWFReady,file_dialog_complete_handler:this.onDialogClose,file_dialog_start_handler:this.onDialogOpen,file_queued_handler:function(m){j.onSelect.apply(j,[this,m])},file_queue_error_handler:function(m,o,n){j.onSelectError.apply(j,[this,m,o,n])},upload_complete_handler:function(m){j.onUploadComplete.apply(j,[this,m])
},upload_error_handler:function(m,o,n){j.onUploadError.apply(j,[this,m,o,n])},upload_progress_handler:function(n,o,m){j.onUploadProgress.apply(j,[this,n,o,m])},upload_start_handler:function(m){j.onUploadStart.apply(j,[this,m])},upload_success_handler:function(n,o,m){j.onUploadSuccess.apply(j,[this,n,o,m])}};if(b.swfUploadOptions){a=$.extend(a,b.swfUploadOptions)}a=$.extend(a,b);var l=swfobject.getFlashPlayerVersion();var c=(l.major>=9);if(c){window["swfuploader_"+b.id]=new SWFUpload(a);var d=window["swfuploader_"+b.id];this.element.data("swfuploader",d);$("#"+d.movieName).wrap(i);i=$("#"+b.id);i.data("swfuploader",d);$("#"+d.movieName).css({position:"absolute","z-index":1});if(!b.queueID){var g=$("<div />",{id:b.id+"-queue","class":"swfuploader-queue"});i.after(g);d.settings.queueID=b.id+"-queue";d.settings.defaultQueue=true}d.queueData={files:{},filesSelected:0,filesQueued:0,filesReplaced:0,filesCancelled:0,filesErrored:0,uploadsSuccessful:0,uploadsErrored:0,averageSpeed:0,queueLength:0,queueSize:0,uploadSize:0,queueBytesUploaded:0,uploadQueue:[],errorMsg:"Some files were not added to the queue:"};d.original=k;d.wrapper=i;d.queue=g;if(b.onInit){b.onInit.call(this.element,d)}}else{var f=b.onNoflash.call(this.element);var h=$("<div class='coral-uploader-button' style='height: 40px;'></div>").appendTo(f);var e=$("<input type='button'/>").appendTo(h);e.button({id:b.id+"-button",label:b.buttonText,onClick:function(){alert("没有安装flash或flash版本过低")}})}},addUploadCount:function(){var a=this.element.data("swfuploader");a.addUploadCount()},reduece:function(a){var d=this.element.data("swfuploader"),c=d.settings;if($("#"+a).hasClass("template-download")){d.reduceUploadCount();uploadList=c.uploadedFileList;var b=this.getValues();uploadList.splice($.inArray(a,b),1)}else{if($("#"+a).hasClass("template-upload")){downList=c.unUploadedFileList;var b=this.getUnUploadValues();downList.splice($.inArray(a,b),1)}}},setValues:function(a){var c=this.element.data("swfuploader"),b=c.settings;b.uploadedFileList=a
},cancel:function(h,j){var i=arguments,c,a,g=this;var e=this.element.data("swfuploader"),d=e.settings,f=-1;if(!d.disabled){if(typeof h==="array"||typeof h==="undefined"){if(typeof h==="undefined"){var m=e.queueData.queueLength;$("#"+d.queueID).children().each(function(){f++;if(i[1]===true){e.cancelUpload(this.id,false)}else{e.cancelUpload(this.id)}$(this).find(".data").removeClass("data");$(this).delay(1000+100*f).fadeOut(500,function(){$(this).remove()});g._trigger("onRemove",null);delete e.queueData.files[this.id];g.reduece(this.id)});e.queueData.queueSize=0;e.queueData.queueLength=0;if(d.onClearQueue){d.onClearQueue.call(this.element,m)}}else{for(var b=0;b<i.length;b++){e.cancelUpload(i[b]);$("#"+i[b]).find(".data").removeClass("data");$("#"+i[b]).delay(1000+100*b).fadeOut(500,function(){$(this).remove()});this._trigger("onRemove",null);delete e.queueData.files[i[b]];g.reduece(i[b])}}}else{var l=$("#"+h);$item=$(l);e.cancelUpload($item.attr("id"));$item.find(".data").removeClass("data");$item.delay(1000).fadeOut(500,function(){$(this).remove()});this._trigger("onRemove",null);delete e.queueData.files[h];if($("#"+h).hasClass("template-download")){e.reduceUploadCount();c=d.uploadedFileList;var k=this.getValues();c.splice($.inArray(h,k),1)}else{if($("#"+h).hasClass("template-upload")){a=d.unUploadedFileList;var k=this.getUnUploadValues();a.splice($.inArray(h,k),1)}}}}},_destroy:function(){var b=this.element.data("swfuploader"),a=b.settings;b.destroy();this.element.find(".swfuploader").remove();if(a.uploadedFileList){$("#"+a.queueID).remove()}$("#"+a.id).replaceWith(this.element);if(a.onDestroy){a.onDestroy.call(this)}delete b},disable:function(a){var c=this.element.data("swfuploader"),b=c.settings;if(a){$("#"+this.options.queueID).addClass("coral-state-disabled");b.disabled=true;this._trigger("onDisable",null,[])}else{$("#"+this.options.queueID).removeClass("coral-state-disabled");b.disabled=false;this._trigger("onEnable",null,[])}c.setButtonDisabled(a)},getQueueData:function(){var e=[],c=[];
var d=this.element.data("swfuploader"),b=d.settings;for(var a=0;a<b.uploadedFileList.length;a++){e.push(b.uploadedFileList[a].fileId)}for(var a=0;a<b.unUploadedFileList.length;a++){c.push(b.unUploadedFileList[a].fileId)}return $.merge(e,c)},getUnUploadValues:function(){var a=[];var d=this.element.data("swfuploader"),c=d.settings;for(var b=0;b<c.unUploadedFileList.length;b++){a.push(c.unUploadedFileList[b].fileId)}return a},getValues:function(){var c=[];var d=this.element.data("swfuploader"),b=d.settings;for(var a=0;a<b.uploadedFileList.length;a++){c.push(b.uploadedFileList[a].fileId)}return c},getValue:function(){var b=this.element.data("swfuploader"),a=b.settings;return this.getValues().join(a.separator)},getValidateValue:function(){return this.getValue()},_setOption:function(b,f,g){var a=arguments;var d=f;var e=this.element.data("swfuploader"),c=e.settings;this._super(b,f);switch(b){case"uploader":e.setUploadURL(f);break;case"formData":if(!g){f=$.extend(c.formData,f)}e.setPostParams(c.formData);break;case"method":if(f=="get"){e.setUseQueryString(true)}else{e.setUseQueryString(false)}break;case"fileObjName":e.setFilePostName(f);break;case"fileTypeExts":e.setFileTypes(f,c.fileTypeDesc);break;case"fileTypeDesc":e.setFileTypes(c.fileTypeExts,f);break;case"maxFileSize":e.setFileSizeLimit(f);break;case"uploadLimit":e.setFileUploadLimit(f);break;case"queueSizeLimit":e.setFileQueueLimit(f);break;case"buttonCursor":if(f=="arrow"){e.setButtonCursor(SWFUpload.CURSOR.ARROW)}else{e.setButtonCursor(SWFUpload.CURSOR.HAND)}break;case"buttonText":$("#"+this.options.id+"-button").find(".swfuploader-button-text").html(f);break;case"width":e.setButtonDimensions(f,c.height);break;case"height":e.setButtonDimensions(c.width,f);break;case"multiple":if(f){e.setButtonAction(SWFUpload.BUTTON_ACTION.SELECT_FILES)}else{e.setButtonAction(SWFUpload.BUTTON_ACTION.SELECT_FILE)}break}},stop:function(){var a=this.element.data("swfuploader");a.queueData.averageSpeed=0;a.queueData.uploadSize=0;a.queueData.bytesUploaded=0;
a.queueData.uploadQueue=[];a.stopUpload();this._trigger("onStop",null,[])},upload:function(b){var c=arguments,f;var e=this.element.data("swfuploader"),d=e.settings;e.queueData.averageSpeed=0;e.queueData.uploadSize=0;e.queueData.bytesUploaded=0;e.queueData.uploadQueue=[];if(!d.disabled){if(c[0]||typeof b==="undefined"){if(typeof b==="undefined"){e.queueData.uploadSize=e.queueData.queueSize;var a=d.unUploadedFileList;e.queueData.uploadQueue.push("*");e.startUpload()}else{for(f=0;f<c.length;f++){e.queueData.uploadQueue.push(c[f])}e.startUpload(e.queueData.uploadQueue.shift())}}else{e.startUpload()}}},onDialogOpen:function(){var a=this.settings;this.queueData.errorMsg="Some files were not added to the queue:";this.queueData.filesReplaced=0;this.queueData.filesCancelled=0;if(a.onDialogOpen){a.onDialogOpen.call(this)}},onDialogClose:function(a,c,d){var b=this.settings;this.queueData.filesErrored=a-c;this.queueData.filesSelected=a;this.queueData.filesQueued=c-this.queueData.filesCancelled;this.queueData.queueLength=d;if($.inArray("onDialogClose",b.overrideEvents)<0){if(this.queueData.filesErrored>0){}}if(b.onDialogClose){b.onDialogClose.call(this,this.queueData)}if(b.auto){$("#"+b.id).swfuploader("upload","*")}},handerSWFEvent:function(){},validateFiles:function(a,b){var c=a.settings;if(c.acceptFileTypes&&!(c.acceptFileTypes.test(b.type)||c.acceptFileTypes.test(b.name))){b.error="The file is not an accepted file type."}else{if(b.size>c.maxFileSize){b.error="The File is too large."}}return b.error},onSelect:function(i,b){var c=i.settings,k,l;var a={};var e=Math.round(b.size/1024);var j="KB";if(e>1000){e=Math.round(e/1000);j="MB"}var g=e.toString().split(".");e=g[0];if(g.length>1){e+="."+g[1].substr(0,2)}e+=j;var f=b.name;if(f.length>25){f=f.substr(0,25)+"..."}itemData={fileID:b.id,instanceID:c.id,fileName:f,fileSize:e};if($.inArray("onSelect",c.overrideEvents)<0){k=c.uploadTemplate({files:[b],options:c});for(var h in itemData){k=k.replace(new RegExp("\\$\\{"+h+"\\}","g"),itemData[h])
}k=$(c.templatesContainer).html(k).children();k.addClass("template-upload fade");$("#"+c.queueID).append(k);this._trigger("onRenderUploadTmp",null,{item:k})}i.queueData.queueSize+=b.size;i.queueData.files[b.id]=b;this._trigger("onSelect",null,[{file:b}])},onSelectError:function(b,c,g,f){var d=b.settings,a,e;if($.inArray("onSelectError",d.overrideEvents)<0){switch(g){case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:if(d.queueSizeLimit>f){alert("\nThe number of files selected exceeds the remaining upload limit")}else{alert("\nThe number of files selected exceeds the queue size limit")}break;case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:$.messageQueue({message:"The File is too large"});break;case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE:b.queueData.errorMsg='\nThe file "'+c.name+'" is empty.';break;case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:b.queueData.errorMsg='\nThe file "'+c.name+'" is not an accepted file type ('+d.fileTypeDesc+").";break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:$.messageQueue({message:"The file is not an accepted file type"});break}}if(g!=SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED){delete b.queueData.files[c.id]}this._trigger("onSelectError",null,[{file:c,error:f}])},onQueueComplete:function(){if(this.settings.onQueueComplete){this.settings.onQueueComplete.call(this,this.settings.queueData)}},onUploadComplete:function(b,e){var f=b.settings,g=b;var d=b.getStats();b.queueData.queueLength=d.files_queued;if(b.queueData.uploadQueue[0]=="*"){if(b.queueData.queueLength>0){b.startUpload()}else{b.queueData.uploadQueue=[];if(f.onQueueComplete){f.onQueueComplete.call(b,b.queueData)}}}else{if(b.queueData.uploadQueue.length>0){b.startUpload(b.queueData.uploadQueue.shift())}else{b.queueData.uploadQueue=[];if(f.onQueueComplete){f.onQueueComplete.call(b,b.queueData)}}}if($.inArray("onUploadComplete",f.overrideEvents)<0){if(f.removeCompleted){switch(e.filestatus){case SWFUpload.FILE_STATUS.COMPLETE:setTimeout(function(){if($("#"+e.id)){g.queueData.queueSize-=e.size;
g.queueData.queueLength-=1;delete g.queueData.files[e.id];$("#"+e.id).fadeOut(500,function(){$(this).remove()})}},f.removeTimeout*1000);break;case SWFUpload.FILE_STATUS.ERROR:if(!f.requeueErrors){setTimeout(function(){if($("#"+e.id)){g.queueData.queueSize-=e.size;g.queueData.queueLength-=1;delete g.queueData.files[e.id];$("#"+e.id).fadeOut(500,function(){$(this).remove()})}},f.removeTimeout*1000)}break}}else{e.uploaded=true}}var c=f.unUploadedFileList;var a=this.getUnUploadValues();c.splice($.inArray(e[f.prmNames.fileId],a),1);this._trigger("onComplete",null,[{file:e}])},onUploadError:function(a,c,g,f){var d=a.settings;var e="Error";switch(g){case SWFUpload.UPLOAD_ERROR.HTTP_ERROR:e="HTTP Error ("+f+")";this._trigger("onFail",null,[{file:c,error:f}]);break;case SWFUpload.UPLOAD_ERROR.MISSING_UPLOAD_URL:e="Missing Upload URL";break;case SWFUpload.UPLOAD_ERROR.IO_ERROR:e="IO Error";this._trigger("onFail",null,[{file:c,error:f}]);break;case SWFUpload.UPLOAD_ERROR.SECURITY_ERROR:e="Security Error";this._trigger("onFail",null,[{file:c,error:f}]);break;case SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED:alert("The upload limit has been reached ("+f+").");e="Exceeds Upload Limit";break;case SWFUpload.UPLOAD_ERROR.UPLOAD_FAILED:e="Failed";this._trigger("onFail",null,[{file:c,error:f}]);break;case SWFUpload.UPLOAD_ERROR.SPECIFIED_FILE_ID_NOT_FOUND:break;case SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED:e="Validation Error";break;case SWFUpload.UPLOAD_ERROR.FILE_CANCELLED:e="Cancelled";a.queueData.queueSize-=c.size;a.queueData.queueLength-=1;if(c.status==SWFUpload.FILE_STATUS.IN_PROGRESS||$.inArray(c.id,a.queueData.uploadQueue)>=0){a.queueData.uploadSize-=c.size}delete a.queueData.files[c.id];break;case SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED:e="Stopped";this._trigger("onFail",null,[{file:c,error:f}]);break}if($.inArray("onUploadError",d.overrideEvents)<0){}var b=a.getStats();a.queueData.uploadsErrored=b.upload_errors},onUploadProgress:function(l,e,k,h){var f=l.settings;var c=new Date();
var m=c.getTime();var i=m-l.timer;if(i>500){l.timer=m}var g=k-l.bytesLoaded;l.bytesLoaded=k;var b=l.queueData.queueBytesUploaded+k;var a=Math.round(k/h*100);var n="KB/s";var j=0;var d=(g/1024)/(i/1000);d=Math.floor(d*10)/10;if(l.queueData.averageSpeed>0){l.queueData.averageSpeed=Math.floor((l.queueData.averageSpeed+d)/2)}else{l.queueData.averageSpeed=Math.floor(d)}if(d>1000){j=(d*0.001);l.queueData.averageSpeed=Math.floor(j);n="MB/s"}if($.inArray("onUploadProgress",f.overrideEvents)<0){$("#"+e.id).find(".progressbar-value").show().css("width",a+"%");$("#"+e.id).find(".progressbar-text").text(a+"%")}this._trigger("onProgress",null,[{file:e}])},onUploadStart:function(a,b){var c=a.settings;var d=new Date();a.timer=d.getTime();a.bytesLoaded=0;if(a.queueData.uploadQueue.length==0){a.queueData.uploadSize=b.size}if(c.checkExisting){$.ajax({type:"POST",async:false,url:c.checkExisting,data:{filename:b.name},success:function(f){if(f==1){var e=confirm('A file with the name "'+b.name+'" already exists on the server.\nWould you like to replace the existing file?');if(!e){a.cancelUpload(b.id);$("#"+b.id).remove();if(a.queueData.uploadQueue.length>0&&a.queueData.queueLength>0){if(a.queueData.uploadQueue[0]=="*"){a.startUpload()}else{a.startUpload(a.queueData.uploadQueue.shift())}}}}}})}this._trigger("onStart",null,[{file:b}]);this._trigger("onSend",null,[{file:b}])},onUploadSuccess:function(k,a,g,e){var b=k.settings,m;var h=k.getStats();k.queueData.uploadsSuccessful=h.successful_uploads;k.queueData.queueBytesUploaded+=a.size;if($.inArray("onUploadSuccess",b.overrideEvents)<0){$("#"+a.id).find(".data").html(" - 上传完成")}var c=Math.round(a.size/1024);var l="KB";if(c>1000){c=Math.round(c/1000);l="MB"}var i=c.toString().split(".");c=i[0];if(i.length>1){c+="."+i[1].substr(0,2)}c+=l;var f=a.name;if(f.length>25){f=f.substr(0,25)+"..."}if($.inArray("onSelect",b.overrideEvents)<0){m=b.downloadTemplate({files:[a],options:b});for(var j in itemData){m=m.replace(new RegExp("\\$\\{"+j+"\\}","g"),itemData[j])
}if(b.uploadTemplate){m=$(b.templatesContainer).html(m).children();m.addClass("template-download fade");$("#"+a.id).replaceWith(m)}this._trigger("onRenderDownloadTmp",null,{item:m})}this._trigger("onSuccess",null,[{file:a}])}});