/*!
 * 组件库4.0：复选框组
 * 
 * 依赖JS文件：
 *    jquery.coral.core.js
 *    jquery.coral.component.js
 *    jquery.validatehelper.js
 */
$.component("coral.radiolist",$.coral.formelement,{version:"4.0.1",castProperties:["data","triggers"],options:{id:null,name:null,valueField:"value",textField:"text",required:false,labelField:null,starBefore:false,showStar:true,column:null,disabled:false,readonly:false,isCheck:false,allowCancel:false,value:"",valueIndex:null,data:[],url:null,termSplit:";",itemSplit:":",repeatLayout:"table",itemWidth:"auto",errMsg:null,errMsgPosition:"leftBottom",onLoad:null,onValidError:null,onKeyDown:null,onValidSuccess:null,triggers:null,excluded:false,onChange:$.noop},_create:function(){var d=this,b=null,a=null,e=null,c=this.options;this._prepareInit();this._initComponent();this._setDefaultValue();this._initData();this._bindEvent();if(this.options.url){this._trigger("onLoad",null,[{data:this.getData()}])}},_prepareInit:function(){this.isInit=false},_initComponent:function(){this.element.addClass("coral-form-element-radiolist coral-validation-radiolist ctrl-init ctrl-form-element ctrl-init-radiolist");typeof this.element.attr("id")=="undefined"&&!!this.options.id&&that.element.attr("id",this.options.id);this.options.id=this.element.uniqueId().attr("id");var a=this.element.attr("name");typeof a!="undefined"?(this.options.name=a):(this.element.attr("name",this.options.name));this.uiBoxlist=$('<span class="coral-radiolist"></span>');this.uiInput=$('<input type="hidden">');if(this.options.name){this.uiInput.attr("name",this.options.name);this.element.removeAttr("name").attr("orgname",this.options.name)}this.uiInput.appendTo(this.uiBoxlist);if(this.options.labelField){this.uiLabel=$('<label class="coral-label">'+this.options.labelField+"</label>");this.uiBoxlist.prepend(this.uiLabel);this.uiBoxlist.addClass("coral-hasLabel")}this.uiBoxlist.insertAfter(this.element);this.element.hide()},_setDefaultValue:function(){},_initData:function(){var b=this,a=this.options;
if(a.url){if(this.xhr){this.xhr.abort()}this.xhr=$.ajax(this._ajaxSettings());this.xhr.success(function(c){b._loadData(c)}).complete(function(d,c){if(d===b.xhr){b.xhr=null}}).error(function(){$.alert("Json Format Error!")})}else{if(a.data){this._loadData(a.data)}}},_ajaxSettings:function(){var b=this.options,a=this;return{type:"get",url:b.url,data:{},async:false,dataType:"json"}},_loadData:function(g){var b=null,h,f,c=0,d=null,a=null,e=null;if(typeof g==="string"){b=g.split(this.options.termSplit);g=[];for(;c<b.length;c++){a=b[c];e=a.split(this.options.itemSplit);d={};d[this.options.valueField]=e[0];d[this.options.textField]=e[1];g.push(d)}}this.data=g;for(c;c<g.length;c++){h=g[c];if(h.checked){f=h[this.options.valueField]}}if(this.options.value){f=this.options.value}if(!this.isInit){this.isInit=true;this.originalValue=f}this._renderRadioItem();this.setValue(f)},_renderRadioItem:function(){if(this.options.repeatLayout=="table"){if(this.options.column==null){this.options.column=3}this._renderTableItem();this.uiTable.appendTo(this.uiBoxlist)}else{if(this.options.repeatLayout=="flow"){if(this.options.column==null){this.options.column=this.data.length}this._renderFlowItem();this.uiBorder.appendTo(this.uiBoxlist)}}},reset:function(){this.setValue(this.originalValue)},getData:function(){return this.data},_renderFlowItem:function(){var d=this,c=this.options,b=this.options.column,e=this.data;d.uiBorder=$('<span class="coral-radiolist-border"></span>');for(var a in e){if(a>(b-1)&&a%(b)===0){$("<br/>").appendTo(d.uiBorder)}d._renderItem(e[a]).css("width",c.itemWidth).appendTo(d.uiBorder)}},_renderTableItem:function(){this.uiTable=$("<table></table>");var d=0,c=0,g=this.data,b=g.length||0,e=this.options.column,f=0,h=null,a=null;if(!g||g.length<1){return}f=Math.ceil(b/e);for(;d<f;d++){h=$("<tr></tr>");for(c=0;c<e;c++){a=$("<td></td>");if((d*e+c)<b){this._renderItem(g[(d*e+c)]).appendTo(a)}a.appendTo(h)}h.appendTo(this.uiTable)}},_renderItem:function(g){var e=this.data,d=false;for(var f=0;
f<e.length;f++){d=e[f]["checked"]===true}if(!d){e[0]["checked"]=true;this.tabIndex=0}else{this.tabIndex=f}var b=g.hidden===true?"hidden":"",m=g.checked===true?"tabindex = 0":"",a=g.checked===true?"tabbable":"";var h=$("<span class='coral-radio "+b+a+"'"+m+"></span>"),c=$("<label class='coral-radio-label'></label>"),k=$("<span class='coral-radio-icon'></span>"),j=g[this.options.valueField],l=g[this.options.textField];h.attr("value",j);c.append(k).append(l);c.appendTo(h);k.addClass("cui-icon-radio-unchecked");return h},_bindEvent:function(){var a=this;if(this.options.disabled){this._setDisabled(this.options.disabled)}this._on({"mouseenter .coral-radio":function(c){if(a.options.readonly){return false}var b=$(c.target).closest(".coral-radio");if($(b).hasClass("coral-state-disabled")){return}$(b).addClass("coral-radio-hover")},"mouseleave .coral-radio":function(c){if(a.options.readonly){return false}var b=$(c.target).closest(".coral-radio");if($(b).hasClass("coral-state-disabled")){return}$(b).removeClass("coral-radio-hover")},"keydown .coral-radio":function(h){var g=$.coral.keyCode;var j=$(h.target).closest(".coral-radiolist"),c=j.find(".coral-radio");record=0,isChecked=true;$.each(c,function(e){if(c[e]==document.activeElement){record=e}isChecked=$(c[e]).attr("checked")===true});switch(h.keyCode){case g.SPACE:h.preventDefault();if(!isChecked){var f=$(c[i]).attr("value");a.setValue(f)}a._selectItem(h);break;case g.LEFT:h.preventDefault();if(a.options.readonly){return false}if(record==0){record=c.length}var d=$(c[record-1]),b=d.find(".coral-radio-icon"),f=d.attr("value");d.attr("tabindex","0");d.addClass("tabbable");$(c[record]).removeAttr("tabindex");$(c[record]).removeClass("tabbable");a.setValue(f);setTimeout(function(){d.focus()});a._trigger("onChange",null,{value:f,checked:b.hasClass("coral-radiolist-item-hightlight")});break;case g.RIGHT:h.preventDefault();if(a.options.readonly){return false}if(record==c.length-1){record=-1}var d=$(c[record+1]),b=d.find(".coral-radio-icon"),f=d.attr("value");
d.attr("tabindex","0");$(c[record]).removeAttr("tabindex");d.addClass("tabbable");$(c[record]).removeClass("tabbable");$(c[record]).removeAttr("tabindex");a.setValue(f);setTimeout(function(){d.focus()});a._trigger("onChange",null,{value:f,checked:b.hasClass("coral-radiolist-item-hightlight")});break}a._trigger("onKeyDown",h,{})},"click .coral-radio":function(b){a._selectItem(b);b.stopPropagation()}})},_selectItem:function(h){var f=this;var j=$(".coral-radiolist").find(".coral-radio");var c=$(h.target).closest(".coral-radio");if(f.options.readonly){return false}var d=c,a=d.find(".coral-radio-icon"),g=d.attr("value"),b=f.getValue();$(j[this.tabIndex]).removeClass("tabbable");$(j[this.tabIndex]).removeAttr("tabindex");$.each(j,function(e){if($(j[e])[0]==c[0]){f.tabIndex=e}});d.addClass("tabbable");d.attr("tabindex","0");d.focus();if(g==b){if(!this.options.allowCancel){return false}a.removeClass("cui-icon-radio-checked coral-radiolist-item-hightlight").addClass("cui-icon-radio-unchecked");f.uiInput.val("")}else{f.setValue(g);f._trigger("onChange",null,{value:g,checked:a.hasClass("coral-radiolist-item-hightlight")})}},_setDisabled:function(a){a=!!a;this.uiBoxlist.find(".coral-radio").each(function(){$(this).toggleClass("coral-state-disabled",a)});this.options.disabled=a},_setReadonly:function(a){a=!!a;this.uiBoxlist.find(".coral-radio").each(function(){$(this).toggleClass("coral-readonly",a)});this.options.readonly=a},_setOption:function(a,b){if(a==="id"||a==="name"){return}if(a==="disabled"){this._setDisabled(b)}if(a==="readonly"){this._setReadonly(b)}this._super(a,b)},_destroy:function(){this.component().remove();if(this.options.name){this.element.removeAttr("orgname").attr("name",this.options.name)}this.element.removeClass("coral-form-element-radiolist");this.element.removeClass("coral-validation-radiolist");this.element.show()},focus:function(){},component:function(){return this.uiBoxlist},disable:function(){this._setDisabled(true)},readonly:function(){this._setReadonly(true)
},enable:function(){this._setDisabled(false)},disableItem:function(a){this.uiBoxlist.find('.coral-radio[value="'+a+'"]').toggleClass("coral-state-disabled",true)},enableItem:function(a){this.options.disabled=false;this.uiBoxlist.find('.coral-radio[value="'+a+'"]').toggleClass("coral-state-disabled",false)},show:function(){this.component().show()},hide:function(){this.component().hide()},getValue:function(){return this.uiInput.val()},setValue:function(b){b=b||"";this.uiBoxlist.find(".coral-radiolist-item-hightlight").each(function(){$(this).removeClass("cui-icon-radio-checked coral-radiolist-item-hightlight").addClass("cui-icon-radio-unchecked")});var a=this.uiBoxlist.find('.coral-radio[value="'+b+'"]').find(".coral-radio-icon").removeClass("cui-icon-radio-unchecked").addClass("cui-icon-radio-checked coral-radiolist-item-hightlight");this.uiBoxlist.find(".coral-radio").removeClass("coral-state-highlight");this.uiBoxlist.find('.coral-radio[value="'+b+'"]').addClass("coral-state-highlight");this.uiInput.val(b)},getText:function(d){var b=0,c=this.data,e=null,a=[];if(!d){d=this.getValue()}for(;b<c.length;b++){e=c[b][this.options.valueField];if(e==d){return(c[b][this.options.textField])}}return""}});