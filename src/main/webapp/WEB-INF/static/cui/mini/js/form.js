$.component("coral.form",{version:"4.0.2",options:{disabled:null,ajaxSubmit:true,novalidate:false,context:"",separator:",",container:"tooltip",requires:null,excluded:[":disabled",":hidden",":not(:visible)"],errTipsType:"first",onCreate:null,url:"",postData:{},target:"",focusFirst:false,showRequiredMark:null,hideRequiredMark:null,onChange:null,triggers:{},exclude:false},_create:function(){var a=this;this._initElement();this._bindEvents();$.data(this.element,"modifiedData",{});$.data(this.element,"originalData",this._getForm());this.element.validate({excluded:this.options.excluded,errorMode:this.options.errorMode,showRequiredMark:this.options.showRequiredMark,hideRequiredMark:this.options.hideRequiredMark});if(this.options.focusFirst){this._focusFirst()}this.element.append($("<input type='text' style='display:none;'></input>"))},_getFields:function(){return this.element.find(".ctrl-form-element")},_getFieldType:function(c){var a=$(c)[0].className.split(" "),b="";for(var d in a){if(a[d].indexOf("coral-validation-")>=0){b=a[d].substr(a[d].indexOf("coral-validation-")+17);return b}}return null},_bindEvents:function(){var c=this,b=this.options,a=this._getFields();a.each(function(d,g){var f=$(g);var e=c._getFieldType(f);f.off(".formonchange").on(e+"onchange.formonchange",function(j,l){if(j.type.indexOf("onchange")!=-1){var i=$(this)[e]("option","name"),k=$(this)[e]("getValue"),h={};h[i]=k;c.updateCoralData(h);c._trigger("onChange",null,{field:this,type:e})}})})},_initElement:function(){var a=this.options;this.element.addClass(a.cls);this.element.appendTo(this.uiBorder);this.element.addClass("coral-form-default");if(a.id!==""){this.element.attr("id",a.id)}if(a.name!==""){this.element.attr("name",a.name)}if(a.action!==""){this.element.attr("action",a.action)}if(a.method!==""){this.element.attr("method",a.method)}if(a.target!==""){this.element.attr("target",a.target)}if(a.context!=""){this.element.attr("context",a.context)}else{this.element.attr("context","body")}},initRequires:function(){this._initRequires()
},_initRequires:function(){var a=this,b=this.element.find($("[class*='coral-validation-']")).parent(":visible").find($("[class*='coral-validation-']"));b.each(function(){var c=this.className,g="",e=c.split(" ");for(var d in e){if(e[d].indexOf("coral-validation-")>=0){g=e[d].substr(e[d].indexOf("coral-validation-")+17);break}}var f=$(this)[g]("option","required");if(typeof f==="boolean"&&f){if(g=="datepicker"){$(this)[g]("component",$(this)).parent("td").prev().addClass("require")}else{$(this)[g]("component").parent("td").prev().addClass("require")}}})},_getCoralType:function(a){var c=$(a)[0].className.split(" "),d="";for(var b in c){if(c[b].indexOf("coral-validation-")>=0){d=c[b].substr(c[b].indexOf("coral-validation-")+17);return d}}},showRequire:function(a){var b=$(a),c=this._getCoralType(a);b[c]("component").parent("td").prev().addClass("require")},hideRequire:function(a){var b=$(a),c=this._getCoralType(a);b[c]("component").parent("td").prev().removeClass("require")},_setOption:function(a,b){if(a=="id"||a=="name"){return}this._super(a,b);return},saveOriginalCoralData:function(a){var b=this;$.each(a,function(c,d){b._updateCoralData("original",c,d)});return},updateCoralData:function(a){var b=this;$.each(a,function(c,d){b._updateCoralData("modified",c,d)});return},_updateCoralData:function(a,b,d){var c=$.data(this.element,a+"Data");c[b]=d;$.data(this.element,a+"Data",c);return},serialize:function(){return $(this.element).serialize()},serializeArray:function(){return $(this.element).serializeArray()},modifiedData:function(a){if((typeof a=="boolean"&&a)){return this._getSerialize("modified")}else{return $.data(this.element,"modifiedData")}},originalData:function(a){if((typeof a=="boolean"&&a)){return this._getSerialize("original")}else{return $.data(this.element,"originalData")}},formData:function(){return this._getForm()},getData:function(){return this.formData()},_getSerialize:function(b){var c=$.data(this.element,b+"Data"),a="";$.each(c,function(e,f){if(typeof f!="Object"){a+=e+"="+f+"&"
}else{for(var d in f){a+=e+"="+f[d]+"&"}}});return a.substr(0,a.length-1)},_getForm:function(){var c=this,d={},b={},a=$(this.element).serializeArray();$(this.element).find(".ctrl-form-element").each(function(){var f=$(this).attr("component-role"),e=$(this)[f]("option","name");if(e){if(f!=="checkbox"&&f!=="radio"){if(d[e]){d[e]=d[e]+c.options.separator+$(this)[f]("getValue")}else{d[e]=$(this)[f]("getValue")}}else{d[e]=$(this)[f]("getValue")}}});$(a).each(function(e,f){if(f.name){if(typeof(d[f.name])==="undefined"){if(b[f.name]){b[f.name]=b[f.name]+c.options.separator+f.value}else{b[f.name]=f.value}}}});$.extend(d,b);return d},_loadData:function(b){var a=this;this._updateData(b,"modified");this._updateData(b,"original");if(typeof b=="object"){$.each(b,function(c,e){if(!a._loadCoralData(c,e)){a._loadNormalData(c,e)}})}},_loadCoralData:function(h,g){var e=this;g=g==null?"":g;var k=e._getCoralFormData();var c=false;for(var d in k){var j=k[d];var b=j.coralType;switch(b){case"radio":if(h==j.name){c=true;if(j.el[b]("option","value")==g&&g!=null){j.el[b]("check")}else{j.el[b]("uncheck")}}break;case"radiolist":if(h==j.name){c=true;if(g==null){g=""}j.el[b]("setValue",g)}break;case"checkbox":if(h==j.name){c=true;if(g==null){g=[""]}if(typeof g!="object"){if(typeof g==="string"){g=g.split(e.options.separator)}else{g=[g]}}for(var f in g){if(j.el[b]("option","value")==g[f]){j.el[b]("check");break}else{j.el[b]("uncheck")}}}break;case"checkboxlist":if(h==j.name){c=true;if(h==j.name){if(g==null){g=""}j.el[b]("setValue",g)}}break;case"combobox":case"combotree":case"combogrid":if(h==j.name){c=true;if(typeof g!="object"){if(typeof g==="string"){g=g.split(e.options.separator)}else{g=[g]}}if(g!=null){j.el[b]("setValues",g)}}break;case"datepicker":if(h==j.name){c=true;if(g!=null){j.el[b]("option","value",g)}}break;case"autocomplete":case"autocompletetree":if(h==j.name){c=true;if(g!=null){j.el[b]("option","value",g)}}break;default:if(h==j.name){c=true;if(g!=null){j.el[b]("option","value",g)}}break
}}return c},_loadNormalData:function(c,e){var d=this,a=d._getNomalFormElements();for(var b in a){if(c==a[b].attr("name")){if(undefined!=a[b].attr("type")&&"radio"==a[b].attr("type")){if(e==a[b].attr("value")){a[b][0].checked=true}else{continue}}else{if(typeof e==="string"&&e.indexOf(d.options.separator)!=-1){e=e.split(d.options.separator)}$(d.element.find("[name="+c+"]")).val(e)}}}return},_getAllFromElements:function(){return this.element.find("[name]")},_getCoralFormData:function(){var a=[];this.element.find(".ctrl-form-element").each(function(){var e=$(this),c=null,d=0,b=["radio","checkbox","combobox","combotree","combogrid","datepicker","checkboxlist","radiolist","autocomplete","textboxlist","autocompletetree"],f=e.attr("component-role");c=e[f]("option","name");if(null!=c){a.push({el:e,name:c,coralType:f})}});return a},_getCoralFormElements:function(){return this.element.find(".coral-form-element")},_getCoralNameJson:function(){var b=this,a={};b._getCoralFormElements().each(function(){var c=$(this).attr("component-role");$(this)[c]("option","name")&&(a[name]=c)});return a},_getNomalFormElements:function(){var c=this,a=[],b=c._getCoralNameJson();c._getAllFromElements().each(function(){if(!b[$(this).attr("name")]){a.push($(this))}});return a},_updateData:function(c,a){var b=$.data(this.element,a+"Data");if(typeof c=="object"){$.each(c,function(e,f){if("original"==a&&typeof b[e]!="undefined"){b[e]=f}else{if("modified"==a&&typeof b[e]!="undefined"){delete b[e]}}})}},resetData:function(){this.reset()},getErrors:function(){var b=this.component().find(".coral-validate-error"),a=[];b.each(function(){var e=$(this).find(".ctrl-form-element"),d=$(e).attr("component-role"),c={};c.errorText=$(this).find(".coral-errorIcon").attr("data-errors");c.required=$(e)[d]("option","required");c.id=$(e)[d]("option","id");c.validType=$(e)[d]("option","validType");c.value=$(e)[d]("getValue");c.element=e[0];c.requiredMsg=$(e)[d]("option","requiredMsg")||$.validate.options.requiredMsg;c.name=$(e)[d]("option","name");
a.push(c)});return a},reset:function(){var a=this;$(this.element).find(".ctrl-form-element").each(function(b){var c=$(this).attr("component-role");$(this)[c]("reset")});$.data(this.element,"modifiedData",{})},_isExclud:function(a,b){if(!b){return false}var d=b.length;for(var c=0;c<d;c++){if("string"===typeof b[c]&&a.is(b[c])){return true}}return false},clear:function(b){var a={};if(b&&b.excluded&&b.excluded instanceof Array){for(var c in b.excluded){var d=b.excluded[c];a[d]=d}}$(this.element).find(".ctrl-form-element").each(function(e){var f=$(this).attr("component-role");if(($(this)[f]("option","readonly")&&a.readonly)||($(this)[f]("option","isLabel")&&a.isLabel)||($(this)[f]("option","disabled")&&a.disabled)){return}switch(f){case"radio":case"checkbox":$(this)[f]("uncheck");break;default:$(this)[f]("setValue","");break}});$.validate.clearErrors(this.element);$.data(this.element,"modifiedData",{})},load:function(a){var c=this,b={},d=[],e=false;if(typeof(a)!=="string"){b=a;if(b.data){d=b.data}else{if(b.url){a=b.url;e=true}else{d=a}}}else{e=true}if(e){$.ajax({url:a,data:$.extend(true,{},this.options.postData,b.postData),async:false,dataType:"json",success:function(f){c._loadData(f);c._trigger($.isFunction(b.onLoad)?b.onLoad:"onLoad",null,[f])},error:function(){c._trigger("onLoadError",null,[])}})}else{this._loadData(d);this._trigger($.isFunction(b.onLoad)?b.onLoad:"onLoad",null,[{content:d}])}},loadData:function(a){this.load(a)},submit:function(a){a=a||{};if(false==this._trigger($.isFunction(a.onSubmit)?a.onSubmit:"onSubmit",null,[])){return false}if(this.options.ajaxSubmit){$.ajax({type:"post",url:$.extend(true,{},this.options.url,a.url),data:$.extend(true,{},this.options.postData,a.postData,this.formData),dataType:"json",success:function(b){this._trigger($.isFunction(a.onSuccess)?a.onSuccess:"onSuccess",null,[{content:b}])},error:function(){}})}else{if(this.valid()){this.element.submit()}else{return false}}},valid:function(){if(this.options.novalidate){return true}return this.element.validate("valid")
},hideErrorTips:function(){$("div.coral-validate-state-error").remove()},_focusFirst:function(){},findFields:function(){return $.coral.findComponent(".ctrl-form-element",this.element)},setIsLabel:function(a){$.coral.setIsLabel(a,this.element)},setReadOnly:function(a){$.coral.setReadOnly(a,this.element)},refresh:function(e){var d,b=this.options,a=b.heightStyle,c=this.component().parent();if(a==="fill"){$.coral.fitParent(this.component(),true);d=c.height();this.component().siblings(":visible").each(function(){var g=$(this),f=g.css("position");if(f==="absolute"||f==="fixed"){return}d-=g.outerHeight(true)});this.element.height(Math.max(0,d-this.element.innerHeight()+this.element.height())).addClass("coral-scroll")}else{if(a==="auto"){this.element.height("")}}$.coral.refreshAllComponent(this.element)}});