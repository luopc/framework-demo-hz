(function(a,b){a.component("coral.form",{version:"4.0.2",options:{disabled:null,ajaxSubmit:false,novalidate:false,context:"",separator:",",container:"tooltip",requires:null,excluded:[":disabled",":hidden",":not(:visible)"],errTipsType:"first",onCreate:null,url:"",postData:{},target:"",focusFirst:false,showRequiredMark:null,hideRequiredMark:null,onChange:null,triggers:{},exclude:false},_create:function(){var c=this;this._initElement();this._bindEvents();a.data(this.element,"modifiedData",{});a.data(this.element,"originalData",this._getForm());this.element.validate({excluded:this.options.excluded,errorMode:this.options.errorMode,showRequiredMark:this.options.showRequiredMark,hideRequiredMark:this.options.hideRequiredMark});if(this.options.focusFirst){this._focusFirst()}this.element.append(a("<input type='text' style='display:none;'></input>"))},_getFields:function(){return this.element.find(".ctrl-form-element")},_getFieldType:function(e){var c=a(e)[0].className.split(" "),d="";for(var f in c){if(c[f].indexOf("coral-validation-")>=0){d=c[f].substr(c[f].indexOf("coral-validation-")+17);return d}}return null},_bindEvents:function(){var e=this,d=this.options,c=this._getFields();c.each(function(f,i){var h=a(i);var g=e._getFieldType(h);h.off(".formonchange").on(g+"onchange.formonchange",function(l,n){if(l.type.indexOf("onchange")!=-1){var k=a(this)[g]("option","name"),m=a(this)[g]("getValue"),j={};j[k]=m;e.updateCoralData(j);e._trigger("onChange",null,{field:this,type:g})}})})},_initElement:function(){var c=this.options;this.element.addClass(c.cls);this.element.appendTo(this.uiBorder);this.element.addClass("coral-form-default");if(c.id!==""){this.element.attr("id",c.id)}if(c.name!==""){this.element.attr("name",c.name)}if(c.action!==""){this.element.attr("action",c.action)}if(c.method!==""){this.element.attr("method",c.method)}if(c.target!==""){this.element.attr("target",c.target)}if(c.context!=""){this.element.attr("context",c.context)}else{this.element.attr("context","body")
}},initRequires:function(){this._initRequires()},_initRequires:function(){var c=this,d=this.element.find(a("[class*='coral-validation-']")).parent(":visible").find(a("[class*='coral-validation-']"));d.each(function(){var e=this.className,i="",g=e.split(" ");for(var f in g){if(g[f].indexOf("coral-validation-")>=0){i=g[f].substr(g[f].indexOf("coral-validation-")+17);break}}var h=a(this)[i]("option","required");if(typeof h==="boolean"&&h){if(i=="datepicker"){a(this)[i]("component",a(this)).parent("td").prev().addClass("require")}else{a(this)[i]("component").parent("td").prev().addClass("require")}}})},_getCoralType:function(c){var e=a(c)[0].className.split(" "),f="";for(var d in e){if(e[d].indexOf("coral-validation-")>=0){f=e[d].substr(e[d].indexOf("coral-validation-")+17);return f}}},showRequire:function(c){var d=a(c),e=this._getCoralType(c);d[e]("component").parent("td").prev().addClass("require")},hideRequire:function(c){var d=a(c),e=this._getCoralType(c);d[e]("component").parent("td").prev().removeClass("require")},_setOption:function(c,d){if(c=="id"||c=="name"){return}this._super(c,d);return},saveOriginalCoralData:function(c){var d=this;a.each(c,function(e,f){d._updateCoralData("original",e,f)});return},updateCoralData:function(c){var d=this;a.each(c,function(e,f){d._updateCoralData("modified",e,f)});return},_updateCoralData:function(c,d,f){var e=a.data(this.element,c+"Data");e[d]=f;a.data(this.element,c+"Data",e);return},serialize:function(){return a(this.element).serialize()},serializeArray:function(){return a(this.element).serializeArray()},modifiedData:function(c){if((typeof c=="boolean"&&c)){return this._getSerialize("modified")}else{return a.data(this.element,"modifiedData")}},originalData:function(c){if((typeof c=="boolean"&&c)){return this._getSerialize("original")}else{return a.data(this.element,"originalData")}},formData:function(){return this._getForm()},getData:function(){return this.formData()},_getSerialize:function(d){var e=a.data(this.element,d+"Data"),c="";
a.each(e,function(g,h){if(typeof h!="Object"){c+=g+"="+h+"&"}else{for(var f in h){c+=g+"="+h[f]+"&"}}});return c.substr(0,c.length-1)},_getForm:function(){var e=this,f={},d={},c=a(this.element).serializeArray();a(this.element).find(".ctrl-form-element").each(function(){var h=a(this).attr("component-role"),g=a(this)[h]("option","name");if(g){if(h!=="checkbox"){if(f[g]){f[g]=f[g]+e.options.separator+a(this)[h]("getValue")}else{f[g]=a(this)[h]("getValue")}}else{f[g]=a(this)[h]("getValue")}}});a(c).each(function(g,h){if(h.name){if(typeof(f[h.name])==="undefined"){if(d[h.name]){d[h.name]=d[h.name]+e.options.separator+h.value}else{d[h.name]=h.value}}}});a.extend(f,d);return f},_loadData:function(d){var c=this;this._updateData(d,"modified");this._updateData(d,"original");if(typeof d=="object"){a.each(d,function(e,f){if(!c._loadCoralData(e,f)){c._loadNormalData(e,f)}})}},_loadCoralData:function(j,h){var f=this;h=h==null?"":h;var l=f._getCoralFormData();var d=false;for(var e in l){var k=l[e];var c=k.coralType;switch(c){case"radio":if(j==k.name){d=true;if(k.el[c]("option","value")==h&&h!=null){k.el[c]("check")}else{k.el[c]("uncheck")}}break;case"radiolist":if(j==k.name){d=true;if(h==null){h=""}k.el[c]("setValue",h)}break;case"checkbox":if(j==k.name){d=true;if(h==null){h=[""]}if(typeof h!="object"){if(typeof h==="string"){h=h.split(f.options.separator)}else{h=[h]}}for(var g in h){if(k.el[c]("option","value")==h[g]){k.el[c]("check");break}else{k.el[c]("uncheck")}}}break;case"checkboxlist":if(j==k.name){d=true;if(j==k.name){if(h==null){h=""}k.el[c]("setValue",h)}}break;case"combobox":case"combotree":case"combogrid":if(j==k.name){d=true;if(typeof h!="object"){if(typeof h==="string"){h=h.split(f.options.separator)}else{h=[h]}}if(h!=null){k.el[c]("setValues",h)}}break;case"datepicker":if(j==k.name){d=true;if(h!=null){k.el[c]("option","value",h)}}break;case"autocomplete":case"autocompletetree":if(j==k.name){d=true;if(h!=null){k.el[c]("option","value",h)}}break;default:if(j==k.name){d=true;
if(h!=null){k.el[c]("option","value",h)}}break}}return d},_loadNormalData:function(e,g){var f=this,c=f._getNomalFormElements();for(var d in c){if(e==c[d].attr("name")){if(b!=c[d].attr("type")&&"radio"==c[d].attr("type")){if(g==c[d].attr("value")){c[d][0].checked=true}else{continue}}else{if(typeof g==="string"&&g.indexOf(f.options.separator)!=-1){g=g.split(f.options.separator)}a(f.element.find("[name="+e+"]")).val(g)}}}return},_getAllFromElements:function(){return this.element.find("[name]")},_getCoralFormData:function(){var c=[];this.element.find(".ctrl-form-element").each(function(){var g=a(this),e=null,f=0,d=["radio","checkbox","combobox","combotree","combogrid","datepicker","checkboxlist","radiolist","autocomplete","textboxlist","autocompletetree"],h=g.attr("component-role");e=g[h]("option","name");if(null!=e){c.push({el:g,name:e,coralType:h})}});return c},_getCoralFormElements:function(){return this.element.find(".coral-form-element")},_getCoralNameJson:function(){var d=this,c={};d._getCoralFormElements().each(function(){var e=a(this).attr("component-role");a(this)[e]("option","name")&&(c[name]=e)});return c},_getNomalFormElements:function(){var e=this,c=[],d=e._getCoralNameJson();e._getAllFromElements().each(function(){if(!d[a(this).attr("name")]){c.push(a(this))}});return c},_updateData:function(e,c){var d=a.data(this.element,c+"Data");if(typeof e=="object"){a.each(e,function(f,g){if("original"==c&&typeof d[f]!="undefined"){d[f]=g}else{if("modified"==c&&typeof d[f]!="undefined"){delete d[f]}}})}},resetData:function(){this.reset()},getErrors:function(){var d=this.component().find(".coral-validate-error"),c=[];d.each(function(){var g=a(this).find(".ctrl-form-element"),f=a(g).attr("component-role"),e={};e.errorText=a(this).find(".coral-errorIcon").attr("data-errors");e.required=a(g)[f]("option","required");e.id=a(g)[f]("option","id");e.validType=a(g)[f]("option","validType");e.value=a(g)[f]("getValue");e.element=g[0];e.requiredMsg=a(g)[f]("option","requiredMsg")||a.validate.options.requiredMsg;
e.name=a(g)[f]("option","name");c.push(e)});return c},reset:function(){var c=this;a(this.element).find(".ctrl-form-element").each(function(d){var e=a(this).attr("component-role");a(this)[e]("reset")});a.data(this.element,"modifiedData",{})},_isExclud:function(c,d){if(!d){return false}var f=d.length;for(var e=0;e<f;e++){if("string"===typeof d[e]&&c.is(d[e])){return true}}return false},clear:function(d){var c={};if(d&&d.excluded&&d.excluded instanceof Array){for(var e in d.excluded){var f=d.excluded[e];c[f]=f}}a(this.element).find(".ctrl-form-element").each(function(g){var h=a(this).attr("component-role");if((a(this)[h]("option","readonly")&&c.readonly)||(a(this)[h]("option","isLabel")&&c.isLabel)||(a(this)[h]("option","disabled")&&c.disabled)){return}switch(h){case"radio":case"checkbox":a(this)[h]("uncheck");break;default:a(this)[h]("setValue","");break}});a.validate.clearErrors(this.element);a.data(this.element,"modifiedData",{})},load:function(c){var e=this,d={},f=[],g=false;if(typeof(c)!=="string"){d=c;if(d.data){f=d.data}else{if(d.url){c=d.url;g=true}else{f=c}}}else{g=true}if(g){a.ajax({url:c,data:a.extend(true,{},this.options.postData,d.postData),async:false,dataType:"json",success:function(h){e._loadData(h);e._trigger(a.isFunction(d.onLoad)?d.onLoad:"onLoad",null,[h])},error:function(){e._trigger("onLoadError",null,[])}})}else{this._loadData(f);this._trigger(a.isFunction(d.onLoad)?d.onLoad:"onLoad",null,[{content:f}])}},loadData:function(c){this.load(c)},submit:function(c){c=c||{};if(false==this._trigger(a.isFunction(c.onSubmit)?c.onSubmit:"onSubmit",null,[])){return false}if(this.options.ajaxSubmit){a.ajax({type:"post",url:a.extend(true,{},this.options.url,c.url),data:a.extend(true,{},this.options.postData,c.postData,this.formData),dataType:"json",success:function(d){this._trigger(a.isFunction(c.onSuccess)?c.onSuccess:"onSuccess",null,[{content:d}])},error:function(){}})}else{if(this.valid()){this.element.submit()}else{return false}}},valid:function(){if(this.options.novalidate){return true
}return this.element.validate("valid")},hideErrorTips:function(){a("div.coral-validate-state-error").remove()},_focusFirst:function(){},findFields:function(){return a.coral.findComponent(".ctrl-form-element",this.element)},setIsLabel:function(c){a.coral.setIslabel(c,this.element)},setReadOnly:function(c){a.coral.setReadOnly(c,this.element)},refresh:function(g){var f,d=this.options,c=d.heightStyle,e=this.component().parent();if(c==="fill"){a.coral.fitParent(this.component(),true);f=e.height();this.component().siblings(":visible").each(function(){var i=a(this),h=i.css("position");if(h==="absolute"||h==="fixed"){return}f-=i.outerHeight(true)});this.element.height(Math.max(0,f-this.element.innerHeight()+this.element.height())).addClass("coral-scroll")}else{if(c==="auto"){this.element.height("")}}a.coral.refreshAllComponent(this.element)}})})(jQuery);