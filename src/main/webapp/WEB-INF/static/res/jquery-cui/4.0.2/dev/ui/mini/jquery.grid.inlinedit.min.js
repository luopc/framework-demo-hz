(function(a){a.coral.grid.inlineEdit=a.coral.grid.inlineEdit||{};a.component("coral.grid",a.coral.grid,{editButtonsPos:function(e,d){var h=this,c,g,b,f;c=a(h.element).grid("getDataIDs");g=a(h.element).grid("getInd",e,true);f=h.element.find(".coral-grid-rows-view").outerHeight();b=h.element.find(".coral-grid-btable").outerHeight();if((b+a(g).outerHeight()>f)&&e==c[c.length-1]){d.position({my:"left-"+(d.outerWidth()/2)+" top-2",at:"right-"+(a(g).outerWidth()/2)+" top-"+(a(d).outerHeight()),collision:"fit",of:a(g)})}else{d.position({my:"left-"+(d.outerWidth()/2)+" top-2",at:"right-"+(a(g).outerWidth()/2)+" top+"+(a(g).outerHeight()),collision:"fit",of:a(g)})}},editRow:function(h,r,B,g,e,f,m,k,b){var u={},d=a.makeArray(arguments).slice(1);if(a.type(d[0])==="object"){u=d[0]}else{if(typeof r!=="undefined"){u.keys=r}if(a.isFunction(B)){u.oneditfunc=B}if(a.isFunction(g)){u.successfunc=g}if(typeof e!=="undefined"){u.url=e}if(typeof f!=="undefined"){u.extraparam=f}if(a.isFunction(m)){u.aftersavefunc=m}if(a.isFunction(k)){u.errorfunc=k}if(a.isFunction(b)){u.afterrestorefunc=b}}u=a.extend(true,{keys:true,oneditfunc:null,successfunc:null,url:"clientArray",extraparam:{},aftersavefunc:null,errorfunc:null,afterrestorefunc:null,restoreAfterError:true,mtype:"POST"},a.coral.grid.inlineEdit,u);var y=this,c,z,v,w=0,t=null,l={},p,n;if(!y.grid){return}p=a(y.element).grid("getInd",h,true);y.options.editrow=h;y.editRowIndex=h;if(p===false){return}v=a(p).attr("editable")||"0";if(y._trigger("beforeInlineEditRow",null,[{rowId:h,options:u}])==false){return}if(v=="0"&&!a(p).hasClass("not-editable-row")){if(this.options.rowEditButtons){var A=a("<div class='row-editable coral-grid-rows'><div class='row-editable-btns coral-state-highlight'><div class='grid_edit_toolbar'></div></div></div>");var q=[];var j={type:"button",id:"update",label:a.grid.edit.bUpdate,name:"update",onClick:function(){var i=y.saveRow(p.id,null,"clientArray")}};var s={type:"button",id:"cancel",label:a.grid.edit.bCancel,name:"cancel",onClick:function(){y.restoreRow(p.id);
A.remove();y._trigger("afterInlineCancelRow",null,[{rowId:p.id,options:u,isUpdated:!a(p.id).hasClass("new-row")}])}};if(this.options.rowEditButtons.length===0){this.options.rowEditButtons=["update","cancel"]}for(var x=0;x<this.options.rowEditButtons.length;x++){if(this.options.rowEditButtons[x]=="update"){q.push(j)}else{if(this.options.rowEditButtons[x]=="cancel"){q.push(s)}else{q.push(this.options.rowEditButtons[x])}}}this.rowEditButtons=A;y.element.find(".row-editable").remove();y.element.find(".coral-grid-view").prepend(A[0]);a(".grid_edit_toolbar",y.element).toolbar({data:q});this._delay(function(){this.editButtonsPos(h,A)})}n=y.options.colModel;a('td[role="gridcell"]',p).each(function(G){c=n[G].name;var H=y.options.treeGrid===true&&c==y.options.ExpandColumn;if(H){z=a("span:first",this).html()}else{try{z=a.unformat.call(y,this,{rowId:h,colModel:n[G]},G)}catch(L){z=(n[G].edittype&&n[G].edittype=="textarea")?a(this).text():a(this).html()}}if(c!="cb"&&c!="subgrid"&&c!="rn"){if(y.options.autoencode){z=a.grid.htmlDecode(z)}l[c]=z;if(n[G].editable===true){if(t===null){t=G}if(H){a("span:first",this).html("")}else{a(this).html("")}var C=a.extend({},n[G].editoptions||{},{id:h+"_"+c,name:c});if(!n[G].edittype){n[G].edittype="text"}if(z=="&nbsp;"||z=="&#160;"||(z.length==1&&z.charCodeAt(0)==160)){z=""}var o=a.grid.createEl.call(y,n[G].edittype,C,z,false,a.extend({},a.grid.ajaxOptions,y.options.ajaxSelectOptions||{}));a(o).addClass("editable");if(H){a("span:first",this).append(o)}else{a(this).append(o)}var D=n[G].editoptions||{};var E=D.postMode||"value";a.extend(D,{onValidError:function(N,i){a(o).parents("td").addClass("coral-gridcell-error");N.stopPropagation()},onValidSuccess:function(N,i){a(o).parents("td").removeClass("coral-gridcell-error");N.stopPropagation()},onKeyDown:function(N,i){},onClick:function(N,i){N.stopPropagation()},dataCustom:{rowId:h,gridId:y.options.id}});var K=n[G].edittype;switch(K){case"autocomplete":var J=a(o).val();var M=typeof(D.source)=="string";
var I=D.onSelect;D=a.extend({},D,{onSelect:function(N,i){a(o).closest("td").attr("data-org",M?i.value:i.text);I&&I.apply(o,[N,i])}});if(M){D.postMode="text";a(o).autocomplete(D);a(o).autocomplete("setValue",J)}else{a(o).autocomplete(D);if(E=="value"){a(o).autocomplete("setValue",J)}else{a(o).autocomplete("setValue",J);a(o).autocomplete("setText",J)}}break;case"checkbox":a(o).checkbox(D);var F=["Yes","No"];if(D&&D.value){F=D.value.split(":")}if(a(o).val()==F[0]){a(o).checkbox("check")}else{a(o).checkbox("uncheck")}break;case"combogrid":case"combobox":case"combotree":a(o)[K](D);a(o)[K]("setValues",a(o).val().split(","));break;case"text":case"textarea":a(o)["textbox"](D);break;default:a(o)[K](D);break}w++}}});if(w>0){l.id=h;y.options.savedRow.push(l);a(p).attr("editable","1");a("td:eq("+t+") input",p).focus();if(u.keys===true){a(p).bind("keydown",function(o){if(o.keyCode===27){a(y.element).grid("restoreRow",h,u.afterrestorefunc);if(y.options._inlinenav){try{a(y.element).grid("showAddEditButtons")}catch(D){}}return false}if(o.keyCode===13){var i=o.target;if(i.tagName=="TEXTAREA"){return true}if(a(y.element).grid("saveRow",h,u)){if(y.options._inlinenav){try{a(y.element).grid("showAddEditButtons")}catch(C){}}}return false}})}y._trigger("onInlineEditRow",null,[{rowId:h,options:u}])}}},saveRow:function(l,i,g,h,q,n,b){var d=a.makeArray(arguments).slice(1),z={};if(a.type(d[0])==="object"){z=d[0]}else{if(a.isFunction(i)){z.successfunc=i}if(typeof g!=="undefined"){z.url=g}if(typeof h!=="undefined"){z.extraparam=h}if(a.isFunction(q)){z.aftersavefunc=q}if(a.isFunction(n)){z.errorfunc=n}if(a.isFunction(b)){z.afterrestorefunc=b}}z=a.extend(true,{successfunc:null,url:null,extraparam:{},aftersavefunc:null,errorfunc:null,afterrestorefunc:null,restoreAfterError:true,mtype:"POST"},a.grid.inlineEdit,z);var m=false;var D=this,c,F={},y={},x={},A,j,f,t;if(!D.grid){return m}t=a(D.element).grid("getInd",l,true);if(t===false){return m}if(this.options.autoValid){var C=this.valid(t.id);if(!this.options.allowSaveOnError&&!C){a.message("请确认是否输入正确！");
return C}}A=a(t).attr("editable");z.url=z.url?z.url:D.options.editurl;z.url=z.url?z.url:"clientArray";if(A==="1"){var r;a('td[role="gridcell"]',t).each(function(o){r=D.options.colModel[o];c=r.name;if(c!="cb"&&c!="subgrid"&&r.editable===true&&c!="rn"&&!a(this).hasClass("not-editable-cell")){var G=r.edittype;switch(G){case"checkbox":var k=["Yes","No"];if(r.editoptions){k=r.editoptions.value.split(":")}F[c]=a("input",this).is(":checked")?k[0]:k[1];break;case"datepicker":F[c]=a("input[type='hidden']",this).val();break;case"autocomplete":if(typeof(r.editoptions.source)=="string"){F[c]=a(".ctrl-init-"+G,this)[G]("getText")}else{F[c]=a(".ctrl-init-"+G,this)[G]("getValue")}break;case"text":case"password":case"textarea":case"button":F[c]=a("input, textarea",this).val();break;case"combogrid":case"combobox":case"combotree":F[c]=a(".ctrl-init-"+G,this)[G]("getValues").toString();y[c]=a(".ctrl-init-"+G,this)[G]("getText");if(r.formatter&&r.formatter==G){y={}}break;case"custom":try{if(r.editoptions&&a.isFunction(r.editoptions.custom_value)){F[c]=r.editoptions.custom_value.call(D,a(".customelement",this),"get");if(F[c]===undefined){throw"e2"}}else{throw"e1"}}catch(H){if(H=="e1"){a.grid.info_dialog(a.grid.errors.errcap,"function 'custom_value' "+a.grid.edit.msg.nodefined,a.grid.edit.bClose)}if(H=="e2"){a.grid.info_dialog(a.grid.errors.errcap,"function 'custom_value' "+a.grid.edit.msg.novalue,a.grid.edit.bClose)}else{a.grid.info_dialog(a.grid.errors.errcap,H.message,a.grid.edit.bClose)}}break}f=a.grid.checkValues(F[c],o,D);if(f[0]===false){f[1]=F[c]+" "+f[1];return false}if(D.options.autoencode){F[c]=a.grid.htmlEncode(F[c])}if(z.url!=="clientArray"&&r.editoptions){if(F[c]===""){x[c]="null"}}}});if(f[0]===false){try{var p=a.grid.findPos(a("#"+a.grid.coralID(l),D.grid.bDiv)[0]);a.grid.info_dialog(a.grid.errors.errcap,f[1],a.grid.edit.bClose,{left:p[0],top:p[1]})}catch(E){alert(f[1])}return m}var v,s,u;s=D.options.prmNames;u=s.oper;if(D.options.keyName===false){v=s.id}else{v=D.options.keyName
}if(F){F[u]=s.editoper;F[v]=l;if(typeof(D.options.inlineData)=="undefined"){D.options.inlineData={}}F=a.extend({},F,D.options.inlineData,z.extraparam)}if(z.url=="clientArray"){if(D.options.autoencode){a.each(F,function(k,e){F[k]=a.grid.htmlDecode(e)})}var w=a(D.element).grid("setRowData",l,F);a(t).attr("editable","0");for(var B=0;B<D.options.savedRow.length;B++){if(D.options.savedRow[B].id==l){j=B;break}}if(j>=0){D.options.savedRow.splice(j,1)}m=w;if(m){D.options.editrow=null}if(D.options.rowEditButtons){D.rowEditButtons.hide()}D._trigger("afterInlineSaveRow",null,[{rowId:l,options:z,status:w}]);if(a.isFunction(z.aftersavefunc)){z.aftersavefunc.call(D,l,w)}a(t).unbind("keydown")}else{a("#lui_"+a.grid.coralID(D.options.id)).show();x=a.extend({},F,x);x[v]=a.grid.stripPref(D.options.idPrefix,x[v]);a.ajax(a.extend({url:z.url,data:a.isFunction(D.options.serializeRowData)?D.options.serializeRowData.call(D,x):x,type:z.mtype,async:false,complete:function(G,H){a("#lui_"+a.grid.coralID(D.options.id)).hide();if(H==="success"){var o=true,I;I=D._trigger("inlineSuccessSaveRow",null,[{res:G,rowId:l,options:z}]);if(!a.isArray(I)){I=[true,F]}if(I[0]&&a.isFunction(z.successfunc)){I=z.successfunc.call(D,G)}if(a.isArray(I)){o=I[0];F=I[1]?I[1]:F}else{o=I}if(o===true){if(D.options.autoencode){a.each(F,function(J,k){F[J]=a.grid.htmlDecode(k)})}F=a.extend({},F,y);a(D.element).grid("setRowData",l,F);a(t).attr("editable","0");for(var e=0;e<D.options.savedRow.length;e++){if(D.options.savedRow[e].id==l){j=e;break}}if(j>=0){D.options.savedRow.splice(j,1)}a(D).triggerHandler("gridInlineAfterSaveRow",[l,G,F,z]);if(a.isFunction(z.aftersavefunc)){z.aftersavefunc.call(D,l,G)}m=true;D.options.editrow=null;if(D.rowEditButtons){D.rowEditButtons.hide()}D._trigger("afterInlineSaveRow",null,[{rowId:l,options:z,status:w}]);a(t).unbind("keydown")}else{a(D).triggerHandler("gridInlineErrorSaveRow",[l,G,H,null,z]);if(a.isFunction(z.errorfunc)){z.errorfunc.call(D,l,G,H,null)}if(z.restoreAfterError===true){a(D.element).grid("restoreRow",l,z.afterrestorefunc)
}}}},error:function(k,o,G){a("#lui_"+a.grid.coralID(D.options.id)).hide();a(D).triggerHandler("gridInlineErrorSaveRow",[l,k,o,G,z]);if(a.isFunction(z.errorfunc)){z.errorfunc.call(D,l,k,o,G)}else{try{a.grid.info_dialog(a.grid.errors.errcap,'<div class="coral-state-error">'+k.responseText+"</div>",a.grid.edit.bClose,{buttonalign:"right"})}catch(H){alert(k.responseText)}}if(z.restoreAfterError===true){a(D.element).grid("restoreRow",l,z.afterrestorefunc)}}},a.grid.ajaxOptions,D.options.ajaxRowOptions||{}))}}if(m){a(t).removeClass("new-row")}return m},restoreRow:function(b,l){var m=a.makeArray(arguments).slice(1),c={};if(a.type(m[0])==="object"){c=m[0]}else{if(a.isFunction(l)){c.afterrestorefunc=l}}c=a.extend(true,a.grid.inlineEdit,c);var h=this,i,d,g={};if(!h.grid){return}d=a(h.element).grid("getInd",b,true);if(h.options.editrow&&b==h.options.editrow){h.options.editrow=null;h.clearErrors(b)}if(d===false){return}for(var f=0;f<h.options.savedRow.length;f++){if(h.options.savedRow[f].id==b){i=f;break}}if(i>=0){if(a.isFunction(a.fn.datepicker)){try{a("input.hasDatepicker","#"+a.grid.coralID(d.id)).datepicker("hide")}catch(j){}}a.each(h.options.colModel,function(){if(this.editable===true&&this.name in h.options.savedRow[i]){g[this.name]=h.options.savedRow[i][this.name]}});a(h.element).grid("setRowData",b,g);a(d).attr("editable","0").unbind("keydown");h.options.savedRow.splice(i,1);if(a("#"+a.grid.coralID(b),"#"+a.grid.coralID(h.options.id)).hasClass("grid-new-row")){setTimeout(function(){a(h.element).grid("delRowData",b)},0)}}a(h).triggerHandler("gridInlineAfterRestoreRow",[b]);if(a.isFunction(c.afterrestorefunc)){c.afterrestorefunc.call(h,b)}if(h.options.rowEditButtons){h.rowEditButtons.hide()}},addRow:function(c){c=a.extend(true,{rowID:"new_row",initdata:{},position:"first",useDefValues:true,useFormatter:false,addRowParams:{extraparam:{}}},c||{});if(!this.grid){return}var e=this;if(c.useDefValues===true){a(e.options.colModel).each(function(){if(this.editoptions&&this.editoptions.defaultValue){var g=this.editoptions.defaultValue,f=a.isFunction(g)?g.call(e):g;
c.initdata[this.name]=f}})}a(e.element).grid("addRowData",c.rowID,c.initdata,c.position);a("#"+a.grid.coralID(c.rowID),"#"+a.grid.coralID(e.options.id)).addClass("grid-new-row");if(c.useFormatter){a("#"+a.grid.coralID(c.rowID)+" .coral-inline-edit","#"+a.grid.coralID(e.options.id)).click()}else{var b=e.options.prmNames,d=b.oper;c.addRowParams.extraparam[d]=b.addoper;a(e.element).grid("editRow",c.rowID,c.addRowParams);a(e.element).grid("setSelection",c.rowID)}},clearEdited:function(c){var b=a(this.getInd(c,true));b.removeClass("edited");b.children("td").removeClass("dirty-cell")},inlineNav:function(b,c){c=a.extend({edit:true,editicon:"coral-icon-pencil",add:true,addicon:"coral-icon-plus",save:true,saveicon:"coral-icon-disk",cancel:true,cancelicon:"coral-icon-cancel",addParams:{useFormatter:false,rowID:"new_row"},editParams:{},restoreAfterSelect:true},a.grid.nav,c||{});return this.each(function(){if(!this.grid){return}var k=this,e,h=a.grid.coralID(k.options.id);k.options._inlinenav=true;if(c.addParams.useFormatter===true){var d=k.options.colModel,g;for(g=0;g<d.length;g++){if(d[g].formatter&&d[g].formatter==="actions"){if(d[g].formatoptions){var j={keys:false,onEdit:null,onSuccess:null,afterSave:null,onError:null,afterRestore:null,extraparam:{},url:null},f=a.extend(j,d[g].formatoptions);c.addParams.addRowParams={keys:f.keys,oneditfunc:f.onEdit,successfunc:f.onSuccess,url:f.url,extraparam:f.extraparam,aftersavefunc:f.afterSavef,errorfunc:f.onError,afterrestorefunc:f.afterRestore}}break}}}if(c.add){a(k.element).grid("navButtonAdd",b,{caption:c.addtext,title:c.addtitle,buttonicon:c.addicon,id:k.options.id+"_iladd",onClickButton:function(){a(k.element).grid("addRow",c.addParams);if(!c.addParams.useFormatter){a("#"+h+"_ilsave").removeClass("coral-state-disabled");a("#"+h+"_ilcancel").removeClass("coral-state-disabled");a("#"+h+"_iladd").addClass("coral-state-disabled");a("#"+h+"_iledit").addClass("coral-state-disabled")}}})}if(c.edit){a(k.element).grid("navButtonAdd",b,{caption:c.edittext,title:c.edittitle,buttonicon:c.editicon,id:k.options.id+"_iledit",onClickButton:function(){var i=a(k.element).grid("getGridParam","selrow");
if(i){a(k.element).grid("editRow",i,c.editParams);a("#"+h+"_ilsave").removeClass("coral-state-disabled");a("#"+h+"_ilcancel").removeClass("coral-state-disabled");a("#"+h+"_iladd").addClass("coral-state-disabled");a("#"+h+"_iledit").addClass("coral-state-disabled")}else{a.grid.viewModal("#alertmod",{gbox:"#gbox_"+h,jqm:true});a("#jqg_alrt").focus()}}})}if(c.save){a(k.element).grid("navButtonAdd",b,{caption:c.savetext||"",title:c.savetitle||"Save row",buttonicon:c.saveicon,id:k.options.id+"_ilsave",onClickButton:function(){var l=k.options.savedRow[0].id;if(l){var i=k.options.prmNames,m=i.oper;if(!c.editParams.extraparam){c.editParams.extraparam={}}if(a("#"+a.grid.coralID(l),"#"+h).hasClass("grid-new-row")){c.editParams.extraparam[m]=i.addoper}else{c.editParams.extraparam[m]=i.editoper}if(a(k.element).grid("saveRow",l,c.editParams)){a(k.element).grid("showAddEditButtons")}}else{a.grid.viewModal("#alertmod",{gbox:"#gbox_"+h,jqm:true});a("#jqg_alrt").focus()}}});a("#"+h+"_ilsave").addClass("coral-state-disabled")}if(c.cancel){a(k.element).grid("navButtonAdd",b,{caption:c.canceltext||"",title:c.canceltitle||"Cancel row editing",buttonicon:c.cancelicon,id:k.options.id+"_ilcancel",onClickButton:function(){var i=k.options.savedRow[0].id;if(i){a(k.element).grid("restoreRow",i,c.editParams);a(k.element).grid("showAddEditButtons")}else{a.grid.viewModal("#alertmod",{gbox:"#gbox_"+h,jqm:true});a("#jqg_alrt").focus()}}});a("#"+h+"_ilcancel").addClass("coral-state-disabled")}if(c.restoreAfterSelect===true){if(a.isFunction(k.options.beforeSelectRow)){e=k.options.beforeSelectRow}else{e=false}k.options.beforeSelectRow=function(m,l){var i=true;if(k.options.savedRow.length>0&&k.options._inlinenav===true&&(m!==k.options.selrow&&k.options.selrow!==null)){if(k.options.selrow==c.addParams.rowID){a(k.element).grid("delRowData",k.options.selrow)}else{a(k.element).grid("restoreRow",k.options.selrow,c.editParams)}a(k.element).grid("showAddEditButtons")}if(e){i=e.call(k,m,l)}return i}}})},showAddEditButtons:function(){return this.each(function(){if(!this.grid){return
}var b=a.grid.coralID(this.options.id);a("#"+b+"_ilsave").addClass("coral-state-disabled");a("#"+b+"_ilcancel").addClass("coral-state-disabled");a("#"+b+"_iladd").removeClass("coral-state-disabled");a("#"+b+"_iledit").removeClass("coral-state-disabled")})}})})(jQuery);