(function(a){a.component("coral.combotree",a.coral.combo,{version:"4.0.3",castProperties:["data","rootNode","buttons"],options:{valueField:"id",textField:"name",panelRenderOnShow:false,mode:"local",method:"post",url:null,data:null,buttons:[],postMode:"value",multiple:false,simpleDataEnable:false,simpleDataIdKey:"id",simpleDataPIdKey:"pId",simpleDataRootPId:null,rootNode:false,radioType:"level",showRootNode:true,allowPushParent:true,traversal:false,cascadeCheck:false,formatter:function(c){var b=a(this).combotree("option","textField");return c[b]},loader:function(g,f,d){var e=this,b=a(this),c=b.combotree("option","url");if(!c){return false}a.ajax({type:b.combotree("option","method"),url:c,data:g,dataType:"json",success:function(h){f(h)},error:function(h){d.apply(this,arguments)}})},beforeClick:null,beforeLoad:a.noop,onLoad:a.noop,onError:a.noop,onSelect:a.noop,unSelect:a.noop,onExpand:null,onClick:null},tree:function(){return a("#"+a(this.element).attr("id")+"_tree")},_filterLocalTree:function(b){var d=this,c=a("#"+a(this.element).attr("id")+"_tree");c.tree("filterNodesByParam",b)},_create:function(){var b=this,c=null;this.element.addClass("coral-form-element-combotree coral-validation-combotree coral-combobox-f ctrl-form-element");c=function(){};this.options.onShowPanel=c;this._super();if(this.options.popupDialog){this.uiCombo.popupInputbox=this.uiCombo.popupInputbox.textbox({componentCls:"coral-combo-popup-input",icons:[{icon:"cui-icon-search2",click:function(f,d){b._filterLocalTree({name:d.value})}}],onKeyUp:function(f,d){b._filterLocalTree({name:d.value});f.stopPropagation()}});this.uiCombo.popupDialog.dialog({autoOpen:false,title:"下拉树",height:"auto",width:"auto",modal:true,resizable:false,buttons:{"确定":function(g){var d=a.data(b.uiCombo.popupInputbox,"value"),f=a.data(b.uiCombo.popupInputbox,"text");if(d){b.setValues(d,true,f)}a(this).dialog("close")},"关闭":function(d){a(this).dialog("close")}}})}this.uiCombo.panel.unbind().bind("mouseover",function(d){a(d.target).closest(".coral-combobox-item").addClass("coral-combobox-item-hover")
}).bind("mouseout",function(d){a(d.target).closest(".coral-combobox-item").removeClass("coral-combobox-item-hover")}).bind("mousedown",function(d){b.cancelBlur=true;b._delay(function(){delete b.cancelBlur});return false})},_getSetting:function(){var c=this;var b={simpleDataEnable:this.options.simpleDataEnable,simpleDataIdKey:this.options.simpleDataIdKey,simpleDataPIdKey:this.options.simpleDataPIdKey,simpleDataRootPId:this.options.simpleDataRootPId,checkable:this.options.multiple,radioType:this.options.radioType,showRootNode:this.options.showRootNode,rootNode:this.options.rootNode,chkboxType:this.options.cascadeCheck?{Y:"",N:""}:{Y:"ps",N:"ps"},beforeClick:function(f,e){if(!c.options.allowPushParent&&e.isParent){return false}var d=a.coral.toFunction(c.options.beforeClick);if(!c.options.multiple){if(a.isFunction(d)){return d(f,e)}return true}else{return false}},onClick:function(m,k,j,h){var f=[];var d=[];f.push(j.name);d.push(j.id);if(c.options.traversal){var g=j.getParentNode();while(!!g){f.push(g.name);g=g.getParentNode()}}if(c.options.popupDialog){a.data(c.uiCombo.popupInputbox,"value",d.reverse());a.data(c.uiCombo.popupInputbox,"text",f.reverse())}else{c.setValues(d.reverse(),true,f.reverse())}if(!c.options.multiple&&!j.isParent||!c.options.multiple&&c.options.allowPushParent){c.hidePanel()}c._trigger("onNodeClick",m,{treeId:k,node:j,clickFlag:h});return false},beforeCheck:function(f,e){var d=c._trigger("beforeNodeCheck",null,{treeId:f,node:e});if(!d){return false}},onCheck:function(n,m,k){var h=[];var g=[];var f=a("#"+m).tree("getCheckedNodes",true);for(var j=0,d=f.length;j<d;j++){if(c.options.cascadeCheck||!f[j].getCheckStatus().half){if(!c.options.allowPushParent&&f[j].isParent){continue}h.push(f[j].name);g.push(f[j].id)}}if(c.options.popupDialog){a.data(c.uiCombo.popupInputbox,"value",g);a.data(c.uiCombo.popupInputbox,"text",h)}else{c.setValues(g,true,h)}c._trigger("onNodeCheck",n,{treeId:m,node:k})},onLoad:function(m,k,p,g){var q=[],n=[],j,f=[],o=false,h=a("#"+k).tree("getNodes"),d=a("#"+k).tree("transformToArray",h);
if(c.options.clearOnLoad){o=c._clearValues(d)}if(c.options.multiple){f=a("#"+k).tree("getCheckedNodes",true)}else{f=a("#"+k).tree("getSelectedNodes")}for(j=0,l=f.length;j<l;j++){if(c.options.cascadeCheck||!f[j].getCheckStatus().half){if(!c.options.allowPushParent&&f[j].isParent){continue}q.push(f[j].name);n.push(f[j].id)}}if(c.currentValues.length&&!o){n=c.currentValues}if(!c.isInit){c.isInit=true;c.originalValue=n.join(",")}c.dataLoaded=true;c.setValues(n);c.isLoaded=true;c._trigger("onLoad",m,{treeId:k,treeNode:p,msg:g})},onExpand:function(g,f,d){c._trigger("onExpand",g,[{treeId:f,node:d}])}};return b},setPopupInput:function(b){this.uiCombo.popupInputbox.textbox("setValue",b.join(this.options.separator))},_initData:function(){var b=a('<ul id="'+a(this.element).attr("id")+'_tree"></ul>');if(this.options.popupDialog){b.appendTo(this.uiCombo.popupDialog);this.uiCombo.popupDialogTree=b}else{b.appendTo(this.uiCombo.pContent)}this.uiCombo.panel.unbind().bind("mousedown",function(j){j.preventDefault()});var h=this._getSetting();if(typeof this.options.url=="string"&&this.options.url!==""){a.extend(h,{asyncEnable:true,asyncUrl:this.options.url,asyncAutoParam:"id,name"})}b.tree(h,this.options.data);var f=[];var e=[];var d=a("#"+a(this.element).attr("id")+"_tree").tree("getCheckedNodes",true);for(var g=0,c=d.length;g<c;g++){if((d[g].getCheckStatus()!=null)&&(this.options.cascadeCheck||!d[g].getCheckStatus().half)){f.push(d[g].name);e.push(d[g].id)}}if(e.length>0){this.setValues(e,false,f)}},_renderItems:function(b){},_scrollTo:function(e){var b=this.panel();var d=b.find('div.coral-combobox-item[value="'+e+'"]');if(d.length){if(d.position().top<=0){var c=b.scrollTop()+d.position().top;b.scrollTop(c)}else{if(d.position().top+d.outerHeight()>b.height()){var c=b.scrollTop()+d.position().top+d.outerHeight()-b.height();b.scrollTop(c)}}}},_request:function(b,j,f){var e=this,d={},g=[],c=this.options.loader,h=false;if(!b&&!e.options.url){b=[]}else{if(!b&&e.options.url){b=e.options.url
}}if(typeof(b)!=="string"){d=b;if(d.data){g=d.data}else{if(d.url){b=d.url;e.options.url=d.url;h=true}else{if(d instanceof Array){g=b}else{if(!d.url&&!d.data&&!e.options.url){g=[]}else{if(!d.url&&!d.data&&e.options.url){b=e.options.url;h=true}}}}}}else{e.options.url=b;h=true}if(h){j=j||{};if(this._trigger("beforeLoad",null,[j])==false){return}c.apply(this.element,[j,function(k){e.loadData(k,f);e._trigger(a.isFunction(d.onLoad)?d.onLoad:"onLoad",null,[k])},function(){e._trigger("onError",null,arguments)}])}else{e.loadData(g,f);e._trigger(a.isFunction(d.onLoad)?d.onLoad:"onLoad",null,[g])}},getTree:function(){return a("#"+a(this.element).attr("id")+"_tree")},loadData:function(e,c){var d=this.getTree();d.tree("reload",e);var b=d.tree("getNodes");a.each(b,function(f,g){d.tree("expandNode",g,true)});this.dataLoaded=true;this.setValues(this.currentValues)},getData:function(){return this.getTree().tree("getNodes")||[]},setComboValues:function(b,c){this.setValues(b,false,c)},_setCombotree:function(c,f){c=this.currentValues;var e=this.options;var g=[];var b=a(this.element).attr("id");a("#"+b+"_tree").tree("cancelSelectedNode");if(e.multiple){a("#"+b+"_tree").tree("checkAllNodes",false);for(i in c){var d=a("#"+b+"_tree").tree("getNodeByParam","id",c[i]);if(d){a("#"+b+"_tree").tree("checkNode",d,true,!e.cascadeCheck)}if(!f){var d=a("#"+b+"_tree").tree("getNodeByParam","id",c[i]);if(d){g.push(d.name)}else{g.push(c[i])}}}}else{for(i in c){var d=a("#"+b+"_tree").tree("getNodeByParam","id",c[i]);a("#"+b+"_tree").tree("selectNode",d);if(!f){var d=a("#"+b+"_tree").tree("getNodeByParam","id",c[i]);if(d){g.push(d.name)}else{g.push(c[i])}}}}if(!f){f=g}return f},setValues:function(b,g,f){this.currentValues=b;var d=this._setCombotree(b,f);var e=this.options,c=[];f=typeof f=="boolean"?f:false;if(!f){this._setText(d.join(e.separator))}this._super(b,g,f)},setValue:function(c,d,b){c=c.split(this.options.separator);this.setValues(c,false,b)},_getOnlyValues:function(){var f=this.getData(),d=this.options,c=[],b=0;
if(!this.currentValues||(!this.currentValues[0]&&this.currentValues.length===1)){return c}for(;b<this.currentValues.length;b++){var e=this.currentValues[b];if("value"===d.postMode){c.push(e)}}return c},_showItems:function(){var c=this.tree().tree("getNodes");var b=this.tree().tree("transformToArray",c);this.tree().tree("showNodes",b,{showParents:true})},_doQuery:function(d){if(d==""){return}var c=this.options,e=[],g=c.textField,u=c.valueField,s=this.options.filter;if(c.mode=="remote"){this._request(null,{q:d},true)}else{var f=this.tree().tree("getNodes");var m=this.tree().tree("transformToArray",f);this.tree().tree("hideNodes",m);for(var k=0;k<m.length;k++){var n=pinyinEngine.toPinyin(m[k][g],false,"");for(var h=0;h<d.length;h++){var b=s.apply(this.element,[d[h],m[k]]);if(b){var o=m[k][u];var p=m[k][g];if(p.indexOf(d[h])>-1||n.indexOf(d[h])>-1){e.push(m[k]);this.tree().tree("showNodes",e,{showParents:true});this.tree().tree("expandNode",e[0].getParentNode(),true,false,false)}}}}}},_checkMathch:function(s,t){var b=[],q=[],w=[],r=[],c=[],n,m,g,o,v=this.options,e=v.textField,u=v.valueField;if(t){this._showItems()}var d=false;var f={};if(v.multiple){this.tree().tree("checkAllNodes",false);for(n=0;n<s.length;n++){if(t){if(this.options.forceSelection&&a.trim(s[n])===""){continue}}var c=this.tree().tree("getNodesByParam",e,s[n],null);if(!c.length){f[n.toString()]=true}for(m=0;m<c.length;m++){if(v.cascadeCheck||!c[m].isParent){b.push(c[m][u]);q.push(c[m][e]);d=true;break}}if(!d&&!this.options.forceSelection){if((!f[n.toString()]&&!t)||t){b.push(s[n]);q.push(s[n])}}d=false}for(o=0;o<b.length;o++){var c=this.tree().tree("getNodesByParam",u,b[o],null);if(c.length){this.tree().tree("checkNode",c[0],true,!v.cascadeCheck)}}var c=this.tree().tree("getCheckedNodes",true);for(g=0,l=c.length;g<l;g++){if(v.cascadeCheck||!c[g].getCheckStatus().half){if(!v.allowPushParent&&c[g].isParent){continue}if(a.inArray(c[g][u],b)==-1){q.push(c[g][e]);b.push(c[g][u])}}}}else{var c=this.tree().tree("getNodesByParam",e,s[0],null);
var p=-1;for(n=0;n<c.length;n++){p=p===-1?n:p;d=true}if(d){b.push(c[p][u]);q.push(c[p][e])}if(!d&&!this.options.forceSelection){b.push(s[0]);q.push(s[0])}}return{valarr:b,textarr:q}},clear:function(){this._super();if(this.options.multiple){a("#"+a(this.element).attr("id")+"_tree").tree("checkAllNodes",false)}},_formatValue:function(g){var f;if(this.options.multiple){f=this.getTree().tree("getCheckedNodes",true)}else{f=this.getTree().tree("getSelectedNodes")}var e=this.options,c=e.valueField,b=e.textField,d=0,h=null;if("text"===e.postMode||"value-text"===e.postMode){for(d=0;d<f.length;d++){h=f[d];if(""!=g&&g==h[c]){if("text"===e.postMode){return h[b]}if("value-text"===e.postMode){return g+e.valueTextSeparator+h[b]}}}}return g},reload:function(b){this._request(b)},_destroy:function(){var b=this;this.element.removeClass("coral-validation-combotree");this.element.removeClass("coral-form-element-combotree");if(this.options.popupDialog){this.uiCombo.popupDialog.dialog("forceDestroy")}this._super()}})})(jQuery);