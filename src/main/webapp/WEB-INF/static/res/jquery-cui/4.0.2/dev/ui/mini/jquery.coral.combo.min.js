/*!
 * 组件库4.0：下拉框
 * 
 * 依赖JS文件：
 *    jquery.coral.core.js
 *    jquery.coral.component.js
 *    jquery.coral.panel.js
 *    jquery.validatehelper.js
 *    jquery.coral.control.js
 */
(function(a){a(document).unbind(".coral-combobox").bind("mousedown.coral-combobox mousewheel.coral-combobox",function(g){var f=a(g.target).closest(".coral-combo-panel").length;var h=a(g.target).closest(".coral-combo").length;var d=a(g.target).closest(".coral-button").length;if(f||(h&&!d)){return}b()});function b(c,d){a(".coral-combo-wrapper").not(c).hide();a(".coral-combo-iframePanel:visible").not(d).hide()}a.component("coral.combo",a.coral.inputbase,{castProperties:["triggers"],version:"4.0.2",options:{panelRenderOnShow:false,popupDialog:false,showStar:true,showDirection:"down",labelField:null,starBefore:false,isInited:false,id:null,name:null,showOnFocus:true,iframePanel:false,buttons:[],forceSelection:true,width:"auto",height:22,placeholder:"",cls:"",required:false,errMsg:null,errMsgPosition:"leftBottom",isLabel:false,panelWidth:null,panelHeight:"auto",panelComponentCls:"",position:{my:"left top",at:"left bottom",collision:"none"},maxPanelHeight:200,multiple:false,separator:",",valueTextSeparator:"-",postMode:"value",editable:false,readonly:false,readonlyInput:true,disabled:false,clearOnLoad:true,hasArrow:true,value:"",text:"",delay:200,zIndex:10000,enableHighlight:false,enablePinyin:false,showClose:false,enableFilter:false,enterFilter:true,query:null,filter:function(h,j){var e=a(this).attr("component-role"),f=a(this)[e]("option"),c=f.textField,d=f.valueField,i=(j[c]).toLowerCase(),g=(j[d]).toString().toLowerCase();h=h.toLowerCase();if(i.indexOf(h)>-1){return"text"}if(f.enablePinyin===true){if(pinyinEngine.toPinyin(i,false,"").indexOf(h)>-1){return true}}if(g.indexOf(h)>-1){return true}else{return false}},onKeyUp:null,onKeyDown:null,onEnter:null,onBlur:null,onClick:null,onValidError:null,onValidSuccess:null,onShowPanel:a.noop,onHidePanel:a.noop,onChange:a.noop,triggers:null,excluded:false},_addCacheItem:function(c){if(typeof c!=="object"){return
}if(typeof this.cache==="undefined"){this.cache={}}this.cache=a.extend({},this.cache,c)},_getCacheItem:function(c){if(typeof c!=="string"){return}if(this.cache&&this.cache[c]){return this.cache[c]}else{return null}},_removeCacheItem:function(c){if(this.cache&&this.cache[c]){delete this.cache[c]}},_create:function(){this._prepareInit();this._initCombo();this._setDefaultValue();this._initState();this._initData();this._bindEvent()},_prepareInit:function(){this.originalCss={display:this.element[0].style.display,width:this.element[0].style.width,minHeight:this.element[0].style.minHeight,maxHeight:this.element[0].style.maxHeight,height:this.element[0].style.height};this.panelRendered=false;this.dataLoaded=false;this.isInit=false;this.isLoaded=false;this.isInited=false;this.currentValues=[];this.cache={};if(this.options.enableSearch===true){this.options.readonlyInput=false}if(this.options.popupDialog||this.options.enableFilter){this.options.readonlyInput=true}this.element.hide();if(this.element.attr("id")){if(this.element.attr("id")!=this.options.id){this.options.id=this.element.attr("id")}}else{if(this.options.id){this.element.attr("id",this.options.id)}}if(!this.element.attr("id")){this.options.id=this.element.uniqueId().attr("id")}if(this.element.attr("name")&&this.options.name){if(this.element.attr("name")!=this.options.name){this.options.name=this.element.attr("name")}}else{if(!this.options.name&&this.element.attr("name")){this.options.name=this.element.attr("name")}}if(this.element.attr("value")&&this.options.value){if(this.element.attr("value")!=this.options.value){this.options.value=this.element.attr("value")}}else{if(!this.options.value&&this.element.attr("value")){this.options.value=this.element.attr("value")}}},_initCombo:function(){var e=null,d=null,g="",f="",c="";this.uiCombo={combo:null,panel:null};this.previousValue=null;this.uiCombo.combo=a("<span class='coral-combo coral-textbox'></span>").insertAfter(this.element);this.element.appendTo(this.uiCombo.combo);
if(this.options.hasArrow==true){if(this.options.showDirection=="down"){c="<span class='coral-combo-arrow coral-icon-arrow cui-icon-arrow-down3'></span>"}if(this.options.showDirection=="up"){c="<span class='coral-combo-arrow coral-icon-arrow cui-icon-arrow-up3'></span>"}}if(this.options.showClose&&!this.options.required){g="<span class='coral-input-clearIcon cui-icon-cross2'></span>"}this.elementBorder=a("<span class='coral-combo-border coral-textbox-border coral-corner-all'>"+g+c+"</span>").appendTo(this.uiCombo.combo);if(this.options.labelField){this.uiLabel=a('<label class="coral-label">'+this.options.labelField+"</label>");this.elementBorder.before(this.uiLabel);this.uiCombo.combo.addClass("coral-hasLabel")}this.uiCombo.textbox=a("<input type='text' autocomplete='off' class='coral-combo-text coral-combo-default coral-textbox-default'>").appendTo(this.elementBorder);if(this.options.name){this.element.removeAttr("name").attr("orgname",this.options.name);f=" name='"+this.options.name+"'"}d=a("<input type='hidden' "+f+" class='coral-combo-value'>").appendTo(this.uiCombo.combo);this.uiCombo.panel=a("<div class='coral-combo-panel "+this.options.panelComponentCls+"'></div>").appendTo("body");if(this.options.iframePanel){this.uiCombo.iframePanel=a("<iframe class='coral-combo-iframePanel' style='position:absolute;display:none;'></iframe>").appendTo("body")}this.uiCombo.pContent=a("<div class='coral-combo-content'></div>").appendTo(this.uiCombo.panel);if(this.options.enableFilter){a("<div class='coral-combo-filter'><span class='coral-combo-filter-border'><input type='text' class='coral-combo-filterbox'></span><span class='coral-combo-search cui-icon-search2'></span></div>").appendTo(this.uiCombo.panel)}var h="absolute";if(this.options.popupDialog){h="";this.uiCombo.popupDialog=a("<div class='coral-combo-popup-dialog'></div>").appendTo("body");this.uiCombo.popupInputbox=a("<input type='text' />").appendTo(this.uiCombo.popupDialog)}if(this.options.hasArrow==false){this.elementBorder.css({"padding-right":0});
this.uiCombo.textbox.css({"padding-right":0});this.uiClose().css({right:0})}this.uiCombo.panel.css({position:h}).addClass("coral-combo-wrapper "+this.options.cls+"-panel coral-front").hide();this.uiCombo.textbox.attr("placeholder",this.options.placeholder);this._showPlaceholder();if(this.options.buttons.length>0){this._createButtonPanel()}},_initState:function(){this.options.isLabel===true?this._setIsLabel(this.options.isLabel):this._setReadonly(this.options.readonly);if(!this.options.readonly){this.uiCombo.textbox.prop("readonly",this.options.readonlyInput)}this._setDisabled(this.options.disabled);this.resize()},_initData:a.noop,_setDefaultValue:function(){if(!this.options.value){this.originalValue="";return}else{this.setValue(this.options.value);this.originalValue=this.getValue()}},_showPlaceholder:function(d){if(a.support.placeholder||this.component().find(".coral-textbox-placeholder-label").length){return}d=d?d:this.options.placeholder;var c=a("<span class='coral-textbox-placeholder-label'>"+d+"</span>");a(this.uiCombo.textbox).after(c)},_hidePlaceholder:function(){if(a.support.placeholder){return}this.component().find(".coral-textbox-placeholder-label").remove()},_setIsLabel:function(c){var d=this;if(true===c){this.component().removeClass("coral-readonly");this.component().addClass("coral-isLabel");this.uiCombo.textbox.prop("readonly",true);if(this.options.emptyText&&""===this.getValue()){this.uiCombo.textbox.val("")}this.hidePanel();this.uiCombo.textbox.removeAttr("placeholder")}else{this.component().removeClass("coral-isLabel coral-readonly");this.uiCombo.textbox.prop("readonly",this.options.readonlyInput);this.options.readonly=false;this.uiCombo.textbox.attr("placeholder",this.options.placeholder)}this.options.isLabel=!!c},_setReadonly:function(c){if(c){this.element.prop("readonly",true);this.uiCombo.textbox.prop("readonly",true);this.uiCombo.combo.find(".coral-combo-value").prop("readonly",true)}else{a(this.element).prop("readonly",false);this.uiCombo.textbox.prop("readonly",false);
this.uiCombo.combo.find(".coral-combo-value").prop("readonly",false)}this.options.readonly=!!c;this.uiCombo.combo.removeClass("coral-isLabel");this.uiCombo.combo.toggleClass("coral-readonly",this.options.readonly)},_setDisabled:function(c){if(c){this.element.prop("disabled",true);this.uiCombo.combo.find(".coral-combo-value").prop("disabled",true);this.uiCombo.combo.find(".coral-combo-text").prop("disabled",true)}else{a(this.element).prop("disabled",false);this.uiCombo.combo.find(".coral-combo-value").prop("disabled",false);this.uiCombo.combo.find(".coral-combo-text").prop("disabled",false)}this.options.disabled=!!c;this.uiCombo.combo.toggleClass(this.componentFullName+"-disabled coral-state-disabled",this.options.disabled)},_selectPrev:a.noop,_selectNext:a.noop,_doEnter:a.noop,_doQuery:a.noop,_addHighlight:function(d,c){if(c===""||!d.length||!this.options.enableHighlight){return}d=a(d);var f="",g=c.replace(/[\s]+/g," ").split(" "),e;d.each(function(i,k){var h=a(k),l=a(k).parent(),j=a(k).html();if(j==c){return}if(h.hasClass(".coral-combobox-item-selected")){l.html(that._getTextFromHTML(j));return}if(!h.children("input").length){for(var m=0;m<g.length;m++){e=new RegExp(""+g[m]+"","gmi");j=j.replace(e,'<span class="coral-keyword-highlight">'+g[m]+"</span>")}h.html(j)}})},_getTextFromHTML:function(c){if(typeof c==="undefined"){return}c=c.replace(/<\/?[^>]*>/g,"");c=c.replace(/[ | ]*\n/g,"\n");c=c.replace(/&nbsp;/ig,"");return c},_clearValues:function(k){var f=this.options.valueField,d=this.currentValues,h=d.length,g,e,c=0;for(g=0;g<h;g++){for(e=0;e<k.length;e++){if(d[g]==k[e][f]){c+=1;break}}}if(c!=h){return true}else{return false}},_removeHighlight:function(c){if(!c.length||!this.options.enableHighlight){return}c=a(c);var d=this;c.each(function(e,g){var h=a(g).parent();var f=h.html();h.html(d._getTextFromHTML(f))})},focus:function(){var d=this;if(this.options.disabled||this.options.readonly||this.options.isLabel){return false}this.uiCombo.textbox.focus();if(!this.isLoaded){var c={focus:{param:null}};
this._addCacheItem(c);return true}return true},_bindEvent:function(){var g=this,f=this.options,i=this.uiCombo.combo,c=this.uiCombo.panel,h=this.uiCombo.iframePanel;if(this.options.disabled){this.element.addClass("coral-state-disabled")}this._off(g.component());var d,e;this._on({"mouseenter.coral-combo-border":function(j){if(g.component().hasClass("coral-isLabel")||g.component().hasClass("coral-readonly")){return}g.uiCombo.combo.addClass("coral-textbox-hover");this._updateTitle()},"mouseleave.coral-combo-border":function(j){if(g.component().hasClass("coral-isLabel")||g.component().hasClass("coral-readonly")){return}g.uiCombo.combo.removeClass("coral-textbox-hover")},"keydown.coral-combo-text":function(j){this._doKeyDown(j,false)},"keyup.coral-combo-text":function(j){if(this.options.readonly||this.options.isLabel){return}this._trigger("onKeyUp",j,{})},"blur.coral-combo-text":function(j){this._setHv(j,"blur")},"focusin.coral-combo-text":function(j){if(this.options.readonly||this.options.isLabel){return}this.component().addClass("coral-state-focus");if(!d){this._trigger("onFocus",j)}},"focusout.coral-combo-text":function(j){if(this.cancelBlur){delete this.cancelBlur;return}if(this.options.readonly||this.options.isLabel){return}this._delay(function(){if(d){d=false;return}this.component().removeClass("coral-state-focus");if(e){e=false;return}this.hidePanel();this._trigger("onBlur",j)},100)},"click.coral-combo-text":function(j){if(g.component().hasClass("coral-isLabel")||g.component().hasClass("coral-readonly")){if(this.options.hasArrow==true&&!this.options.readOnlyInput){return}}if(g.component().hasClass("coral-state-focus")){if(this.options.popupDialog&&this.options.showOnFocus===true){this.uiCombo.popupDialog.dialog("open")}else{if(c.is(":visible")){this.hidePanel()}else{this.showPanel()}}}if(this.options.enableFilter){e=true}g._trigger("onClick",j)},"mousedown.coral-combo-arrow":function(j){if(this.component().hasClass("coral-isLabel")||this.component().hasClass("coral-readonly")){return
}if(this.component().hasClass("coral-state-focus")){d=true}},"click.coral-combo-arrow":function(j){b(c,h);if(g.component().hasClass("coral-isLabel")||g.component().hasClass("coral-readonly")){return}if(g.component().hasClass("coral-state-focus")){d=true}if(this.options.enableFilter){e=true}this.focus();if(g.options.popupDialog){g.uiCombo.popupDialog.dialog("open")}else{if(c.is(":visible")){g.hidePanel()}else{g.showPanel()}}},"click.coral-input-clearIcon":function(j){if(this.component().hasClass("coral-state-focus")){d=true}this.clear();if(this.options.placeholder){this._showPlaceholder()}},combogridonshowpanel:function(j){g._removeGridHighlights();g._scrollTo(g.getValue());g.grid().grid("refresh")}});this._on(this.uiCombo.panel.find(".coral-combo-filterbox"),{keydown:function(j){this._doKeyDown(j,true)}});this._on(this.uiCombo.panel.find(".coral-combo-search"),{click:function(j){j.preventDefault();this._filter(j,true);return false}})},_updateTitle:function(){var c=a("<span style = 'visibility: hidden'>"+this.getText()+"</span>").appendTo("body");if(this.component().outerWidth()<c.width()){this.component().attr("title",this.getText())}c.remove()},_doKeyDown:function(h,d){var f=this.options,c=this.panel();this.previousValue=a(h.target).val();if(f.readonly||f.isLabel){return}var g=a.coral.keyCode;switch(h.keyCode){case g.TAB:break;case g.ENTER:h.preventDefault();this._doEnter(h);this._setHv(h);this._trigger("onEnter",h,{});break;case g.ESCAPE:this.hidePanel();break;case g.UP:h.preventDefault();if(f.readonly===false){if(!c.is(":visible")){this.showPanel()}else{if(f.onSelectPrev){this._trigger("onSelectPrev",h)}else{this._selectPrev(h)}}}break;case g.DOWN:h.preventDefault();if(f.readonly===false){if(!c.is(":visible")){this.showPanel()}else{if(f.onSelectNext){this._trigger("onSelectNext",h)}else{this._selectNext(h)}}}break;default:this._filter(h,d);break}this._hidePlaceholder();this._trigger("onKeyDown",h)},_setHv:function(i,f){var j=a(i.target),d=[],c=j.val();if(this.options.multiple){c=c.split(this.options.separator)
}else{c=[c]}this._showItems();var h=true;if(f=="blur"){h=c.toString()!=this.previousValue}if(h){var g=this.options.textField,l=this.options.valueField;var k=this._checkMathch(c,true);if(!k){j.val("");this.setValues([""])}else{this.setValues(k.valarr)}}},_searchFilter:a.noop,_filter:function(h,d){var g=this,f=this.options,c=this.panel();if(g.timer){clearTimeout(g.timer)}if(!c.is(":visible")){g.showPanel()}g.timer=setTimeout(function(){var k=a(h.target).val();if(d){k=c.find(".coral-combo-filterbox").val()}if(g.options.multiple){k=k.split(f.separator)}else{k=[k]}if(k==g.previousValue){return}if(f.query){f.query.call(g.element,k)}else{g._doQuery(k)}var j=g.options.textField,i=g.options.valueField;if(!d){var e=g._checkMathch(k,false);g.setValues(e.valarr,false,true)}g.resizeIframePanel()},f.delay);return false},_formatValue:function(c){return c},_setOption:function(c,d){if(c==="id"||c==="name"){return}if(c==="readonly"){this._setReadonly(d)}if(c==="disabled"){this._setDisabled(d)}this._super(c,d);if(c==="isLabel"){this._setIsLabel(d);return}},_destroy:function(){this.panel().remove();if(this.options.iframePanel){this.uiCombo.iframePanel.remove()}this.component().replaceWith(this.element);if(this.options.name){this.element.removeAttr("orgname").attr("name",this.options.name)}this.element.show();this.element.css(this.originalCss)},component:function(){return this.uiCombo.combo},panel:function(){return this.uiCombo.panel},uiArrow:function(){return this.uiCombo.combo.find("span.coral-combo-arrow")},uiClose:function(){return this.uiCombo.combo.find("span.coral-input-clearIcon")},uiBorder:function(){return this.component().find("span.coral-combo-border")},resize:function(g){var h=this.options,i=this.uiCombo.combo,e=this.uiCombo.panel,d=this.elementBorder;if(g){h.width=g}if(h.width=="auto"||h.width=="item"){return}if(isNaN(h.width)){var f=this.element.parent(":first"),c=null;g=this.element.outerWidth();if(f&&f.get(0).tagName!=="BODY"){c=f.outerWidth();if(c<g){g=c}}h.width=g}i.outerWidth(h.width)
},resizeIframePanel:function(){var e=this.options,c,g=this.uiCombo.combo,d=this.uiCombo.panel,f=this.uiCombo.iframePanel||a();c=d.height();f.css("height",c)},_initPanel:function(){var f=this.options,g=this.uiCombo.combo,d=this.elementBorder,c=this.uiCombo.panel,e=f.panelHeight;if(!this.panelRendered){this._renderItems(this.options.data);this.uiCombo.pContent.html(this.lazyPanelHtml);this.panelRendered=true;this.lazyPanelHtml=""}c.css("width",(f.panelWidth?f.panelWidth:d.outerWidth()));c.css("height",e);if(isNaN(e)){this.uiCombo.pContent.css({"max-height":f.maxPanelHeight+"px"});this.uiCombo.popupDialogTree&&this.uiCombo.popupDialogTree.css({"max-height":f.maxPanelHeight+"px"})}if(this.options.enableFilter&&!isNaN(e)){this.uiCombo.pContent.height(f.panelHeight-30)}else{if(e=="auto"){this.uiCombo.pContent.height("")}else{this.uiCombo.pContent.height(e-2)}}if(this.options.iframePanel){this.uiCombo.iframePanel.css("height",c.outerHeight())}},showPanel:function(){var h=this,c=this.options,e=this.uiCombo.combo,g=this.elementBorder,k=this.options.showDirection,d=this.uiCombo.panel,f=this.uiCombo.iframePanel||a();if(d.is(":hidden")){var j=a(".coral-front:visible").map(function(){return +a(this).css("z-index")}).get(),i=Math.max.apply(null,j);if(i>=+d.css("z-index")){d.css("z-index",i+1);if(this.options.iframePanel){f.css("z-index",i)}}if(!this._PanelInited){this._initPanel()}this._PanelInited=true;d.show(0,function(){h._trigger("onShowPanel",null,{});h.resizeIframePanel();f.show();(function l(){if(d.is(":visible")){d.css({left:a.coral.getLeft(d,g),top:a.coral.getTop(d,g,k),width:(c.panelWidth?c.panelWidth:g.outerWidth())});if(h.options.iframePanel){f.css({left:a.coral.getLeft(f,g),top:a.coral.getTop(f,e,k),width:(c.panelWidth?c.panelWidth:g.outerWidth())})}setTimeout(l,200)}})();h.uiCombo.panel.find(".coral-combo-filterbox").focus()})}if(c.enableFilter){this.setValues(this.getValues())}},hidePanel:function(){this.uiCombo.panel.hide();if(this.uiCombo.iframePanel){this.uiCombo.iframePanel.hide()
}this._trigger("onHidePanel",null,{})},disable:function(){this._setDisabled(true)},enable:function(){this._setDisabled(false)},show:function(){this._super()},hide:function(){this._super();this.hidePanel()},hideErrors:function(){a.validate.hideErrors(this.uiBorder());this.component().removeClass("coral-combo-error")},clear:function(){this.setValues([],true,false)},getOldText:function(){return this.oldText},reset:function(){this.setValue(this.originalValue)},getText:function(){return this.uiCombo.combo.find("input.coral-combo-text").val()},_setText:function(c){var d=this.uiCombo.combo.find("input.coral-combo-text");d.val(c);this.previousValue=c},setText:function(c){this._setText(c)},getValues:function(){var c=[];this.uiCombo.combo.find("input.coral-combo-value").each(function(){c.push(a(this).val())});return c},setValues:function(o,m,k){var p=this.getValues(),l=null,g=0,c=[],e=[];o=o||[];this.oldValues=p;var h=[],d="",n="";this.uiCombo.combo.find("input.coral-combo-value").remove();for(g=0;g<o.length;g++){d="";n="";if(this.options.name){d=" name='"+this.options.name+"' "}h.push("<input type='hidden' "+d+" value='"+this._formatValue(o[g])+"' class='coral-combo-value' />")}this.uiCombo.combo.append(h.join(""));for(g=0;g<p.length;g++){c[g]=p[g]}for(g=0;g<o.length;g++){for(var f=0;f<c.length;f++){if(o[g]==c[f]){e.push(o[g]);c.splice(f,1);break}}}if(o.length){if(this.options.placeholder){this._hidePlaceholder()}}if((e.length!=o.length||o.length!=p.length)&&(!k)&&m){if(this.options.multiple){this._trigger("onChange",null,{value:o,newValue:o,newText:this.getText(),text:this.getText(),oldValue:p,oldText:this.getOldText()})}else{this._trigger("onChange",null,{value:o[0],newValue:o[0],newText:this.getText(),text:this.getText(),oldValue:p[0],oldText:this.getOldText()})}}},getValue:function(){return this.getValues().join(this.options.separator)},setValue:function(e,c,d){e=e.split(this.options.separator);this.setValues(e)},getSelectedItems:function(){var f=this.getValues(),k=[];var d=this.options.data;
for(var e=0;e<f.length;e++){for(var c=0;c<d.length;c++){var h=d[c];if(f[e]==h.id){for(var g in h){k.push(g+"="+h[g]+"\n")}}}}return k},refresh:function(){this.destroy();this.component().remove();this._create()}})})(jQuery);