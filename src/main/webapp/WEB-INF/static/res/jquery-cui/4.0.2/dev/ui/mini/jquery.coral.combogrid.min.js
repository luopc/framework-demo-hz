(function(a){a.component("coral.combogrid",a.coral.combo,{version:"4.0.3",castProperties:["colNames","colModel","data","buttonOptions","gridOptions","buttons"],options:{colNames:[],colModel:[],valueField:"id",textField:"name",panelRenderOnShow:false,multiple:false,selarrrow:[],buttons:[],url:null,panelWidth:500,panelHeight:220,sortable:false,data:[],onSelectRow:null,onSelectAll:null,onSortableColums:null,onLoad:a.noop,onComplete:null,pager:false,buttonOptions:null,gridOptions:{}},grid:function(){return a("#combo_grid_"+a(this.element).attr("id"))},button:function(){if(null!==this.options.buttonOptions){return this.$button}},_destroy:function(){this.element.removeClass("coral-validation-combogrid");this.element.removeClass("coral-form-element-combogrid");this.grid().grid("destroy");this._super()},_showItems:function(){var g=[],i=[],h=[],d=[];var c=this.options.textField,e=this.options.valueField,f={};var b=this.grid();f.filters="{}";b.grid("option","localonce",true);a.extend(b.grid("option","postData"),f);b.grid("reload",{page:1})},_doQuery:function(c){var b=this.options,k=this.grid();var d=b.textField;var h=k.grid("option","colModel"),f=[],m=[];for(var g in h){var l=h[g];if("cb"==l.name||"rn"==l.name){continue}for(var e=0;e<c.length;e++){}}for(var e=0;e<c.length;e++){m.push('{"field":"'+d+'","op":"cn","data":"'+c[e]+'"}')}f.filters='{"groupOp":"OR","rules":['+m.join(",")+"]}";k.grid("option","localonce",true);a.extend(k.grid("option","postData"),f);k.grid("reload",{page:1})},_checkMathch:function(p,o){var f=[],n=[],g=[],l=[];var q=this.options.textField,b=this.options.valueField,u={},c=0,t,s;var h=this.grid();if(o){this._showItems()}var v=this.grid().grid("option","data");var m=false;var d={};if(this.options.multiple){for(t=0;t<p.length;t++){for(s=0;s<v.length;s++){if(v[s][q]!=p[t]&&v[s][b]!=p[t]){d[t.toString()]=true}if(v[s][q]==p[t]){n.push(v[s][b]);g.push(v[s][q]);m=true;break}}if(!m&&!this.options.forceSelection){if((!d[t.toString()]&&!o)||o){n.push(p[t]);g.push(p[t])
}}m=false}var e=this._getOnlyValues();var r=this._getOnlyTexts();for(t=0;t<p.length;t++){for(s=0;s<r.length;s++){if(r[s]==p[t]&&a.inArray(r[s],g)===-1){n.push(e[s]);g.push(r[s])}}}}else{var k=-1;for(t=0;t<v.length;t++){if(v[t][q]==p[0]){k=k===-1?t:k;m=true}}if(m){n.push(v[k][b]);g.push(v[k][q])}if(!m&&!this.options.forceSelection){if((!d["0"]&&!o)||o){n.push(p[0]);g.push(p[0])}}}return{valarr:n,textarr:g}},reload:function(c){this.cache.isReload=true;var b=this.grid(),f=this,e={},h=false,g=[],d=b.grid("option","orgdatatype");if(!c&&!this.options.url){c=[]}else{if(!c&&this.options.url){c=this.options.url}}if(typeof(c)!=="string"){e=c;if(e.data){g=e.data}else{if(e.url){c=e.url;h=true}else{if(c instanceof Array){g=c}else{if(!e.url&&!e.data&&!this.options.url){g=[]}else{if(!e.url&&!e.data&&this.options.url){c=this.options.url;h=true}}}}}}else{h=true}if(a.isFunction(e.onLoad)){this.cache.onLoad=e.onLoad}if(e.postData){}if(h){b.grid("option","url",c);this.options.url=c;if(d!="json"){b.grid("option","datatype","json");b.grid("reload");b.grid("option","datatype",d)}}else{if(d!="local"){b.grid("option","orgdatatype","local");b.grid("clearGridData");b.grid("addRowData",this.options.valueField,g);this.cache.isReload=false;this._trigger(e.onLoad,null,[g]);b.grid("option","orgdatatype",d)}b.grid("option","data",g)}b.grid("reload")},_removeGridHighlights:function(){this._removeHighlight(this.grid().find(".coral-grid-btable tr td > span.coral-keyword-highlight"))},_addGridHighlights:function(){this._addHighlight(this.grid().find(".coral-grid-btable .jqgrow").children("td"),this.uiCombo.textbox.val())},_updateGridData:function(f){var c=this;var e=this.grid().grid("getRowData",f.rowId);var d=this._getTextFromHTML(e[this.options.valueField]);var g=this._getTextFromHTML(e[this.options.textField]);var b=a.inArray(d,this.gridValueArr);if(!this.options.multiple){this.gridValueArr=[d];this.gridTextArr=[g];this.gridRowIdArr=[f.rowId];return}if(!f.status){if(b!=-1){this.gridValueArr.splice(b,1);
this.gridTextArr.splice(b,1);this.gridRowIdArr.splice(b,1)}}else{if(b==-1){this.gridValueArr.push(d);this.gridTextArr.push(g);this.gridRowIdArr.push(f.rowId)}}},_create:function(){var b=this,d=null,c;this.element.addClass("coral-form-element-combogrid coral-validation-combogrid");this._super();this.panelRendered=true;if(null!==this.options.buttonOptions){this.$button=this._getButtonEl();this.component().append(this.$button).addClass("coral-combogrid-hasButton");this.$button.button(this.options.buttonOptions)}this.uiCombo.panel.unbind().bind("mousedown",function(g){b.cancelBlur=true;b._delay(function(){delete b.cancelBlur});var f=a(g.target).closest(".coral-grid-pager").length;if(f==1){return true}else{return false}})},_initCombo:function(){this._super();var b=a();if(this.options.pager){grid=a('<div id="combo_grid_'+a(this.element).attr("id")+'"><div class="combo_grid_'+a(this.element).attr("id")+'"></div></div>').appendTo(this.uiCombo.pContent)}else{grid=a('<div id="combo_grid_'+a(this.element).attr("id")+'"></div>').appendTo(this.uiCombo.pContent)}this.gridValueArr=[];this.gridTextArr=[];this.gridRowIdArr=[];goptions={fitStyle:"fill",sortable:this.options.sortable,colModel:this.options.colModel,colNames:this.options.colNames,multiselect:this.options.multiple,width:"auto"};goptions=a.extend({},goptions,this.options.gridOptions);if(null!=this.options.url){goptions.url=this.options.url;goptions.datatype="json"}else{goptions.data=this.options.data;goptions.datatype="local"}this._on(grid,{gridonselectrow:function(f,d){var c=this._getOnlyValues();if(this.options.multiple){if(a.inArray(d.rowId,c)==-1){c.push(d.rowId)}else{c.splice(a.inArray(d.rowId,c),1)}}else{c=[d.rowId]}this.setValues(c,true,false);if(!this.options.multiple&&f.originalEvent&&f.originalEvent.type=="click"){this.hidePanel()}},gridonselectall:function(f,d){var c=d.status?d.aRowIds.concat():[];this.setValues(c,true,false)},gridonload:function(l,j){var d=this,k=false,h=j.data;if(d.options.clearOnLoad){k=d._clearValues(h)
}this._addGridHighlights();this.isLoaded=true;var f=this.grid().grid("option","selarrrow").concat();for(var c=0;c<f.length;c++){this.grid().grid("setSelection",f[c],false)}var g=this._getOnlyValues();a.each(g,function(m,e){d.grid().grid("setSelection",e,false,null)});if(k==true){this.currentValues=[]}this.setValues(this.currentValues);if(this.cache.isReload){this.cache.isReload=false;this._trigger(this.cache.onLoad||"onLoad",null,[j]);delete this.cache.onLoad}}});grid.grid(goptions);grid.grid("refresh")},_getButtonEl:function(){return a("<button type='button'></button>").addClass("coral-combogrid-button")},_getRowDataByColName:function(g){var e=this,d=this.options,b=this.grid(),c=b.grid("option","data"),f=[];if(typeof g==="string"){g=[g]}a.each(c,function(j,m){var h={};for(var k in g){var l=g[k];h[l]=m[l]}f.push(h)});return f},_getTextArrByValueArr:function(j){var g=this,b=this.options,l=this.options.valueField,d=this.options.textField,c=this._getRowDataByColName([l,d]),k=[];for(var e in j){var h=j[e],f=false;a.each(c,function(i,m){if(h==m[l]){k.push(m[d]);f=true}});if(!f){k.push(j[e])}}return k},setValues:function(j,e,k){var l=this.grid();var c=l.grid("option","selarrrow").concat();for(var d=0;d<c.length;d++){l.grid("setSelection",c[d],false)}if(!this.isLoaded){var f={setValues:{values:j,text:k,triggerOnChange:e}};this._addCacheItem(f)}var b=this.options;var g=[];g=this._getTextArrByValueArr(j);k=typeof k=="boolean"?k:false;if(!k){this._setText(g.join(b.separator))}this.currentValues=j;this.currentTexts=g;var h=j.concat();h.sort();for(var d=0;d<h.length;d++){if(h[d]!==h[d+1]&&d!=h.length||d==h.length){l.grid("setSelection",h[d],false)}}this._super(j,e,false)},_getOnlyValues:function(){var f=this.getData(),b=this.options,c=[],g=0;if(!this.currentValues||(!this.currentValues[0]&&this.currentValues.length===1)){return c}for(;g<this.currentValues.length;g++){var h=this.currentValues[g],e=0,k=b.valueField,d=b.textField,l=null;if("value-text"===b.postMode){c.push(h.split(b.valueTextSeparator)[0])
}if("value"===b.postMode){c.push(h)}if("text"===b.postMode){for(;f&&e<f.length;e++){l=f[e];if(l[d]==h){c.push(l[k]);break}}}}return c},_getOnlyTexts:function(){return this.currentTexts||[]},getData:function(){return this.grid().grid("option","data")||[]},_selectPrev:function(){var e=this,d=null,b=0,f=e.grid().grid("getDataIDs");selarrrow=e.grid().grid("option","selarrrow").concat();valueFirst=e.getValues()[0];e.selectedRow=e.selectedRow||valueFirst;if(e.options.multiple){if(e.selectedRow){for(var c=f.length;c>=0;c--){if(e.selectedRow==f[c]){b=(c==0?(f.length-1):(c-1));e.selectedRow=f[b];break}}if(a.inArray(e.selectedRow,selarrrow)==-1){e.grid().grid("setSelection",e.selectedRow)}}else{e.selectedRow=f.length;e.grid().grid("setSelection",f.length)}e._scrollTo(e.selectedRow)}else{d=e.grid().grid("option","selrow");if(d){b=e.grid().grid("getInd",d);if(b>=0){e.grid().grid("setSelection",f[b-2])}}else{e.grid().grid("setSelection",f.length)}}e._scrollTo(d)},_selectNext:function(){var e=this,d=null,b=0,f=e.grid().grid("getDataIDs");selarrrow=e.grid().grid("option","selarrrow").concat();valueFirst=e.getValues()[0];e.selectedRow=e.selectedRow||valueFirst;if(e.options.multiple){if(e.selectedRow){for(var c=0;c<f.length;c++){if(e.selectedRow==f[c]){b=(c==f.length-1?0:(c+1));e.selectedRow=f[b];break}}if(a.inArray(e.selectedRow,selarrrow)==-1){e.grid().grid("setSelection",e.selectedRow)}}else{e.selectedRow=f[0];e.grid().grid("setSelection",f[0])}e._scrollTo(e.selectedRow)}else{d=e.grid().grid("option","selrow");if(d){b=e.grid().grid("getInd",d);if(b<f.length){e.grid().grid("setSelection",f[b])}}else{e.grid().grid("setSelection",f[0])}e._scrollTo(d)}},_doEnter:function(){if(!this.uiCombo.panel.is(":visible")){return}if(this.options.multiple){this.grid().grid("setSelection",this.selectedRow)}else{this.hidePanel()}},_scrollTo:function(e){var b=this.panel();var d=b.find('.coral-row-ltr[id="'+e+'"]');if(d.length){if(d.position().top<=0){var c=b.find(".coral-grid-rows-view").scrollTop()+d.position().top-d.outerHeight();
b.find(".coral-grid-rows-view").scrollTop(c)}else{if(d.position().top+d.outerHeight()>b.find(".coral-grid-rows-view").height()){var c=b.find(".coral-grid-rows-view").scrollTop()+d.position().top+d.outerHeight()-b.find(".coral-grid-rows-view").height();b.find(".coral-grid-rows-view").scrollTop(c)}}}}})})(jQuery);