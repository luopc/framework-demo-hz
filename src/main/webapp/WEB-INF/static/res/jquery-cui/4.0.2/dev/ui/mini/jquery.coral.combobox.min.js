(function(a){var b=0;a.component("coral.combobox",a.coral.combo,{version:"4.0.3",castProperties:["data","buttons"],options:{cls:"",valueField:"value",textField:"text",panelRenderOnShow:false,mode:"local",method:"post",url:null,data:[],buttons:[],width:"auto",showText:true,emptyText:null,postMode:"value",formatter:function(d){var c=a(this).combobox("option","textField");return d[c]},loader:function(h,g,e){var f=this,c=a(this),d=c.combobox("option","url");if(!d){return false}a.ajax({type:c.combobox("option","method"),url:d,data:h,dataType:"json",success:function(i){g(i)},error:function(){e.apply(this,arguments)}});return false},beforeLoad:a.noop,onLoad:a.noop,onError:a.noop,onShowPanel:a.noop,beforeSelect:a.noop,onSelect:a.noop,unSelect:a.noop},_create:function(){var c=this,f=null;var e=new Date();this.data=this.data||[];b++;c.options.itemIdPrefix="combobox_i"+b;this.element.addClass("coral-form-element-combobox coral-validation-combobox ctrl-form-element");var d=a.coral.toFunction(this.options.onShowPanel);f=function(g){d.apply(c.element,[g]);c._scrollTo(c.getValue())};this.options.onShowPanel=f;this._super();this._on(this.uiCombo.panel,{mouseover:function(g){a(g.target).closest(".coral-combobox-item").addClass("coral-combobox-item-hover")},mouseout:function(g){a(g.target).closest(".coral-combobox-item").removeClass("coral-combobox-item-hover")},mousedown:function(k){this.cancelBlur=true;this._delay(function(){delete this.cancelBlur});var h=a(k.target).closest(".coral-combobox-item"),j=h.attr("value");if(a(k.target).closest(".coral-combo-filterbox").length){return}if(!h.length||h.hasClass("coral-combobox-item-disabled")){return false}var g=this.getRowIndex(j);if(false===this._trigger("beforeSelect",null,[{item:this.options.data[g]},{data:this.options.data[g]}])){return false}if(this.options.multiple){this.oldText=this.uiCombo.textbox.val();if(""===j){this.clear();this.select(j);this.hidePanel()}else{if(this.options.emptyText){this.unselect("")}if(h.hasClass("coral-combobox-item-selected")){this.unselect(j);
h.removeClass("coral-combobox-item-selected")}else{this.select(j)}}}else{this.oldText=this.uiCombo.textbox.val();this.select(j);this.hidePanel()}return false}});if(this.options.isLabel&&this.options.emptyText&&""===this.getValue()){this.uiCombo.textbox.val("")}},_initData:function(){if(this.options.url){return this._request(this.options.url)}if(this.options.data.length){return this.loadData(this.options.data)}return this.loadData(this._transformData())},_renderItems:function(w){var n=this.options,l=this.panel(),h=this,e={},q=[],m=[],t,c="",f=a.coral.toFunction(this.options.formatter),j=a.coral.toFunction(this.options.itemattr);for(t=0;t<w.length;t++){var g=w[t],k=g[n.valueField],o=g[n.textField],u=!!g.hidden==true?"hidden":"",d=o;if(f){d=f.call(this.element,w[t])}if(a.isFunction(j)){var p=j.apply(this.element[0],[{item:w[t]}]);if(!a.isEmptyObject(p)){if(p.hasOwnProperty("style")){style+=p.style;delete p.style}if(p.hasOwnProperty("class")){u+=" "+p["class"];delete p["class"]}try{delete p.role}catch(r){}for(attrName in p){if(p.hasOwnProperty(attrName)){c+=" "+attrName+"="+p[attrName]}}}m.push("<div class='coral-combobox-item "+u+c+" ' id='"+this.options.itemIdPrefix+"_"+t+"' value='"+k+"'>"+d+"</div>")}else{m.push("<div class='coral-combobox-item "+u+" ' id='"+this.options.itemIdPrefix+"_"+t+"' value='"+k+"'>"+d+"</div>")}if(g.selected&&a.inArray(k,q)===-1){q.push(this.getModeValue(k,o))}}this.lazyPanelHtml=m.join("");return q},loadData:function(g,h,m){var c=this.options,d=this.panel(),i=this,e=m||"onLoad",o=a.coral.toFunction(this.options.formatter),j={},f=[],k=false,l=null;if(!(g instanceof Array)){g=[]}this.data=(g||[]);if(c.clearOnLoad){k=i._clearValues(this.data)}this.uiCombo.pContent.empty();if(this.options.emptyText){if(!(g.length>0&&""===g[0][this.options.valueField])){j[this.options.valueField]="";j[this.options.textField]=this.options.emptyText;g.unshift(j)}}var n=[];if(!this.panelRenderOnShow){f=this._renderItems(this.data);this.uiCombo.pContent.html(this.lazyPanelHtml);
this.panelRendered=true}if(this.currentValues.length&&!k){f=this.currentValues}if(!this.isInit){this.isInit=true;this.originalValue=f.join(",")}this.dataLoaded=true;if(c.multiple){this.setValues(f,false,h)}else{f=f.length?[f[0]]:[];this.setValues(f,false,h)}this._trigger(e,null,[g])},localFilter:function(h){var g=this.getData(),f=this.panel().find(".coral-combobox-item");for(var d=0;d<g.length;d++){a(f[d]).hide();if(h.apply(this.element,[g[d]])){var c=g[d][this.options.valueField];var e=g[d][this.options.textField];a(f[d]).show()}}},_scrollTo:function(f){var c=this.panel().find(".coral-combo-content"),d;var e=this.getEl(f);if(e.length){if(e.position().top<=0){d=c.scrollTop()+e.position().top;c.scrollTop(d)}else{if(e.position().top+e.outerHeight()>c.height()){d=c.scrollTop()+e.position().top+e.outerHeight()-c.height();c.scrollTop(d)}}}},_transformData:function(){var c=this.options;var d=[];a(">option",this.element).each(function(){var e={};e[c.valueField]=a(this).attr("value")!==undefined?a(this).attr("value"):a(this).html();e[c.textField]=a(this).html();e.selected=a(this).attr("selected");d.push(e)});return d},_showItems:function(){this.uiCombo.panel.find(".coral-combobox-item").show()},_doQuery:function(f){var d=this.options,o=this.options.filter;if(d.mode=="remote"){this._request(null,{q:f},true)}else{var e=this.panel();var h=this.getData(),p=e.find(".coral-combobox-item");p.hide();this._removeHighlight(this.uiCombo.pContent.find("span.coral-keyword-highlight"));this.uiCombo.pContent.find(".coral-combobox-item-selected").removeClass("coral-combobox-item-selected");this.uiCombo.pContent.find(".coral-item-focus").removeClass("coral-item-focus");for(var k=0;k<h.length;k++){var l=pinyinEngine.toPinyin(h[k][d.textField],false,"");for(var g=0;g<f.length;g++){var c=o.apply(this.element,[f[g],h[k]]);if(c){var m=h[k][d.valueField].toString();var n=h[k][d.textField];if(n.indexOf(f[g])>-1||m.indexOf(f[g])>-1||l.indexOf(f[g])>-1){a(p[k]).show();if(n==f[g]){a(p[k]).addClass("coral-combobox-item-selected");
this._removeHighlight(a(p[k]).find("span.coral-keyword-highlight"))}else{if(c=="text"){this._addHighlight(a(p[k]),f[g])}}}}}}}},_checkMathch:function(r,s){var c=[],q=[];var d=this.options,f=d.textField,t=d.valueField;var p=0;if(s){this._showItems()}var e=false;var m=this.data,k="",g={},n=0,l,h;if(d.multiple){for(l=0;l<r.length;l++){for(h=0;h<m.length;h++){if(m[h][f]!=r[l]&&m[h][t]!=r[l]){g[l.toString()]=true}if(m[h][f]==r[l]){k=this.getModeValue(m[h][t],m[h][f]);c.push(k);e=true;break}}if(!e&&!d.forceSelection){if((!g[l.toString()]&&!s)||s){c.push(r[l]);q.push(r[l])}}e=false}}else{var o=-1;for(l=0;l<m.length;l++){if(m[l][f]==r[0]){o=o===-1?l:o;e=true}if(m[l][f]!=r[0]&&m[l][t]!=r[0]){g["0"]=true}}if(e){k=this.getModeValue(m[o][t],m[o][f]);c.push(k)}if(!e&&!d.forceSelection){if((!g["0"]&&!s)||s){c.push(r[0]);q.push(r[0])}}}return{valarr:c,textarr:q}},_request:function(e,f,h){var i=this,c={},g=[],d=this.options.loader,k=false;if(!e&&!i.options.url){e=[]}else{if(!e&&i.options.url){e=i.options.url}}if(typeof(e)!=="string"){c=e;if(c.data){g=c.data}else{if(c.url){e=c.url;i.options.url=c.url;k=true}else{if(c instanceof Array){g=e}else{if(!c.url&&!c.data&&!i.options.url){g=[]}else{if(!c.url&&!c.data&&i.options.url){e=i.options.url;k=true}}}}}}else{i.options.url=e;k=true}if(k){f=f||{};if(this._trigger("beforeLoad",null,[f])==false){return}d.apply(this.element,[f,function(m){var l=c.onLoad;i.loadData(m,h,l);i._loadedHandler()},function(){i._trigger("onError",null,arguments)}])}else{var j=c.onLoad;i.loadData(g,h,j)}},_loadedHandler:function(){var d=this;var c=this._getCacheItem("setValues");if(c){this.setValues(c.values,c.triggerOnChange,c.remainText);this._removeCacheItem("setValues")}var e=this._getCacheItem("focus");if(e){this._removeCacheItem("focus")}},_selectItems:function(d,i){var f=this.panel(),g=null,h=null,e=f.find(".coral-item-focus:visible"),c=":last";if(d){c=":first"}e.removeClass("coral-item-focus");if(e.length){h=e.attr("value")}else{e=g=f.find(".coral-combobox-item-selected:visible"+c);
if(g.length){h=g.attr("value")}}if(i=="prev"){if(e.prevAll(":visible").length===0){e=f.find(".coral-combobox-item:visible:last");e.addClass("coral-item-focus")}else{e.prevAll(":visible:eq(0)").addClass("coral-item-focus")}}else{if(e.nextAll(":visible").length===0){e=f.find(".coral-combobox-item:visible:first");e.addClass("coral-item-focus")}else{e.nextAll(":visible:eq(0)").addClass("coral-item-focus")}}return h},_selectPrev:function(){var c=this.panel(),f=this._selectItems(true,"prev"),e=c.find('.coral-combobox-item[value="'+f+'"]'),d=null,g=null;if(e.length){d=e.prevAll(":visible:eq(0)")}else{e=c.find(".coral-combobox-item:visible:last")}if(null!==d&&d.length===0){d=c.find(".coral-combobox-item:visible:last")}g=!!d?d.attr("value"):e.attr("value");this.select(g);this._scrollTo(g)},_selectNext:function(){var c=this.panel(),f=this._selectItems(true,"next"),e=c.find('.coral-combobox-item[value="'+f+'"]'),d=null,g=null;if(e.length){d=e.nextAll(":visible:eq(0)")}else{e=c.find(".coral-combobox-item:visible:first")}if(d&&d.length==0){d=c.find(".coral-combobox-item:visible:first")}g=d?d.attr("value"):e.attr("value");this.select(g);this._scrollTo(g)},_doEnter:function(k){var d=this.panel(),m=this.getValues(),n=d.find(".coral-item-focus:visible"),h,g=this.getData(),c=this.options,l=n.attr("value");if(l){var f="",j=0;for(h=0;h<g.length;h++){if(l==g[h][c.valueField]){j=h}}f=this.getModeValue(l,g[j][c.textField]);if(this.options.multiple){if(a.inArray(f,m)==-1){this.select(l)}else{this.unselect(l)}}else{this.hidePanel()}}},_formatValue:function(h){var g=this.getData(),f=this.options,d=f.valueField,c=f.textField,e=0,j=null;if("text"===f.postMode||"value-text"===f.postMode){for(e=0;e<g.length;e++){j=g[e];if(""!=h&&h==j[d]){if("text"===f.postMode){return j[c]}if("value-text"===f.postMode){return h+f.valueTextSeparator+j[c]}}}}return h},_destroy:function(){this.element.removeClass("coral-validation-combobox");this.element.removeClass("coral-form-element-combobox");this._super()},_getOnlyValues:function(){var g=this.getData(),c=this.options,d=[],h=0;
if(!this.currentValues||(!this.currentValues[0]&&this.currentValues.length===1)){return d}for(;h<this.currentValues.length;h++){var k=this.currentValues[h],f=0,l=c.valueField,e=c.textField,m=null;if("value-text"===c.postMode){k=k.split(c.valueTextSeparator)[0];d.push(k)}if("value"===c.postMode){d.push(k)}if("text"===c.postMode){for(;g&&f<g.length;f++){m=g[f];if(m[e]==k){d.push(m[l]);break}}}}return d},_getCurrentValues:function(){var f=this.getData(),e=this.options,d=[],c=0;if(!this.currentValues||(!this.currentValues[0]&&this.currentValues.length===1)){return d}return this.currentValues},getData:function(){return this.data||[]},setValues:function(c,q,h){var p=this.options,A=this.getData(),m=this.panel(),t=h,v=0,u=0,z=this.getValues()||[],l=[],n=[],w=null,s=null,o=null;if(typeof(t)=="object"){h=t.remainText;q=t.triggerOnChange}this.currentValues=c;if(!this.dataLoaded){return}m.find(".coral-combobox-item-selected").removeClass("coral-combobox-item-selected");for(v=0;v<c.length;v++){s=c[v];o=s;var g=this.getRowIndex(s);if(g>-1){o=A[g][p.textField];w=A[g][p.valueField];var f=this._getItemByIndex(g).addClass("coral-combobox-item-selected");if(p.emptyText&&""==s){this.uiCombo.textbox.attr("placeholder",p.emptyText);this._showPlaceholder(p.emptyText);o=""}else{this._hidePlaceholder()}n.push(o);l.push(s)}else{if(g<0&&!p.forceSelection){n.push(o);l.push(s)}}}if(!h){this._setText(n.join(p.separator))}var k=this._getMinus(l,c);if((k.length&&l.length)||!l.length){n=n.concat(k);if(!h){this._setText(n.join(p.separator))}l=c}if(p.width=="item"){var d=a("<div style = 'visibility:hidden;'><span>"+this.getText()+"</span></div>").appendTo("body"),e=this.component().find(".coral-textbox-default");var y=parseInt(e.css("padding-left"))+parseInt(e.css("padding-right")),x=this.uiArrow().outerWidth()+2*parseInt(this.uiArrow().css("right")),r=d.find("span").outerWidth()+y+x;this.resize(r);d.remove();p.width="item"}this._super(l,q,h)},_getMinus:function(d,c){var e=[];a.each(c,function(f,g){if(a.inArray(g,d)==-1){e.push(g)
}});return e},getEl:function(d){var c=this.getRowIndex(d);var e=c;return a("#"+this.options.itemIdPrefix+"_"+e)},_getItemByIndex:function(c){var d=c;return a("#"+this.options.itemIdPrefix+"_"+d)},getRowIndex:function(g){var e=this.options,f=this.getData(),c=e.postMode;for(var d=0;d<f.length;d++){if(c=="value"){if(f[d][e.valueField]==g){return d}}if(c=="text"){if(f[d][e.textField]==g){return d}}if(c=="value-text"){if(f[d][e.valueField]==g.split(e.valueTextSeparator)[0]){return d}}}return -1},clear:function(){var c=this.panel();this._super();c.find(".coral-combobox-item-selected").removeClass("coral-combobox-item-selected");c.find(".coral--item-focus").removeClass("coral--item-focus")},reload:function(c){this._request(c)},select:function(h){var f=this.options,g=this.getData(),e,c;h=a.trim(h);if(f.multiple){c=this.getValues()}else{c=[]}var d="",j=0;for(e=0;e<g.length;e++){if(h==g[e][f.valueField]){j=e}}d=this.getModeValue(h,g[j][f.textField]);for(e=0;e<c.length;e++){if(c[e]==d){return}}c.push(d);this.setValues(c,true,false);this._trigger("onSelect",null,[{item:g[j],value:h,text:g[j][f.textField]}])},getModeValue:function(d,e){var c;if(this.options.postMode=="value"){c=d}if(this.options.postMode=="text"){c=e}if(this.options.postMode=="value-text"){c=d+"-"+e}return c},unselect:function(g){var e=this.options,f=this.getData(),c=this.getValues(),d;var h=0;for(d=0;d<f.length;d++){if(g==f[d][e.valueField]){h=d}}if(this.options.postMode=="value"){g=g}if(this.options.postMode=="text"){g=f[h][e.textField]}if(this.options.postMode=="value-text"){g=g+"-"+f[h][e.textField]}for(d=0;d<c.length;d++){if(c[d]==g){c.splice(d,1);this.setValues(c,true,false);this._trigger("onSelect",null,[{item:f[h],value:g,text:f[h][e.textField]}]);break}}},showPanel:function(){this._removeHighlight(this.uiCombo.pContent.find("span.coral-keyword-highlight"));var c=0,d;this._super();if(!this.hideValueArr){return}for(;c<this.hideValueArr.length;c++){d=this.hideValueArr[c];this.uiCombo.pContent.find('.coral-combobox-item[value="'+d+'"]').hide()
}},addOption:function(h){var k=this,f=0,j=null,e=this.options.valueField,c=this.options.textField,d=h[e],g=h[c];if(!(e in h)||!(c in h)){if(a.message){a.message("JSON格式不正确!")}return false}for(f=0;f<this.data.length;f++){if((h[e]==this.data[f][e])||(h[c]==this.data[f][c])){if(a.message){a.message("当前选项已存在!")}return false}}j=a('<div class="coral-combobox-item"></div>');j.attr("value",d);if(this.options.formatter){j.html(this.options.formatter.call(this.element,h))}else{j.html(g)}if(this.data.length>0&&""==this.data[0][e]){this.data.splice(1,0,h);j.insertAfter(this.uiCombo.pContent.find(":first-child"))}else{this.data.unshift(h);j.prependTo(this.uiCombo.pContent)}return true},removeOption:function(e){var g=null,f=null,d=0,c=this.options.valueField,h=null;if(typeof e==="number"){if(e>this.data.length){return}g=this.data[d];h=e}if(typeof e==="string"){f=e}if(typeof e==="object"){if(!(c in e)){return}f=e[c]}if(f!==null){for(;d<this.data.length;d++){if(f==this.data[d][c]){g=this.data[d];h=d;break}}}if(h!==null){this.data.splice(h,1);this.uiCombo.pContent.find('.coral-combobox-item[value="'+f+'"]').remove()}},clearOptinons:function(){this.uiCombo.pContent.empty();this.clear()},showOption:function(c){var d;if(typeof c==="number"){d=this.uiCombo.pContent.find(".coral-combobox-item:eq("+c+")")}else{if(typeof c==="string"){d=this.uiCombo.pContent.find('.coral-combobox-item[value="'+c+'"]')}else{if(typeof c==="object"){if(!(this.options.valueField in c)){return}d=this.uiCombo.pContent.find('.coral-combobox-item[value="'+c[this.options.valueField]+'"]')}else{this.uiCombo.pContent.find(".coral-combobox-item").removeClass("hidden");this.hideValueArr=null}}}if(d&&d.length>0){d.removeClass("hidden");if(this.hideValueArr){this.hideValueArr.splice(a.inArray(d.attr("value"),this.hideValueArr),1)}}},hideOption:function(c){if(!this.hideValueArr){this.hideValueArr=[]}var d;if(typeof c==="number"){d=this.uiCombo.pContent.find(".coral-combobox-item:eq("+c+")")}else{if(typeof c==="string"){d=this.uiCombo.pContent.find('.coral-combobox-item[value="'+c+'"]')
}else{if(!(this.options.valueField in c)){return}d=this.uiCombo.pContent.find('.coral-combobox-item[value="'+c[this.options.valueField]+'"]')}}if(d&&d.length>0){d.addClass("hidden");this.hideValueArr.push(d.attr("value"))}}})})(jQuery);