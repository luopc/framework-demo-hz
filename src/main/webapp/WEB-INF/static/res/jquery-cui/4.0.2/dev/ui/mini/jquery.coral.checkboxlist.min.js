/*!
 * 组件库4.0：复选框组
 * 
 * 依赖JS文件：
 *    jquery.coral.core.js
 *    jquery.coral.component.js
 *    jquery.validatehelper.js
 */
(function(a){a.component("coral.checkboxlist",a.coral.formelement,{version:"4.0.1",castProperties:["data","triggers"],options:{id:null,name:null,valueField:"value",textField:"text",required:false,showStar:true,maxLabelWidth:"auto",labelField:null,starBefore:false,column:null,disabled:false,readonly:false,value:"",data:null,url:null,termSplit:";",itemSplit:":",errMsg:null,errMsgPosition:"leftBottom",repeatLayout:"table",itemWidth:"auto",onValidError:null,onKeyDown:null,onValidSuccess:null,triggers:null,excluded:false,onChange:a.noop},_create:function(){var f=this,c=null,b=null,g=null,e=this.options;if(!this.element.jquery){this.element=a(this.element)}this.element.addClass("coral-form-element-checkboxlist  ctrl-init ctrl-form-element ctrl-init-checkboxlist coral-validation-checkboxlist");typeof f.element.attr("id")=="undefined"&&!!f.options.id&&f.element.attr("id",f.options.id);f.options.id=f.element.uniqueId().attr("id");var d=f.element.attr("name");typeof d!="undefined"?(f.options.name=d):(f.element.attr("name",f.options.name));this.uiBoxlist=a('<span class="coral-checkboxlist"></span>');this.uiInput=a('<input type="hidden">');if(this.options.name){this.uiInput.attr("name",this.options.name)}if(this.options.value){this.uiInput.val(this.options.value)}this._initData();this.uiInput.appendTo(this.uiBoxlist);if(e.labelField){this.uiLabel=a('<label class="coral-label">'+e.labelField+"</label>");this.uiBoxlist.prepend(this.uiLabel);this.uiBoxlist.addClass("coral-hasLabel")}this.uiBoxlist.insertAfter(this.element);this.element.hide();this._bindEvent()},reload:function(b){},_initData:function(){var c=this,b=this.options;if(this.options.url){if(this.xhr){this.xhr.abort()}this.xhr=a.ajax(this._ajaxSettings());this.xhr.success(function(d){c._loadData(d)}).complete(function(e,d){if(e===c.xhr){c.xhr=null}}).error(function(){a.alert("Json Format Error!")
})}else{if(this.options.data){this._loadData(this.options.data)}}},_ajaxSettings:function(){var c=this.options,b=this;return{type:"get",url:c.url,data:{},async:false,dataType:"json"}},_loadData:function(h){var c=null,g=[],j,d=0,e=null,b=null,f=null;if(typeof h==="string"){c=h.split(this.options.termSplit);h=[];for(;d<c.length;d++){b=c[d];f=b.split(this.options.itemSplit);e={};e[this.options.valueField]=f[0];e[this.options.textField]=f[1];h.push(e)}}this.data=h;for(d;d<h.length;d++){j=h[d];if(j.checked){g.push(j[this.options.valueField])}}if(this.options.value){g=this.options.value.split(",")}if(!this.isInit){this.isInit=true;this.originalValue=g.join(",")}this._renderChkItem();this.setValue(g)},_renderChkItem:function(){if(this.options.repeatLayout=="table"){if(this.options.column==null){this.options.column=3}this._renderTableItem();this.uiTable.appendTo(this.uiBoxlist)}else{if(this.options.repeatLayout=="flow"){if(this.options.column==null){this.options.column=this.data.length}this._renderBorderItem();this.uiBorder.appendTo(this.uiBoxlist)}}},reset:function(){this.setValue(this.originalValue)},_renderBorderItem:function(){var e=this,d=this.options,c=this.options.column,f=this.data;e.uiBorder=a('<span class="coral-checkboxlist-border"></span>');for(var b in f){if(b>(c-1)&&b%(c)==0){a("<br/>").appendTo(e.uiBorder)}e._renderItem(f[b]).css("width",d.itemWidth).appendTo(e.uiBorder)}},_renderTableItem:function(){this.uiTable=a("<table></table>");var e=0,d=0,h=this.data,c=h.length||0,f=this.options.column,g=0,k=null,b=null;if(!h||h.length<1){return}g=Math.ceil(c/f);for(;e<g;e++){k=a("<tr></tr>");for(d=0;d<f;d++){b=a("<td></td>");if((e*f+d)<c){this._renderItem(h[(e*f+d)]).appendTo(b)}b.appendTo(k)}k.appendTo(this.uiTable)}},_renderItem:function(e){var c=e.hidden==true?"hidden":"";var f=a("<span class='coral-checkbox "+c+"'></span>"),d=a("<span class='coral-checkbox-label'></span>"),h=a("<span class='coral-checkbox-icon'></span>"),b=this.options.maxLabelWidth,j=a(),g=e[this.options.valueField],i=e[this.options.textField];
if(b=="auto"){j=a('<span class="coral-checkbox-text"></span>')}else{j=a("<span class='coral-checkbox-text'  title='"+i+"' style='max-width:"+b+"px;'></span>")}f.attr("data-value",g);d.append(h).append(j);d.appendTo(f);h.addClass("cui-icon-checkbox-unchecked");j.append(i);return f},_bindEvent:function(){var b=this;if(this.options.disabled){this._setDisabled(this.options.disabled)}this.uiBoxlist.find(".coral-checkbox").each(function(){a(this).bind("mouseenter"+b.eventNamespace,function(){if(a(this).hasClass("coral-state-disabled")){return}a(this).addClass("coral-checkbox-hover")}).bind("mouseleave"+b.eventNamespace,function(){if(a(this).hasClass("coral-state-disabled")){return}a(this).removeClass("coral-checkbox-hover")}).bind("click"+b.eventNamespace,function(e){if(b.options.disabled){return}var f=a(this),c=f.find(".coral-checkbox-icon");if(f.hasClass("coral-state-disabled")){e.stopPropagation();return}if(c.hasClass("coral-checkboxlist-item-highlight")){c.removeClass("cui-icon-checkbox-checked coral-checkboxlist-item-highlight").addClass("cui-icon-checkbox-unchecked")}else{c.removeClass("cui-icon-checkbox-unchecked").addClass("coral-checkboxlist-item-highlight cui-icon-checkbox-checked")}var d=b.getValue();b._changeValue();b._trigger("onChange",null,{value:b.uiInput.val(),oldValue:d,checked:c.hasClass("coral-checkboxlist-item-highlight")});e.stopPropagation()}).bind("keydown"+this.eventNamespace,function(c){b._trigger("onKeyDown",c,{})})});this.uiBoxlist.find(".coral-checkbox-label").each(function(){a(this).bind("click"+b.eventNamespace,function(c){if(b.options.readonly){return false}})})},_changeValue:function(){var c=this,b=[];this.uiBoxlist.find(".coral-checkbox").each(function(){if(a(this).find(".coral-checkbox-icon").hasClass("coral-checkboxlist-item-highlight")){b.push(a(this).attr("data-value"))}});this.uiInput.val(b.toString())},_setDisabled:function(b){b=!!b;this.uiBoxlist.find(".coral-checkbox").each(function(){a(this).toggleClass("coral-state-disabled",b)});
this.options.disabled=b},_setReadonly:function(b){b=!!b;this.uiBoxlist.find(".coral-checkbox").each(function(){a(this).toggleClass("coral-readonly",b)});this.options.readonly=b},_setOption:function(c,d){if(c==="id"||c==="name"){return}if(c==="readonly"){this._setReadonly(d)}if(c==="disabled"){this._setDisabled(d);return}if(c==="maxLabelWidth"){var f=d;if(d!="auto"){f=f+"px";var g=this.component().find(".coral-checkbox-text");for(var b=0;b<g.length;b++){var e=a(g[b]).html();a(g[b]).attr("title",e)}}else{f="";this.component().find(".coral-checkbox-text").attr("title","")}this.component().find(".coral-checkbox-text").css("max-width",f)}this._super(c,d)},_destroy:function(){this.component().remove();if(this.options.name){this.element.removeAttr("orgname").attr("name",this.options.name)}this.element.removeClass("coral-form-element-checkboxlist");this.element.removeClass("coral-validation-checkboxlist");this.element.show()},focus:function(){},component:function(){return this.uiBoxlist},disable:function(){this._setOption("disabled",true);this._setDisabled(true)},readonly:function(){this._setReadonly("readonly",true)},enable:function(){this._setOption("disabled",false);this._setDisabled(false)},disableItem:function(b){this.uiBoxlist.find('.coral-checkbox[data-value="'+b+'"]').toggleClass("coral-state-disabled",true)},enableItem:function(c){this.options.disabled=false;var b=this.uiBoxlist.find('.coral-checkbox[data-value="'+c+'"]').toggleClass("coral-state-disabled",false)},show:function(){this.component().show()},hide:function(){this.component().hide()},getValue:function(){return this.uiInput.val()},setValue:function(f,e){var b=this.getValue()||[];this.uiBoxlist.find(".coral-checkboxlist-item-highlight").each(function(){a(this).removeClass("cui-icon-checkbox-checked coral-checkboxlist-item-highlight").addClass("cui-icon-checkbox-unchecked")});var c=0,d=a.isArray(f)?f:((!f||typeof f!=="string"||""===a.trim(f))?[]:f.split(","));for(;c<d.length;c++){this.uiBoxlist.find('.coral-checkbox[data-value="'+d[c]+'"]').find(".coral-checkbox-icon").removeClass("cui-icon-checkbox-unchecked").addClass("cui-icon-checkbox-checked coral-checkboxlist-item-highlight")
}this.uiInput.val(d.toString())},invertCheck:function(c){var b=[];this.uiBoxlist.find(".coral-checkboxlist-item-highlight").each(function(){a(this).removeClass("cui-icon-checkbox-checked coral-checkboxlist-item-highlight").addClass("coral-checkbox-temp")});this.uiBoxlist.find(".cui-icon-checkbox-unchecked").each(function(){a(this).removeClass("cui-icon-checkbox-unchecked").addClass("cui-icon-checkbox-checked coral-checkboxlist-item-highlight")});this.uiBoxlist.find(".coral-checkbox-temp").each(function(){a(this).removeClass("coral-checkbox-temp").addClass("cui-icon-checkbox-unchecked")});this.uiBoxlist.find(".coral-checkbox").each(function(){if(a(this).find(".coral-checkbox-icon").hasClass("coral-checkboxlist-item-highlight")){b.push(a(this).attr("data-value"))}});this.setValue(b,c)},checkAll:function(){var c=[],b=0,e=null,d=this.data;for(;b<d.length;b++){e=d[b];c.push(e[this.options.valueField])}this.setValue(c)},getText:function(c){var d=0,e=this.data,f=null,b=[];if(!c){c=this.getValue().split(",")}else{if(typeof c){c=c.split(",")}}for(;d<e.length;d++){f=e[d][this.options.valueField];if(a.inArray(f,c)>-1){b.push(e[d][this.options.textField])}}return b.toString()}})})(jQuery);